<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>AWS Chaliceを使ってサーバレスアプリケーションを開発しよう | クラウドCoEの何でも屋</title><meta name=keywords content="AWS,AWS Chalice,AWS Lambda,AWS CloudFormation,AWS CodePipeline"><meta name=description content="はじめに みなさん、こんにちは。今回は「AWS Chalice」を活用したサーバレスアプリケーション開発についてのお話です。AWS Summit Online Japan 2021 の日立製作所の講演で軽く触れたこともあり、どこかで紹介したいと思っておりました。
さて、AWS Chalice は多くの方にとってあまり馴染みのないツールだと思いますが、実際に使ってみるととても手軽に Amazon API Gateway と AWS Lambda を使用するサーバレスアプリケーションを作成してデプロイすることができます。もちろん、どんなツールにも得手不得手はあるので「すべてのプロジェクトで AWS Chalice の活用が最適か？」と言われればもちろん「No！」なのですが、ちょっと試しに動く Web API をサッと手軽に作りたい、といったケースにはとても良いソリューションだと思います。
今回は AWS CloudShell 上に開発環境を作るところからはじめて、簡素なサンプルを用いた一連の開発の流れ、テスト自動化を組み込んだシンプルな CI/CD パイプラインの構築まで紹介していきたいと思います。これから実際に動くサーバレスアプリケーションを手軽に作りたいと思われている方は参考にしてみてはいかがでしょうか。
改めて AWS Chalice とは AWS Chalice とは、Amazon AWS Gateway や AWS Lambda を用いたサーバレスアプリケーションを、お手軽に開発できるようにする Python 製のサーバレスアプリケーションフレームワークです。具体的には、Web API をシンプルで直感的なコードで実装できるようにする機能や、作成したコードからアプリケーションの作成やデプロイを実行するコマンドラインインタフェース(CLI)といった開発者にやさしい機能を提供してくれます。
普段から Python に触れている方であれば似たような機能として Flask や Bottle をイメージされるかと思いますが、これらにサーバレス環境へデプロイする機能が追加で付与されたものが AWS Chalice、とイメージしていただくと良いのかなと思います。
https://github.com/aws/chalice
ではさっそく AWS Chalice を使ってみよう 「はじめに」で既に述べたとおり、今回は AWS CloudShell 上に開発環境を作るところからはじめて、簡素なサンプルを用いた一連の開発の流れ、テスト自動化を組み込んだシンプルな CI/CD パイプラインの構築まで紹介していきたいと思います。
まずは開発環境の構築から 今回は AWS CloudShell 上に開発環境を作っていきたいと思います。 それではまず AWS Chalice をインストールする事前準備として Python の仮想環境を作成していきましょう。"><meta name=author content><link rel=canonical href=https://chacco38.github.io/posts/2021/10/aws-chalice/><link crossorigin=anonymous href=/assets/css/stylesheet.min.317d4c109e98a8137e18d0fd1222603a2a157f4e40f59a79576eb3861cc09531.css integrity="sha256-MX1MEJ6YqBN+GND9EiJgOioVf05A9Zp5V26zhhzAlTE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://chacco38.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://chacco38.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://chacco38.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://chacco38.github.io/apple-touch-icon.png><link rel=mask-icon href=https://chacco38.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="AWS Chaliceを使ってサーバレスアプリケーションを開発しよう"><meta property="og:description" content="はじめに みなさん、こんにちは。今回は「AWS Chalice」を活用したサーバレスアプリケーション開発についてのお話です。AWS Summit Online Japan 2021 の日立製作所の講演で軽く触れたこともあり、どこかで紹介したいと思っておりました。
さて、AWS Chalice は多くの方にとってあまり馴染みのないツールだと思いますが、実際に使ってみるととても手軽に Amazon API Gateway と AWS Lambda を使用するサーバレスアプリケーションを作成してデプロイすることができます。もちろん、どんなツールにも得手不得手はあるので「すべてのプロジェクトで AWS Chalice の活用が最適か？」と言われればもちろん「No！」なのですが、ちょっと試しに動く Web API をサッと手軽に作りたい、といったケースにはとても良いソリューションだと思います。
今回は AWS CloudShell 上に開発環境を作るところからはじめて、簡素なサンプルを用いた一連の開発の流れ、テスト自動化を組み込んだシンプルな CI/CD パイプラインの構築まで紹介していきたいと思います。これから実際に動くサーバレスアプリケーションを手軽に作りたいと思われている方は参考にしてみてはいかがでしょうか。
改めて AWS Chalice とは AWS Chalice とは、Amazon AWS Gateway や AWS Lambda を用いたサーバレスアプリケーションを、お手軽に開発できるようにする Python 製のサーバレスアプリケーションフレームワークです。具体的には、Web API をシンプルで直感的なコードで実装できるようにする機能や、作成したコードからアプリケーションの作成やデプロイを実行するコマンドラインインタフェース(CLI)といった開発者にやさしい機能を提供してくれます。
普段から Python に触れている方であれば似たような機能として Flask や Bottle をイメージされるかと思いますが、これらにサーバレス環境へデプロイする機能が追加で付与されたものが AWS Chalice、とイメージしていただくと良いのかなと思います。
https://github.com/aws/chalice
ではさっそく AWS Chalice を使ってみよう 「はじめに」で既に述べたとおり、今回は AWS CloudShell 上に開発環境を作るところからはじめて、簡素なサンプルを用いた一連の開発の流れ、テスト自動化を組み込んだシンプルな CI/CD パイプラインの構築まで紹介していきたいと思います。
まずは開発環境の構築から 今回は AWS CloudShell 上に開発環境を作っていきたいと思います。 それではまず AWS Chalice をインストールする事前準備として Python の仮想環境を作成していきましょう。"><meta property="og:type" content="article"><meta property="og:url" content="https://chacco38.github.io/posts/2021/10/aws-chalice/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-18T00:00:00+00:00"><meta property="article:modified_time" content="2021-10-18T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS Chaliceを使ってサーバレスアプリケーションを開発しよう"><meta name=twitter:description content="はじめに みなさん、こんにちは。今回は「AWS Chalice」を活用したサーバレスアプリケーション開発についてのお話です。AWS Summit Online Japan 2021 の日立製作所の講演で軽く触れたこともあり、どこかで紹介したいと思っておりました。
さて、AWS Chalice は多くの方にとってあまり馴染みのないツールだと思いますが、実際に使ってみるととても手軽に Amazon API Gateway と AWS Lambda を使用するサーバレスアプリケーションを作成してデプロイすることができます。もちろん、どんなツールにも得手不得手はあるので「すべてのプロジェクトで AWS Chalice の活用が最適か？」と言われればもちろん「No！」なのですが、ちょっと試しに動く Web API をサッと手軽に作りたい、といったケースにはとても良いソリューションだと思います。
今回は AWS CloudShell 上に開発環境を作るところからはじめて、簡素なサンプルを用いた一連の開発の流れ、テスト自動化を組み込んだシンプルな CI/CD パイプラインの構築まで紹介していきたいと思います。これから実際に動くサーバレスアプリケーションを手軽に作りたいと思われている方は参考にしてみてはいかがでしょうか。
改めて AWS Chalice とは AWS Chalice とは、Amazon AWS Gateway や AWS Lambda を用いたサーバレスアプリケーションを、お手軽に開発できるようにする Python 製のサーバレスアプリケーションフレームワークです。具体的には、Web API をシンプルで直感的なコードで実装できるようにする機能や、作成したコードからアプリケーションの作成やデプロイを実行するコマンドラインインタフェース(CLI)といった開発者にやさしい機能を提供してくれます。
普段から Python に触れている方であれば似たような機能として Flask や Bottle をイメージされるかと思いますが、これらにサーバレス環境へデプロイする機能が追加で付与されたものが AWS Chalice、とイメージしていただくと良いのかなと思います。
https://github.com/aws/chalice
ではさっそく AWS Chalice を使ってみよう 「はじめに」で既に述べたとおり、今回は AWS CloudShell 上に開発環境を作るところからはじめて、簡素なサンプルを用いた一連の開発の流れ、テスト自動化を組み込んだシンプルな CI/CD パイプラインの構築まで紹介していきたいと思います。
まずは開発環境の構築から 今回は AWS CloudShell 上に開発環境を作っていきたいと思います。 それではまず AWS Chalice をインストールする事前準備として Python の仮想環境を作成していきましょう。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://chacco38.github.io/posts/"},{"@type":"ListItem","position":2,"name":"AWS Chaliceを使ってサーバレスアプリケーションを開発しよう","item":"https://chacco38.github.io/posts/2021/10/aws-chalice/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"AWS Chaliceを使ってサーバレスアプリケーションを開発しよう","name":"AWS Chaliceを使ってサーバレスアプリケーションを開発しよう","description":"はじめに みなさん、こんにちは。今回は「AWS Chalice」を活用したサーバレスアプリケーション開発についてのお話です。AWS Summit Online Japan 2021 の日立製作所の講演で軽く触れたこともあり、どこかで紹介したいと思っておりました。\nさて、AWS Chalice は多くの方にとってあまり馴染みのないツールだと思いますが、実際に使ってみるととても手軽に Amazon API Gateway と AWS Lambda を使用するサーバレスアプリケーションを作成してデプロイすることができます。もちろん、どんなツールにも得手不得手はあるので「すべてのプロジェクトで AWS Chalice の活用が最適か？」と言われればもちろん「No！」なのですが、ちょっと試しに動く Web API をサッと手軽に作りたい、といったケースにはとても良いソリューションだと思います。\n今回は AWS CloudShell 上に開発環境を作るところからはじめて、簡素なサンプルを用いた一連の開発の流れ、テスト自動化を組み込んだシンプルな CI/CD パイプラインの構築まで紹介していきたいと思います。これから実際に動くサーバレスアプリケーションを手軽に作りたいと思われている方は参考にしてみてはいかがでしょうか。\n改めて AWS Chalice とは AWS Chalice とは、Amazon AWS Gateway や AWS Lambda を用いたサーバレスアプリケーションを、お手軽に開発できるようにする Python 製のサーバレスアプリケーションフレームワークです。具体的には、Web API をシンプルで直感的なコードで実装できるようにする機能や、作成したコードからアプリケーションの作成やデプロイを実行するコマンドラインインタフェース(CLI)といった開発者にやさしい機能を提供してくれます。\n普段から Python に触れている方であれば似たような機能として Flask や Bottle をイメージされるかと思いますが、これらにサーバレス環境へデプロイする機能が追加で付与されたものが AWS Chalice、とイメージしていただくと良いのかなと思います。\nhttps://github.com/aws/chalice\nではさっそく AWS Chalice を使ってみよう 「はじめに」で既に述べたとおり、今回は AWS CloudShell 上に開発環境を作るところからはじめて、簡素なサンプルを用いた一連の開発の流れ、テスト自動化を組み込んだシンプルな CI/CD パイプラインの構築まで紹介していきたいと思います。\nまずは開発環境の構築から 今回は AWS CloudShell 上に開発環境を作っていきたいと思います。 それではまず AWS Chalice をインストールする事前準備として Python の仮想環境を作成していきましょう。","keywords":["AWS","AWS Chalice","AWS Lambda","AWS CloudFormation","AWS CodePipeline"],"articleBody":"はじめに みなさん、こんにちは。今回は「AWS Chalice」を活用したサーバレスアプリケーション開発についてのお話です。AWS Summit Online Japan 2021 の日立製作所の講演で軽く触れたこともあり、どこかで紹介したいと思っておりました。\nさて、AWS Chalice は多くの方にとってあまり馴染みのないツールだと思いますが、実際に使ってみるととても手軽に Amazon API Gateway と AWS Lambda を使用するサーバレスアプリケーションを作成してデプロイすることができます。もちろん、どんなツールにも得手不得手はあるので「すべてのプロジェクトで AWS Chalice の活用が最適か？」と言われればもちろん「No！」なのですが、ちょっと試しに動く Web API をサッと手軽に作りたい、といったケースにはとても良いソリューションだと思います。\n今回は AWS CloudShell 上に開発環境を作るところからはじめて、簡素なサンプルを用いた一連の開発の流れ、テスト自動化を組み込んだシンプルな CI/CD パイプラインの構築まで紹介していきたいと思います。これから実際に動くサーバレスアプリケーションを手軽に作りたいと思われている方は参考にしてみてはいかがでしょうか。\n改めて AWS Chalice とは AWS Chalice とは、Amazon AWS Gateway や AWS Lambda を用いたサーバレスアプリケーションを、お手軽に開発できるようにする Python 製のサーバレスアプリケーションフレームワークです。具体的には、Web API をシンプルで直感的なコードで実装できるようにする機能や、作成したコードからアプリケーションの作成やデプロイを実行するコマンドラインインタフェース(CLI)といった開発者にやさしい機能を提供してくれます。\n普段から Python に触れている方であれば似たような機能として Flask や Bottle をイメージされるかと思いますが、これらにサーバレス環境へデプロイする機能が追加で付与されたものが AWS Chalice、とイメージしていただくと良いのかなと思います。\nhttps://github.com/aws/chalice\nではさっそく AWS Chalice を使ってみよう 「はじめに」で既に述べたとおり、今回は AWS CloudShell 上に開発環境を作るところからはじめて、簡素なサンプルを用いた一連の開発の流れ、テスト自動化を組み込んだシンプルな CI/CD パイプラインの構築まで紹介していきたいと思います。\nまずは開発環境の構築から 今回は AWS CloudShell 上に開発環境を作っていきたいと思います。 それではまず AWS Chalice をインストールする事前準備として Python の仮想環境を作成していきましょう。\n$ sudo yum install -y python3 $ python3 --version Python 3.7.10 $ python3 -m venv venv37 $ . venv37/bin/activate 次に、AWS Chalice をインストールします。\n$ python3 -m pip install chalice $ chalice --version chalice 1.26.0, python 3.7.10, linux 4.14.243-185.433.amzn2.x86_64 最後に、AWS CLI の設定をして開発環境の構築は完了です。\n$ aws configure 簡単なアプリケーションを動かしてみよう ここでは AWS Chalice を使ったアプリケーションの作成からデプロイまでの流れを、次のような簡単なサンプルを用いて紹介していきたいと思います。\nStep1. 新規プロジェクトの作成 まずは chalice new-project コマンドを実行して新しいプロジェクトを作成します。出力例のようにプロジェクトを新しく作るとデフォルトでサンプルプログラムも生成されます。\n$ chalice new-project  $ cd  $ tree -a . ├── app.py # APIの実装を行うファイル ├── .chalice │ └── config.json # Chaliceの設定を行うファイル ├── .gitignore └── requirements.txt # 利用するライブラリの定義を行うファイル  1 directory, 4 file Step2. ソースコードの編集 今回はデフォルトで作られたソースコードにちょっとだけ手を加えました。修正後のファイルの中身は次の通りです。実際の例を見ていただけるとわかる通り、AWS Chalice を用いた実装は Python を普段使わないという方でも直感的でわかりやすい構文になっているのではないでしょうか。\nfrom chalice import Chalice  app = Chalice(app_name='') app.log.setLevel(logging.INFO)  @app.route('/hello') def hello():  app.log.debug(\"Invoking from function hello\")  return {'hello': 'world'}  @app.route('/hello', methods=['POST'], content_types=['application/json'], cors=True) def hello_post():  app.log.debug(\"Invoking from function hello_post\")  request = app.current_request  return {'result': request.json_body['payload']} chalice {  \"version\": \"2.0\",  \"app_name\": \"\",  \"stages\": {  \"dev\": {  \"api_gateway_stage\": \"api\"  }  } } Step3. ローカル環境で動作確認 AWS 上へデプロイする前にローカル環境で軽く動作をしたい場合は、chalice local コマンドを実行します。 実行例のように期待通りのレスポンスが返ってくるようであれば、いよいよ AWS 上へデプロイをしていきます。\n$ chalice local Serving on http://127.0.0.1:8000 $ curl http://127.0.0.1:8000/hello {\"hello\":\"world\"} $ curl -X POST -H \"Content-Type: application/json\" -d '{\"payload\":\"hello, world\"}' http://127.0.0.1:8000/hello {\"result\":\"hello, world\"} Step4. AWS 上へデプロイ AWS 上へアプリケーションのデプロイをする場合は、chalice deploy コマンドを実行します。実行例ではメッセージから新たに Lambda 関数、API Gateway と IAM ロールが作られていることがわかります。\n$ chalice deploy --stage dev Creating deployment package. Creating IAM role: -dev Creating lambda function: -dev Creating Rest API Resources deployed:  - Lambda ARN: arn:aws:lambda:ap-northeast-1::function:-dev  - Rest API URL: https://.execute-api.ap-northeast-1.amazonaws.com/api/ デプロイ完了後は期待するレスポンスが返ってくるか確認しましょう。\n$ curl https://.execute-api.ap-northeast-1.amazonaws.com/api/hello {\"hello\":\"world\"} $ curl -X POST -H \"Content-Type: application/json\" -d '{\"payload\":\"hello, world\"}' https://.execute-api.ap-northeast-1.amazonaws.com/api/hello {\"result\":\"hello, world\"} 以上、AWS Chalice を使ったアプリケーションの作成からデプロイまでの一連の流れでした。\nStepEX. デプロイしたアプリケーションの削除 不要になったアプリケーションは chalice delete コマンドを使って削除しておきましょう。\n$ chalice delete Deleting Rest API:  Deleting function: arn:aws:lambda:ap-northeast-1::function:-dev Deleting IAM role: -dev より実践的な開発を行うにあたって ユニットテストを自動化しましょう 近頃はユニットテストの自動化は一般的に行われているかと思います。AWS Chalice でも Python の一般的なテストツール Pytest を使ってユニットテストを実装することができます。例として、今回は次のサンプルに対するテストコードを実装してみます。\nfrom chalice import Chalice app = Chalice(app_name='') app.log.setLevel(logging.INFO) @app.route('/hello') def hello(): app.log.debug(\"Invoking from function hello\") return {'hello': 'world'} @app.route('/hello', methods=['POST'], content_types=['application/json'], cors=True) def hello_post(): app.log.debug(\"Invoking from function hello_post\") request = app.current_request return {'result': request.json_body['payload']} Step1. テストコードの実装 では、まず必要なファイルを用意していきます。中身は後で入れるとしてここでは空ファイルだけ作ります。\n$ touch test_requirements.txt # テストプログラムの依存ライブラリ定義 $ mkdir tests $ touch tests/__init__.py $ touch tests/conftest.py # テストプログラム間で共通の処理を実装 $ touch tests/test_app.py # テストプログラムを実装 次に各ファイルを編集していきます。今回は HTTP レスポンスのステータスコードとボディの中身を確認するだけの簡単なテストプログラムを用意しました。\npytest-chalice pytest-cov (EOF) import pytest from app import app as chalice_app @pytest.fixture def app(): return chalice_app from http import HTTPStatus import json def test_hello_get(client): response = client.get('/hello') assert response.status_code == HTTPStatus.OK assert response.json == {'hello': 'world'} def test_hello_post(client): headers = {'Content-type':'application/json'} payload = {'payload':'hello, world'} response = client.post('/hello', headers=headers, body=json.dumps(payload)) assert response.status_code == HTTPStatus.OK assert response.json == {'result': 'hello, world'} def test_hello_put(client): response = client.put('/hello') assert response.status_code == HTTPStatus.METHOD_NOT_ALLOWED assert response.json == {\"Code\":\"MethodNotAllowedError\",\"Message\":\"Unsupported method: PUT\"} Step2. ユニットテストの実行 ではテストプログラムが用意できたので pytest コマンドを使ってユニットテストを実行しましょう。実行例では、出力メッセージからユニットテスト 3 件が実行され、3 件とも成功 (PASSED) して、C1 カバレッジが 100% 網羅されていることがわかります。\n$ python3 -m pip install -r test_requirements.txt $ pytest -v --cov --cov-branch =========================== test session starts ============================ platform linux -- Python 3.7.10, pytest-6.2.5, py-1.10.0, pluggy-1.0.0 -- /home/cloudshell-user/venv37/bin/python3 cachedir: .pytest_cache rootdir: /home/cloudshell-user/ plugins: cov-3.0.0, chalice-0.0.5 collected 3 items tests/test_app.py::test_hello_get PASSED [ 33%] tests/test_app.py::test_hello_post PASSED [ 66%] tests/test_app.py::test_hello_put PASSED [100%] ---------- coverage: platform linux, python 3.7.10-final-0 ----------- Name Stmts Miss Branch BrPart Cover ----------------------------------------------------- app.py 11 0 0 0 100% tests/__init__.py 0 0 0 0 100% tests/conftest.py 4 0 0 0 100% tests/test_app.py 16 0 0 0 100% ----------------------------------------------------- TOTAL 31 0 0 0 100% ============================ 3 passed in 0.05s ============================= 以上、ちょっとしたユニットテストの自動化のご紹介でした。\nCI/CD パイプラインを構築しよう 次はもう一歩進んで、ソースコードの更新をトリガーに自動でテストを実行してデプロイまで実施する CI/CD パイプラインを構築し、実際に動かすところまで行ってみたいと思います。\nStep1. CI/CD パイプラインの作成 AWS Chalice には CI/CD パイプライン用の CloudFormation(CFn) テンプレートを自動生成してくれるとても便利な chalice generate-pipeline コマンドがあります。今回の例では、先ほど作ったユニットテストもパイプラインの中で実行するようにしますので、buildspec.yml を分離する -b オプションも付与して実行します。\n$ chalice generate-pipeline -b buildspec.yml  作成された CFn テンプレートは中身が大きいのでここには貼り付けませんが、おおよそ次のような AWS リソース作成が定義されています。\n AWS CodeCommit リポジトリ AWS CodeBuild プロジェクト AWS CodePipeline パイプライン Amazon Simple Storage Service(S3) バケット AWS IAM ロールおよびポリシー  なお、今回はユニットテストの結果をレポート出力できるように作成されたテンプレートファイルを編集して CodeBuild に割り当てる権限を追加しました。\n\"CodeBuildPolicy\": { \"Type\": \"AWS::IAM::Policy\", \"Properties\": { \"PolicyName\": \"CodeBuildPolicy\", \"PolicyDocument\": { \"Version\": \"2012-10-17\", \"Statement\": [ { + \"Action\": [ + \"codebuild:CreateReportGroup\", + \"codebuild:CreateReport\", + \"codebuild:UpdateReport\", + \"codebuild:BatchPutTestCases\", + \"codebuild:BatchPutCodeCoverages\" + ], + \"Resource\": \"*\", + \"Effect\": \"Allow\" + }, { \"Action\": [ では CFn テンプレートからリソースをデプロイしましょう。実行例のようにスタック作成の成功と出力されたら完了です。\n$ aws cloudformation deploy --stack-name  --template-file  --capabilities CAPABILITY_IAM : Successfully created/updated stack -  Step2. パイプラインジョブ定義の編集 次に chalice generate-pipeline で生成されたパイプラインジョブの定義を編集して、ユニットテストも自動で実行するようにしていきましょう。編集前のファイル内容はこちらです。\nartifacts: files: - transformed.yaml type: zip phases: install: commands: - sudo pip install --upgrade awscli - aws --version - sudo pip install 'chalice=1.26.0,編集後のファイルは次のようにしてみました。記載順序の入れ替えやビルドフェーズの分割も併せて実施していてわかりにくくなっていますが、要約すると test_requirements.txt の読み込みと pytest コマンドの実行をステップとして追加しています。\nversion: 0.2 phases: install: commands: - python --version pre_build: commands: - sudo pip install --upgrade awscli pip - aws --version - sudo pip install -r requirements.txt -r test_requirements.txt build: commands: - pytest -v -junit-xml=test-result.xml --cov --cov-branch --cov-report=xml --cov-report=term post_build: commands: - chalice package /tmp/packaged - aws cloudformation package --template-file /tmp/packaged/sam.json --s3-bucket ${APP_S3_BUCKET} --output-template-file transformed.yaml reports: pytest_reports: files: - test-result.xml file-format: JUNITXML cobertura_reports: files: - coverage.xml file-format: COBERTURAXML artifacts: files: - transformed.yaml Step3. CI/CD パイプラインの動作確認 環境もパイプラインジョブの定義も整いましたので、あとは作成された CodeCommit リポジトリへソースコードを登録して、それをトリガーに自動でパイプラインが実行されるところまで見ていきましょう。\nまずはローカルに git リポジトリを作成して、ソースコードのコミットまでしていきます。今回の .gitignore ファイルは GitHub さんが公開する Python 向けテンプレートを使ってます。\n$ git init . $ curl https://raw.githubusercontent.com/github/gitignore/master/Python.gitignore  .gitignore $ git add . $ git commit -m \"Initial commit\" 次に、ソースコードを格納する AWS CodeCommit リポジトリの URL を確認します。\n$ aws cloudformation describe-stacks --stack-name  --query 'Stacks[0].Outputs' : - OutputKey: SourceRepoURL  OutputValue: https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/ : 先ほど調べたリポジトリ情報を元に、リモートリポジトリを追加します。\n$ git remote add codecommit https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/ CodeCommit へ Push できるように認証情報ヘルパーを設定します。\n$ git config --global credential.helper '!aws codecommit credential-helper $@' $ git config --global credential.UseHttpPath true ではソースコードをリモートレポジトリへ push してみましょう。\n$ git push codecommit master さてここからは AWS マネジメントコンソールに移ります。先ほどの git push をトリガーにパイプラインが起動していることを確認するためまずは CodePipeline 画面へ。次のように CI/CD パイプラインが動作していることが確認できるかと思います。\nでは次に、ビルド処理に追加したユニットテストが動いているかを確認しましょう。Build ステージの CodeBuild アクションボックスの「成功しました」メッセージのすぐ下にある「詳細」ボタンをクリックして CodeBuild 画面へ進みましょう。次のようにビルドログからユニットテストが実行されていることが確認できるかと思います。\nまた、テストとカバレッジのレポートについてはレポートグループの方にも登録されていることが確認できるかと思います。\nでは CodePipeline 画面へ戻りましょう。Beta ステージで実施しているアプリケーションのデプロイにも成功していることがわかりますね。ExcecuteChangeSet アクションボックスの「詳細」ボタンをクリックし、CloudFormation 画面へ進みましょう。\nCloudFormation 画面では出力の一覧から EndpointURL 値を確認しましょう。\n最後に、期待するレスポンスが返ってくるか生成された EndpointURL に向けて HTTP リクエストを発行して確認しましょう。実行例では期待するレスポンスが返ってきてますね。\n$ curl https://.execute-api.ap-northeast-1.amazonaws.com/api/hello {\"hello\":\"world\"} $ curl -X POST -H \"Content-Type: application/json\" -d '{\"payload\":\"hello, world\"}' https://.execute-api.ap-northeast-1.amazonaws.com/api/hello {\"result\":\"hello, world\"} 本来はもっとパイプラインに条件分岐を持たせたりすると思いますが、ひとまずこれでソースコードのプッシュを契機にテストを走らせてからデプロイを行う、という最低限の流れを自動化することができました。\n以上、ちょっとした CI/CD パイプラインの作成でした。\nちゃんとしたアプリケーションを開発するには 公式ドキュメントを活用しよう ちゃんとしたアプリケーションにするにはもちろん色々と機能を実装しないといけませんよね。こんなときにいつも私がお世話になっているのが公式ドキュメントです。トピックごとに簡単なサンプルを交えた実装方法について記載がありますのでとても参考になるかと思います。\nhttps://aws.github.io/chalice/main.html\nサービス別資料を参考にしよう もちろん AWS さんのサービス別資料もとても参考になります。こちらも目を通していただけると良いかと思います。\n余談ですが 本記事執筆のきっかけとなった AWS Summit Online Japan 2021 で行った日立の講演についてもご紹介させてください。\nこの講演では、IoT やサーバレス技術を活用した異なるタイプ(データ分析系とアプリケーション開発系)の事例を 1 件ずつお話させていただきました。AWS Chalice については、2 つ目のアプリケーション開発系の事例にて本当に軽くですが触れておりますのでよろしければご参照いただけると幸いです。\nこの講演を通じて「ほほう、日立ってこんなこともしてたんだ」と多少なりとも良いイメージを抱いてもらえるきっかけになってくれると嬉しいなと思ってます σ(,,´∀ ｀,,)\n終わりに AWS Chalice はいかがだったでしょうか？\nAWS には、AWS SAM (Serverless Application Model)といった別のサーバレスアプリケーション開発用フレームワークがありますが、こちらと比較すると機能がかなり限定されることもあって、今回ご紹介した AWS Chalice は多くの方にとって馴染みもなければ、なかなかに触れる機会も少ないのかもしれません。\nただ、実際に触ってみていただけばわかる通り、非常に簡単・手軽にサーバレスアプリケーションを作ることができますので、迅速性を求められる PoC(概念実証)や PoV(価値実証)といった場面で特に有用なのでは、と考えています。気になった方はぜひ触ってみて、そのお手軽さを実際に体験していただければと思います。\n以上、AWS 上でサーバレスアプリケーションを手軽に開発できるようにする「AWS Chalice」のご紹介でした。\n  AWS は、米国その他の諸国における Amazon.com, Inc. またはその関連会社の商標です。 その他、本資料に記述してある会社名、製品名は、各社の登録商品または商標です。  ","wordCount":"1026","inLanguage":"en","datePublished":"2021-10-18T00:00:00Z","dateModified":"2021-10-18T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://chacco38.github.io/posts/2021/10/aws-chalice/"},"publisher":{"@type":"Organization","name":"クラウドCoEの何でも屋","logo":{"@type":"ImageObject","url":"https://chacco38.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://chacco38.github.io/ accesskey=h title="クラウドCoEの何でも屋 (Alt + H)">クラウドCoEの何でも屋</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://chacco38.github.io/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://chacco38.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://chacco38.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://chacco38.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://chacco38.github.io/posts/>Posts</a></div><h1 class=post-title>AWS Chaliceを使ってサーバレスアプリケーションを開発しよう</h1><div class=post-meta><span title="2021-10-18 00:00:00 +0000 UTC">October 18, 2021</span>&nbsp;·&nbsp;5 min&nbsp;|&nbsp;<a href=https://github.com/chacco38/chacco38.github.io/tree/main/content/posts/2021/10/aws-chalice/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e3%81%af%e3%81%98%e3%82%81%e3%81%ab aria-label=はじめに>はじめに</a></li><li><a href=#%e6%94%b9%e3%82%81%e3%81%a6-aws-chalice-%e3%81%a8%e3%81%af aria-label="改めて AWS Chalice とは">改めて AWS Chalice とは</a></li><li><a href=#%e3%81%a7%e3%81%af%e3%81%95%e3%81%a3%e3%81%9d%e3%81%8f-aws-chalice-%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%81%bf%e3%82%88%e3%81%86 aria-label="ではさっそく AWS Chalice を使ってみよう">ではさっそく AWS Chalice を使ってみよう</a><ul><li><a href=#%e3%81%be%e3%81%9a%e3%81%af%e9%96%8b%e7%99%ba%e7%92%b0%e5%a2%83%e3%81%ae%e6%a7%8b%e7%af%89%e3%81%8b%e3%82%89 aria-label=まずは開発環境の構築から>まずは開発環境の構築から</a></li><li><a href=#%e7%b0%a1%e5%8d%98%e3%81%aa%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%82%92%e5%8b%95%e3%81%8b%e3%81%97%e3%81%a6%e3%81%bf%e3%82%88%e3%81%86 aria-label=簡単なアプリケーションを動かしてみよう>簡単なアプリケーションを動かしてみよう</a><ul><li><a href=#step1-%e6%96%b0%e8%a6%8f%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%81%ae%e4%bd%9c%e6%88%90 aria-label="Step1. 新規プロジェクトの作成">Step1. 新規プロジェクトの作成</a></li><li><a href=#step2-%e3%82%bd%e3%83%bc%e3%82%b9%e3%82%b3%e3%83%bc%e3%83%89%e3%81%ae%e7%b7%a8%e9%9b%86 aria-label="Step2. ソースコードの編集">Step2. ソースコードの編集</a></li><li><a href=#step3-%e3%83%ad%e3%83%bc%e3%82%ab%e3%83%ab%e7%92%b0%e5%a2%83%e3%81%a7%e5%8b%95%e4%bd%9c%e7%a2%ba%e8%aa%8d aria-label="Step3. ローカル環境で動作確認">Step3. ローカル環境で動作確認</a></li><li><a href=#step4-aws-%e4%b8%8a%e3%81%b8%e3%83%87%e3%83%97%e3%83%ad%e3%82%a4 aria-label="Step4. AWS 上へデプロイ">Step4. AWS 上へデプロイ</a></li><li><a href=#stepex-%e3%83%87%e3%83%97%e3%83%ad%e3%82%a4%e3%81%97%e3%81%9f%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%ae%e5%89%8a%e9%99%a4 aria-label="StepEX. デプロイしたアプリケーションの削除">StepEX. デプロイしたアプリケーションの削除</a></li></ul></li><li><a href=#%e3%82%88%e3%82%8a%e5%ae%9f%e8%b7%b5%e7%9a%84%e3%81%aa%e9%96%8b%e7%99%ba%e3%82%92%e8%a1%8c%e3%81%86%e3%81%ab%e3%81%82%e3%81%9f%e3%81%a3%e3%81%a6 aria-label=より実践的な開発を行うにあたって>より実践的な開発を行うにあたって</a><ul><li><a href=#%e3%83%a6%e3%83%8b%e3%83%83%e3%83%88%e3%83%86%e3%82%b9%e3%83%88%e3%82%92%e8%87%aa%e5%8b%95%e5%8c%96%e3%81%97%e3%81%be%e3%81%97%e3%82%87%e3%81%86 aria-label=ユニットテストを自動化しましょう>ユニットテストを自動化しましょう</a><ul><li><a href=#step1-%e3%83%86%e3%82%b9%e3%83%88%e3%82%b3%e3%83%bc%e3%83%89%e3%81%ae%e5%ae%9f%e8%a3%85 aria-label="Step1. テストコードの実装">Step1. テストコードの実装</a></li><li><a href=#step2-%e3%83%a6%e3%83%8b%e3%83%83%e3%83%88%e3%83%86%e3%82%b9%e3%83%88%e3%81%ae%e5%ae%9f%e8%a1%8c aria-label="Step2. ユニットテストの実行">Step2. ユニットテストの実行</a></li></ul></li><li><a href=#cicd-%e3%83%91%e3%82%a4%e3%83%97%e3%83%a9%e3%82%a4%e3%83%b3%e3%82%92%e6%a7%8b%e7%af%89%e3%81%97%e3%82%88%e3%81%86 aria-label="CI/CD パイプラインを構築しよう">CI/CD パイプラインを構築しよう</a><ul><li><a href=#step1-cicd-%e3%83%91%e3%82%a4%e3%83%97%e3%83%a9%e3%82%a4%e3%83%b3%e3%81%ae%e4%bd%9c%e6%88%90 aria-label="Step1. CI/CD パイプラインの作成">Step1. CI/CD パイプラインの作成</a></li><li><a href=#step2-%e3%83%91%e3%82%a4%e3%83%97%e3%83%a9%e3%82%a4%e3%83%b3%e3%82%b8%e3%83%a7%e3%83%96%e5%ae%9a%e7%be%a9%e3%81%ae%e7%b7%a8%e9%9b%86 aria-label="Step2. パイプラインジョブ定義の編集">Step2. パイプラインジョブ定義の編集</a></li><li><a href=#step3-cicd-%e3%83%91%e3%82%a4%e3%83%97%e3%83%a9%e3%82%a4%e3%83%b3%e3%81%ae%e5%8b%95%e4%bd%9c%e7%a2%ba%e8%aa%8d aria-label="Step3. CI/CD パイプラインの動作確認">Step3. CI/CD パイプラインの動作確認</a></li></ul></li></ul></li><li><a href=#%e3%81%a1%e3%82%83%e3%82%93%e3%81%a8%e3%81%97%e3%81%9f%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%82%92%e9%96%8b%e7%99%ba%e3%81%99%e3%82%8b%e3%81%ab%e3%81%af aria-label=ちゃんとしたアプリケーションを開発するには>ちゃんとしたアプリケーションを開発するには</a><ul><li><a href=#%e5%85%ac%e5%bc%8f%e3%83%89%e3%82%ad%e3%83%a5%e3%83%a1%e3%83%b3%e3%83%88%e3%82%92%e6%b4%bb%e7%94%a8%e3%81%97%e3%82%88%e3%81%86 aria-label=公式ドキュメントを活用しよう>公式ドキュメントを活用しよう</a></li><li><a href=#%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e5%88%a5%e8%b3%87%e6%96%99%e3%82%92%e5%8f%82%e8%80%83%e3%81%ab%e3%81%97%e3%82%88%e3%81%86 aria-label=サービス別資料を参考にしよう>サービス別資料を参考にしよう</a></li></ul></li></ul></li><li><a href=#%e4%bd%99%e8%ab%87%e3%81%a7%e3%81%99%e3%81%8c aria-label=余談ですが>余談ですが</a></li><li><a href=#%e7%b5%82%e3%82%8f%e3%82%8a%e3%81%ab aria-label=終わりに>終わりに</a></li></ul></div></details></div><div class=post-content><h1 id=はじめに>はじめに<a hidden class=anchor aria-hidden=true href=#はじめに>#</a></h1><p>みなさん、こんにちは。今回は「AWS Chalice」を活用したサーバレスアプリケーション開発についてのお話です。AWS Summit Online Japan 2021 の日立製作所の講演で軽く触れたこともあり、どこかで紹介したいと思っておりました。</p><p>さて、AWS Chalice は多くの方にとってあまり馴染みのないツールだと思いますが、実際に使ってみるととても手軽に Amazon API Gateway と AWS Lambda を使用するサーバレスアプリケーションを作成してデプロイすることができます。もちろん、どんなツールにも得手不得手はあるので「すべてのプロジェクトで AWS Chalice の活用が最適か？」と言われればもちろん「No！」なのですが、ちょっと試しに動く Web API をサッと手軽に作りたい、といったケースにはとても良いソリューションだと思います。</p><p>今回は AWS CloudShell 上に開発環境を作るところからはじめて、簡素なサンプルを用いた一連の開発の流れ、テスト自動化を組み込んだシンプルな CI/CD パイプラインの構築まで紹介していきたいと思います。これから実際に動くサーバレスアプリケーションを手軽に作りたいと思われている方は参考にしてみてはいかがでしょうか。</p><h1 id=改めて-aws-chalice-とは>改めて AWS Chalice とは<a hidden class=anchor aria-hidden=true href=#改めて-aws-chalice-とは>#</a></h1><p>AWS Chalice とは、Amazon AWS Gateway や AWS Lambda を用いたサーバレスアプリケーションを、お手軽に開発できるようにする Python 製のサーバレスアプリケーションフレームワークです。具体的には、Web API をシンプルで直感的なコードで実装できるようにする機能や、作成したコードからアプリケーションの作成やデプロイを実行するコマンドラインインタフェース(CLI)といった開発者にやさしい機能を提供してくれます。</p><p>普段から Python に触れている方であれば似たような機能として <a href=https://flask.palletsprojects.com/>Flask</a> や <a href=https://bottlepy.org/>Bottle</a> をイメージされるかと思いますが、これらにサーバレス環境へデプロイする機能が追加で付与されたものが AWS Chalice、とイメージしていただくと良いのかなと思います。</p><p><a href=https://github.com/aws/chalice>https://github.com/aws/chalice</a></p><h1 id=ではさっそく-aws-chalice-を使ってみよう>ではさっそく AWS Chalice を使ってみよう<a hidden class=anchor aria-hidden=true href=#ではさっそく-aws-chalice-を使ってみよう>#</a></h1><p>「はじめに」で既に述べたとおり、今回は AWS CloudShell 上に開発環境を作るところからはじめて、簡素なサンプルを用いた一連の開発の流れ、テスト自動化を組み込んだシンプルな CI/CD パイプラインの構築まで紹介していきたいと思います。</p><h2 id=まずは開発環境の構築から>まずは開発環境の構築から<a hidden class=anchor aria-hidden=true href=#まずは開発環境の構築から>#</a></h2><p>今回は AWS CloudShell 上に開発環境を作っていきたいと思います。
それではまず AWS Chalice をインストールする事前準備として Python の仮想環境を作成していきましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo yum install -y python3
</span></span><span style=display:flex><span>$ python3 --version
</span></span><span style=display:flex><span>Python 3.7.10
</span></span><span style=display:flex><span>$ python3 -m venv venv37
</span></span><span style=display:flex><span>$ . venv37/bin/activate
</span></span></code></pre></div><p>次に、AWS Chalice をインストールします。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 -m pip install chalice
</span></span><span style=display:flex><span>$ chalice --version
</span></span><span style=display:flex><span>chalice 1.26.0, python 3.7.10, linux 4.14.243-185.433.amzn2.x86_64
</span></span></code></pre></div><p>最後に、AWS CLI の設定をして開発環境の構築は完了です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws configure
</span></span></code></pre></div><h2 id=簡単なアプリケーションを動かしてみよう>簡単なアプリケーションを動かしてみよう<a hidden class=anchor aria-hidden=true href=#簡単なアプリケーションを動かしてみよう>#</a></h2><p>ここでは AWS Chalice を使ったアプリケーションの作成からデプロイまでの流れを、次のような簡単なサンプルを用いて紹介していきたいと思います。</p><p><img loading=lazy src=images/01-sample-image.drawio.png alt=01-sample-image.drawio.png></p><h3 id=step1-新規プロジェクトの作成>Step1. 新規プロジェクトの作成<a hidden class=anchor aria-hidden=true href=#step1-新規プロジェクトの作成>#</a></h3><p>まずは <code>chalice new-project</code> コマンドを実行して新しいプロジェクトを作成します。出力例のようにプロジェクトを新しく作るとデフォルトでサンプルプログラムも生成されます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ chalice new-project &lt;任意のプロジェクト名&gt;
</span></span><span style=display:flex><span>$ cd &lt;任意のプロジェクト名&gt;
</span></span><span style=display:flex><span>$ tree -a
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── app.py               <span style=color:#75715e># APIの実装を行うファイル</span>
</span></span><span style=display:flex><span>├── .chalice
</span></span><span style=display:flex><span>│   └── config.json      <span style=color:#75715e># Chaliceの設定を行うファイル</span>
</span></span><span style=display:flex><span>├── .gitignore
</span></span><span style=display:flex><span>└── requirements.txt     <span style=color:#75715e># 利用するライブラリの定義を行うファイル</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> directory, <span style=color:#ae81ff>4</span> file
</span></span></code></pre></div><h3 id=step2-ソースコードの編集>Step2. ソースコードの編集<a hidden class=anchor aria-hidden=true href=#step2-ソースコードの編集>#</a></h3><p>今回はデフォルトで作られたソースコードにちょっとだけ手を加えました。修正後のファイルの中身は次の通りです。実際の例を見ていただけるとわかる通り、AWS Chalice を用いた実装は Python を普段使わないという方でも直感的でわかりやすい構文になっているのではないでしょうか。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python:app.py data-lang=python:app.py><span style=display:flex><span><span style=color:#f92672>from</span> chalice <span style=color:#f92672>import</span> Chalice
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> Chalice(app_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&lt;任意のプロジェクト名&gt;&#39;</span>)
</span></span><span style=display:flex><span>app<span style=color:#f92672>.</span>log<span style=color:#f92672>.</span>setLevel(logging<span style=color:#f92672>.</span>INFO)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app</span><span style=color:#f92672>.</span>route(<span style=color:#e6db74>&#39;/hello&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>hello</span>():
</span></span><span style=display:flex><span>    app<span style=color:#f92672>.</span>log<span style=color:#f92672>.</span>debug(<span style=color:#e6db74>&#34;Invoking from function hello&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {<span style=color:#e6db74>&#39;hello&#39;</span>: <span style=color:#e6db74>&#39;world&#39;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app</span><span style=color:#f92672>.</span>route(<span style=color:#e6db74>&#39;/hello&#39;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;POST&#39;</span>], content_types<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;application/json&#39;</span>], cors<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>hello_post</span>():
</span></span><span style=display:flex><span>    app<span style=color:#f92672>.</span>log<span style=color:#f92672>.</span>debug(<span style=color:#e6db74>&#34;Invoking from function hello_post&#34;</span>)
</span></span><span style=display:flex><span>    request <span style=color:#f92672>=</span> app<span style=color:#f92672>.</span>current_request
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {<span style=color:#e6db74>&#39;result&#39;</span>: request<span style=color:#f92672>.</span>json_body[<span style=color:#e6db74>&#39;payload&#39;</span>]}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text:requirements.txt data-lang=text:requirements.txt><span style=display:flex><span>chalice
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json:.chalice/config.json data-lang=json:.chalice/config.json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;2.0&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;app_name&#34;</span>: <span style=color:#e6db74>&#34;&lt;任意のプロジェクト名&gt;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;stages&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;dev&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;api_gateway_stage&#34;</span>: <span style=color:#e6db74>&#34;api&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=step3-ローカル環境で動作確認>Step3. ローカル環境で動作確認<a hidden class=anchor aria-hidden=true href=#step3-ローカル環境で動作確認>#</a></h3><p>AWS 上へデプロイする前にローカル環境で軽く動作をしたい場合は、<code>chalice local</code> コマンドを実行します。
実行例のように期待通りのレスポンスが返ってくるようであれば、いよいよ AWS 上へデプロイをしていきます。</p><pre tabindex=0><code class=language-bash:Termina1 data-lang=bash:Termina1>$ chalice local
Serving on http://127.0.0.1:8000
</code></pre><pre tabindex=0><code class=language-bash:Terminal2 data-lang=bash:Terminal2>$ curl http://127.0.0.1:8000/hello
{&#34;hello&#34;:&#34;world&#34;}
$ curl -X POST -H &#34;Content-Type: application/json&#34; -d &#39;{&#34;payload&#34;:&#34;hello, world&#34;}&#39; http://127.0.0.1:8000/hello
{&#34;result&#34;:&#34;hello, world&#34;}
</code></pre><h3 id=step4-aws-上へデプロイ>Step4. AWS 上へデプロイ<a hidden class=anchor aria-hidden=true href=#step4-aws-上へデプロイ>#</a></h3><p>AWS 上へアプリケーションのデプロイをする場合は、<code>chalice deploy</code> コマンドを実行します。実行例ではメッセージから新たに Lambda 関数、API Gateway と IAM ロールが作られていることがわかります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ chalice deploy --stage dev
</span></span><span style=display:flex><span>Creating deployment package.
</span></span><span style=display:flex><span>Creating IAM role: &lt;任意のプロジェクト名&gt;-dev
</span></span><span style=display:flex><span>Creating lambda <span style=color:#66d9ef>function</span>: &lt;任意のプロジェクト名&gt;-dev
</span></span><span style=display:flex><span>Creating Rest API
</span></span><span style=display:flex><span>Resources deployed:
</span></span><span style=display:flex><span>  - Lambda ARN: arn:aws:lambda:ap-northeast-1:&lt;AWSアカウント名&gt;:function:&lt;任意のプロジェクト名&gt;-dev
</span></span><span style=display:flex><span>  - Rest API URL: https://&lt;文字列&gt;.execute-api.ap-northeast-1.amazonaws.com/api/
</span></span></code></pre></div><p>デプロイ完了後は期待するレスポンスが返ってくるか確認しましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl https://&lt;文字列&gt;.execute-api.ap-northeast-1.amazonaws.com/api/hello
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;hello&#34;</span>:<span style=color:#e6db74>&#34;world&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>$ curl -X POST -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -d <span style=color:#e6db74>&#39;{&#34;payload&#34;:&#34;hello, world&#34;}&#39;</span> https://&lt;文字列&gt;.execute-api.ap-northeast-1.amazonaws.com/api/hello
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;result&#34;</span>:<span style=color:#e6db74>&#34;hello, world&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>以上、AWS Chalice を使ったアプリケーションの作成からデプロイまでの一連の流れでした。</p><h3 id=stepex-デプロイしたアプリケーションの削除>StepEX. デプロイしたアプリケーションの削除<a hidden class=anchor aria-hidden=true href=#stepex-デプロイしたアプリケーションの削除>#</a></h3><p>不要になったアプリケーションは <code>chalice delete</code> コマンドを使って削除しておきましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ chalice delete
</span></span><span style=display:flex><span>Deleting Rest API: &lt;文字列&gt;
</span></span><span style=display:flex><span>Deleting <span style=color:#66d9ef>function</span>: arn:aws:lambda:ap-northeast-1:&lt;AWSアカウント名&gt;:function:&lt;任意のプロジェクト名&gt;-dev
</span></span><span style=display:flex><span>Deleting IAM role: &lt;任意のプロジェクト名&gt;-dev
</span></span></code></pre></div><h2 id=より実践的な開発を行うにあたって>より実践的な開発を行うにあたって<a hidden class=anchor aria-hidden=true href=#より実践的な開発を行うにあたって>#</a></h2><h3 id=ユニットテストを自動化しましょう>ユニットテストを自動化しましょう<a hidden class=anchor aria-hidden=true href=#ユニットテストを自動化しましょう>#</a></h3><p>近頃はユニットテストの自動化は一般的に行われているかと思います。AWS Chalice でも Python の一般的なテストツール Pytest を使ってユニットテストを実装することができます。例として、今回は次のサンプルに対するテストコードを実装してみます。</p><pre tabindex=0><code class=language-python:app.py(テスト対象のプログラム) data-lang=python:app.py(テスト対象のプログラム)>from chalice import Chalice

app = Chalice(app_name=&#39;&lt;任意のプロジェクト名&gt;&#39;)
app.log.setLevel(logging.INFO)

@app.route(&#39;/hello&#39;)
def hello():
    app.log.debug(&#34;Invoking from function hello&#34;)
    return {&#39;hello&#39;: &#39;world&#39;}

@app.route(&#39;/hello&#39;, methods=[&#39;POST&#39;], content_types=[&#39;application/json&#39;], cors=True)
def hello_post():
    app.log.debug(&#34;Invoking from function hello_post&#34;)
    request = app.current_request
    return {&#39;result&#39;: request.json_body[&#39;payload&#39;]}
</code></pre><h4 id=step1-テストコードの実装>Step1. テストコードの実装<a hidden class=anchor aria-hidden=true href=#step1-テストコードの実装>#</a></h4><p>では、まず必要なファイルを用意していきます。中身は後で入れるとしてここでは空ファイルだけ作ります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ touch test_requirements.txt    <span style=color:#75715e># テストプログラムの依存ライブラリ定義</span>
</span></span><span style=display:flex><span>$ mkdir tests
</span></span><span style=display:flex><span>$ touch tests/__init__.py
</span></span><span style=display:flex><span>$ touch tests/conftest.py        <span style=color:#75715e># テストプログラム間で共通の処理を実装</span>
</span></span><span style=display:flex><span>$ touch tests/test_app.py        <span style=color:#75715e># テストプログラムを実装</span>
</span></span></code></pre></div><p>次に各ファイルを編集していきます。今回は HTTP レスポンスのステータスコードとボディの中身を確認するだけの簡単なテストプログラムを用意しました。</p><pre tabindex=0><code class=language-text:test_requirements.txt（依存ライブラリの定義） data-lang=text:test_requirements.txt（依存ライブラリの定義）>pytest-chalice
pytest-cov
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python:tests/__init__.py data-lang=python:tests/__init__.py><span style=display:flex><span>(EOF)
</span></span></code></pre></div><pre tabindex=0><code class=language-python:tests/conftest.py（共通処理の実装） data-lang=python:tests/conftest.py（共通処理の実装）>import pytest
from app import app as chalice_app

@pytest.fixture
def app():
	return chalice_app
</code></pre><pre tabindex=0><code class=language-python:tests/test_app.py（テストの実装） data-lang=python:tests/test_app.py（テストの実装）>from http import HTTPStatus
import json

def test_hello_get(client):
    response = client.get(&#39;/hello&#39;)
    assert response.status_code == HTTPStatus.OK
    assert response.json == {&#39;hello&#39;: &#39;world&#39;}

def test_hello_post(client):
    headers = {&#39;Content-type&#39;:&#39;application/json&#39;}
    payload = {&#39;payload&#39;:&#39;hello, world&#39;}
    response = client.post(&#39;/hello&#39;, headers=headers, body=json.dumps(payload))
    assert response.status_code == HTTPStatus.OK
    assert response.json == {&#39;result&#39;: &#39;hello, world&#39;}

def test_hello_put(client):
    response = client.put(&#39;/hello&#39;)
    assert response.status_code == HTTPStatus.METHOD_NOT_ALLOWED
    assert response.json == {&#34;Code&#34;:&#34;MethodNotAllowedError&#34;,&#34;Message&#34;:&#34;Unsupported method: PUT&#34;}
</code></pre><h4 id=step2-ユニットテストの実行>Step2. ユニットテストの実行<a hidden class=anchor aria-hidden=true href=#step2-ユニットテストの実行>#</a></h4><p>ではテストプログラムが用意できたので <code>pytest</code> コマンドを使ってユニットテストを実行しましょう。実行例では、出力メッセージからユニットテスト 3 件が実行され、3 件とも成功 (PASSED) して、C1 カバレッジが 100% 網羅されていることがわかります。</p><pre tabindex=0><code class=language-bash:テストの実行 data-lang=bash:テストの実行>$ python3 -m pip install -r test_requirements.txt
$ pytest -v --cov --cov-branch
=========================== test session starts ============================
platform linux -- Python 3.7.10, pytest-6.2.5, py-1.10.0, pluggy-1.0.0 -- /home/cloudshell-user/venv37/bin/python3
cachedir: .pytest_cache
rootdir: /home/cloudshell-user/&lt;任意のプロジェクト名&gt;
plugins: cov-3.0.0, chalice-0.0.5
collected 3 items

tests/test_app.py::test_hello_get PASSED                             [ 33%]
tests/test_app.py::test_hello_post PASSED                            [ 66%]
tests/test_app.py::test_hello_put PASSED                             [100%]

---------- coverage: platform linux, python 3.7.10-final-0 -----------
Name                Stmts   Miss Branch BrPart  Cover
-----------------------------------------------------
app.py                 11      0      0      0   100%
tests/__init__.py       0      0      0      0   100%
tests/conftest.py       4      0      0      0   100%
tests/test_app.py      16      0      0      0   100%
-----------------------------------------------------
TOTAL                  31      0      0      0   100%

============================ 3 passed in 0.05s =============================
</code></pre><p>以上、ちょっとしたユニットテストの自動化のご紹介でした。</p><h3 id=cicd-パイプラインを構築しよう>CI/CD パイプラインを構築しよう<a hidden class=anchor aria-hidden=true href=#cicd-パイプラインを構築しよう>#</a></h3><p>次はもう一歩進んで、ソースコードの更新をトリガーに自動でテストを実行してデプロイまで実施する CI/CD パイプラインを構築し、実際に動かすところまで行ってみたいと思います。</p><h4 id=step1-cicd-パイプラインの作成>Step1. CI/CD パイプラインの作成<a hidden class=anchor aria-hidden=true href=#step1-cicd-パイプラインの作成>#</a></h4><p>AWS Chalice には CI/CD パイプライン用の CloudFormation(CFn) テンプレートを自動生成してくれるとても便利な <code>chalice generate-pipeline</code> コマンドがあります。今回の例では、先ほど作ったユニットテストもパイプラインの中で実行するようにしますので、buildspec.yml を分離する <code>-b</code> オプションも付与して実行します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ chalice generate-pipeline -b buildspec.yml &lt;テンプレートファイル名&gt;
</span></span></code></pre></div><p>作成された CFn テンプレートは中身が大きいのでここには貼り付けませんが、おおよそ次のような AWS リソース作成が定義されています。</p><ul><li>AWS CodeCommit リポジトリ</li><li>AWS CodeBuild プロジェクト</li><li>AWS CodePipeline パイプライン</li><li>Amazon Simple Storage Service(S3) バケット</li><li>AWS IAM ロールおよびポリシー</li></ul><p>なお、今回はユニットテストの結果をレポート出力できるように作成されたテンプレートファイルを編集して CodeBuild に割り当てる権限を追加しました。</p><pre tabindex=0><code class=language-diff:CFnテンプレート（編集後） data-lang=diff:CFnテンプレート（編集後）>    &#34;CodeBuildPolicy&#34;: {
      &#34;Type&#34;: &#34;AWS::IAM::Policy&#34;,
      &#34;Properties&#34;: {
        &#34;PolicyName&#34;: &#34;CodeBuildPolicy&#34;,
        &#34;PolicyDocument&#34;: {
          &#34;Version&#34;: &#34;2012-10-17&#34;,
          &#34;Statement&#34;: [
            {
+             &#34;Action&#34;: [
+               &#34;codebuild:CreateReportGroup&#34;,
+               &#34;codebuild:CreateReport&#34;,
+               &#34;codebuild:UpdateReport&#34;,
+               &#34;codebuild:BatchPutTestCases&#34;,
+               &#34;codebuild:BatchPutCodeCoverages&#34;
+             ],
+             &#34;Resource&#34;: &#34;*&#34;,
+             &#34;Effect&#34;: &#34;Allow&#34;
+           },
            {
              &#34;Action&#34;: [
</code></pre><p>では CFn テンプレートからリソースをデプロイしましょう。実行例のようにスタック作成の成功と出力されたら完了です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws cloudformation deploy --stack-name &lt;スタック名&gt; --template-file &lt;テンプレートファイル名&gt; --capabilities CAPABILITY_IAM
</span></span><span style=display:flex><span>:
</span></span><span style=display:flex><span>Successfully created/updated stack - &lt;スタック名&gt;
</span></span></code></pre></div><h4 id=step2-パイプラインジョブ定義の編集>Step2. パイプラインジョブ定義の編集<a hidden class=anchor aria-hidden=true href=#step2-パイプラインジョブ定義の編集>#</a></h4><p>次に <code>chalice generate-pipeline</code> で生成されたパイプラインジョブの定義を編集して、ユニットテストも自動で実行するようにしていきましょう。編集前のファイル内容はこちらです。</p><pre tabindex=0><code class=language-yaml:buildspec.yml（編集前） data-lang=yaml:buildspec.yml（編集前）>artifacts:
  files:
  - transformed.yaml
  type: zip
phases:
  install:
    commands:
    - sudo pip install --upgrade awscli
    - aws --version
    - sudo pip install &#39;chalice&gt;=1.26.0,&lt;1.27.0&#39;
    - sudo pip install -r requirements.txt
    - chalice package /tmp/packaged
    - aws cloudformation package --template-file /tmp/packaged/sam.json --s3-bucket
      ${APP_S3_BUCKET} --output-template-file transformed.yaml
version: &#39;0.1&#39;
</code></pre><p>編集後のファイルは次のようにしてみました。記載順序の入れ替えやビルドフェーズの分割も併せて実施していてわかりにくくなっていますが、要約すると test_requirements.txt の読み込みと pytest コマンドの実行をステップとして追加しています。</p><pre tabindex=0><code class=language-yaml:buildspec.yml（編集後） data-lang=yaml:buildspec.yml（編集後）>version: 0.2
phases:
  install:
    commands:
    - python --version
  pre_build:
    commands:
    - sudo pip install --upgrade awscli pip
    - aws --version
    - sudo pip install -r requirements.txt -r test_requirements.txt
  build:
    commands:
    - pytest -v -junit-xml=test-result.xml --cov --cov-branch --cov-report=xml --cov-report=term
  post_build:
    commands:
    - chalice package /tmp/packaged
    - aws cloudformation package --template-file /tmp/packaged/sam.json --s3-bucket
      ${APP_S3_BUCKET} --output-template-file transformed.yaml
reports:
  pytest_reports:
    files:
      - test-result.xml
    file-format: JUNITXML
  cobertura_reports:
    files:
      - coverage.xml
    file-format: COBERTURAXML
artifacts:
  files:
  - transformed.yaml
</code></pre><h4 id=step3-cicd-パイプラインの動作確認>Step3. CI/CD パイプラインの動作確認<a hidden class=anchor aria-hidden=true href=#step3-cicd-パイプラインの動作確認>#</a></h4><p>環境もパイプラインジョブの定義も整いましたので、あとは作成された CodeCommit リポジトリへソースコードを登録して、それをトリガーに自動でパイプラインが実行されるところまで見ていきましょう。</p><p>まずはローカルに git リポジトリを作成して、ソースコードのコミットまでしていきます。今回の <code>.gitignore</code> ファイルは GitHub さんが公開する Python 向けテンプレートを使ってます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ git init .
</span></span><span style=display:flex><span>$ curl https://raw.githubusercontent.com/github/gitignore/master/Python.gitignore &gt; .gitignore
</span></span><span style=display:flex><span>$ git add .
</span></span><span style=display:flex><span>$ git commit -m <span style=color:#e6db74>&#34;Initial commit&#34;</span>
</span></span></code></pre></div><p>次に、ソースコードを格納する AWS CodeCommit リポジトリの URL を確認します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws cloudformation describe-stacks --stack-name &lt;スタック名&gt; --query <span style=color:#e6db74>&#39;Stacks[0].Outputs&#39;</span>
</span></span><span style=display:flex><span>:
</span></span><span style=display:flex><span>- OutputKey: SourceRepoURL
</span></span><span style=display:flex><span>  OutputValue: https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/&lt;プロジェクト名&gt;
</span></span><span style=display:flex><span>:
</span></span></code></pre></div><p>先ほど調べたリポジトリ情報を元に、リモートリポジトリを追加します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ git remote add codecommit https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/&lt;プロジェクト名&gt;
</span></span></code></pre></div><p>CodeCommit へ Push できるように認証情報ヘルパーを設定します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ git config --global credential.helper <span style=color:#e6db74>&#39;!aws codecommit credential-helper $@&#39;</span>
</span></span><span style=display:flex><span>$ git config --global credential.UseHttpPath true
</span></span></code></pre></div><p>ではソースコードをリモートレポジトリへ push してみましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ git push codecommit master
</span></span></code></pre></div><p>さてここからは AWS マネジメントコンソールに移ります。先ほどの <code>git push</code> をトリガーにパイプラインが起動していることを確認するためまずは CodePipeline 画面へ。次のように CI/CD パイプラインが動作していることが確認できるかと思います。</p><p><img loading=lazy src=images/02-codepipeline_build.png alt=02-codepipeline_build.png></p><p>では次に、ビルド処理に追加したユニットテストが動いているかを確認しましょう。Build ステージの CodeBuild アクションボックスの「成功しました」メッセージのすぐ下にある「詳細」ボタンをクリックして CodeBuild 画面へ進みましょう。次のようにビルドログからユニットテストが実行されていることが確認できるかと思います。</p><p><img loading=lazy src=images/03-codebuild.png alt=03-codebuild.png></p><p>また、テストとカバレッジのレポートについてはレポートグループの方にも登録されていることが確認できるかと思います。</p><p><img loading=lazy src=images/04-codbuild-report.png alt=04-codbuild-report.png></p><p>では CodePipeline 画面へ戻りましょう。Beta ステージで実施しているアプリケーションのデプロイにも成功していることがわかりますね。ExcecuteChangeSet アクションボックスの「詳細」ボタンをクリックし、CloudFormation 画面へ進みましょう。</p><p><img loading=lazy src=images/05-codepipeline_deploy.png alt=05-codepipeline_deploy.png></p><p>CloudFormation 画面では出力の一覧から EndpointURL 値を確認しましょう。</p><p><img loading=lazy src=images/06-stack.png alt=06-stack.png></p><p>最後に、期待するレスポンスが返ってくるか生成された EndpointURL に向けて HTTP リクエストを発行して確認しましょう。実行例では期待するレスポンスが返ってきてますね。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl https://&lt;文字列&gt;.execute-api.ap-northeast-1.amazonaws.com/api/hello
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;hello&#34;</span>:<span style=color:#e6db74>&#34;world&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>$ curl -X POST -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -d <span style=color:#e6db74>&#39;{&#34;payload&#34;:&#34;hello, world&#34;}&#39;</span> https://&lt;文字列&gt;.execute-api.ap-northeast-1.amazonaws.com/api/hello
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;result&#34;</span>:<span style=color:#e6db74>&#34;hello, world&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>本来はもっとパイプラインに条件分岐を持たせたりすると思いますが、ひとまずこれでソースコードのプッシュを契機にテストを走らせてからデプロイを行う、という最低限の流れを自動化することができました。</p><p>以上、ちょっとした CI/CD パイプラインの作成でした。</p><h2 id=ちゃんとしたアプリケーションを開発するには>ちゃんとしたアプリケーションを開発するには<a hidden class=anchor aria-hidden=true href=#ちゃんとしたアプリケーションを開発するには>#</a></h2><h3 id=公式ドキュメントを活用しよう>公式ドキュメントを活用しよう<a hidden class=anchor aria-hidden=true href=#公式ドキュメントを活用しよう>#</a></h3><p>ちゃんとしたアプリケーションにするにはもちろん色々と機能を実装しないといけませんよね。こんなときにいつも私がお世話になっているのが公式ドキュメントです。トピックごとに簡単なサンプルを交えた実装方法について記載がありますのでとても参考になるかと思います。</p><p><a href=https://aws.github.io/chalice/main.html>https://aws.github.io/chalice/main.html</a></p><h3 id=サービス別資料を参考にしよう>サービス別資料を参考にしよう<a hidden class=anchor aria-hidden=true href=#サービス別資料を参考にしよう>#</a></h3><p>もちろん AWS さんのサービス別資料もとても参考になります。こちらも目を通していただけると良いかと思います。</p><h1 id=余談ですが>余談ですが<a hidden class=anchor aria-hidden=true href=#余談ですが>#</a></h1><p>本記事執筆のきっかけとなった AWS Summit Online Japan 2021 で行った日立の講演についてもご紹介させてください。</p><p>この講演では、IoT やサーバレス技術を活用した異なるタイプ(データ分析系とアプリケーション開発系)の事例を 1 件ずつお話させていただきました。AWS Chalice については、2 つ目のアプリケーション開発系の事例にて本当に軽くですが触れておりますのでよろしければご参照いただけると幸いです。</p><p>この講演を通じて「ほほう、日立ってこんなこともしてたんだ」と多少なりとも良いイメージを抱いてもらえるきっかけになってくれると嬉しいなと思ってます σ(,,´∀ ｀,,)</p><h1 id=終わりに>終わりに<a hidden class=anchor aria-hidden=true href=#終わりに>#</a></h1><p>AWS Chalice はいかがだったでしょうか？</p><p>AWS には、AWS SAM (Serverless Application Model)といった別のサーバレスアプリケーション開発用フレームワークがありますが、こちらと比較すると機能がかなり限定されることもあって、今回ご紹介した AWS Chalice は多くの方にとって馴染みもなければ、なかなかに触れる機会も少ないのかもしれません。</p><p>ただ、実際に触ってみていただけばわかる通り、非常に簡単・手軽にサーバレスアプリケーションを作ることができますので、迅速性を求められる PoC(概念実証)や PoV(価値実証)といった場面で特に有用なのでは、と考えています。気になった方はぜひ触ってみて、そのお手軽さを実際に体験していただければと思います。</p><p>以上、AWS 上でサーバレスアプリケーションを手軽に開発できるようにする「AWS Chalice」のご紹介でした。</p><hr><ul><li>AWS は、米国その他の諸国における Amazon.com, Inc. またはその関連会社の商標です。</li><li>その他、本資料に記述してある会社名、製品名は、各社の登録商品または商標です。</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://chacco38.github.io/tags/aws/>AWS</a></li><li><a href=https://chacco38.github.io/tags/aws-chalice/>AWS Chalice</a></li><li><a href=https://chacco38.github.io/tags/aws-lambda/>AWS Lambda</a></li><li><a href=https://chacco38.github.io/tags/aws-cloudformation/>AWS CloudFormation</a></li><li><a href=https://chacco38.github.io/tags/aws-codepipeline/>AWS CodePipeline</a></li></ul><nav class=paginav><a class=prev href=https://chacco38.github.io/posts/2021/10/aws-taskcat/><span class=title>« Prev Page</span><br><span>TaskCatを使ってCloudFormationテンプレートの自動テストをしよう</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share AWS Chaliceを使ってサーバレスアプリケーションを開発しよう on twitter" href="https://twitter.com/intent/tweet/?text=AWS%20Chalice%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%82%b5%e3%83%bc%e3%83%90%e3%83%ac%e3%82%b9%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%82%92%e9%96%8b%e7%99%ba%e3%81%97%e3%82%88%e3%81%86&url=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f10%2faws-chalice%2f&hashtags=AWS%2cAWSChalice%2cAWSLambda%2cAWSCloudFormation%2cAWSCodePipeline"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share AWS Chaliceを使ってサーバレスアプリケーションを開発しよう on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f10%2faws-chalice%2f&title=AWS%20Chalice%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%82%b5%e3%83%bc%e3%83%90%e3%83%ac%e3%82%b9%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%82%92%e9%96%8b%e7%99%ba%e3%81%97%e3%82%88%e3%81%86&summary=AWS%20Chalice%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%82%b5%e3%83%bc%e3%83%90%e3%83%ac%e3%82%b9%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%82%92%e9%96%8b%e7%99%ba%e3%81%97%e3%82%88%e3%81%86&source=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f10%2faws-chalice%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share AWS Chaliceを使ってサーバレスアプリケーションを開発しよう on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f10%2faws-chalice%2f&title=AWS%20Chalice%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%82%b5%e3%83%bc%e3%83%90%e3%83%ac%e3%82%b9%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%82%92%e9%96%8b%e7%99%ba%e3%81%97%e3%82%88%e3%81%86"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share AWS Chaliceを使ってサーバレスアプリケーションを開発しよう on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f10%2faws-chalice%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share AWS Chaliceを使ってサーバレスアプリケーションを開発しよう on whatsapp" href="https://api.whatsapp.com/send?text=AWS%20Chalice%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%82%b5%e3%83%bc%e3%83%90%e3%83%ac%e3%82%b9%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%82%92%e9%96%8b%e7%99%ba%e3%81%97%e3%82%88%e3%81%86%20-%20https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f10%2faws-chalice%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share AWS Chaliceを使ってサーバレスアプリケーションを開発しよう on telegram" href="https://telegram.me/share/url?text=AWS%20Chalice%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%82%b5%e3%83%bc%e3%83%90%e3%83%ac%e3%82%b9%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%82%92%e9%96%8b%e7%99%ba%e3%81%97%e3%82%88%e3%81%86&url=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f10%2faws-chalice%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>© 2022 Satoshi Matsuzawa</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>