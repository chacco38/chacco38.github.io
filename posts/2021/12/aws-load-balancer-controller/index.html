<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>AWS Load Balancer Controller を使って ELB を Kubernetes のマニフェストファイルで管理しよう | クラウドCoEの何でも屋</title><meta name=keywords content="AWS,Kubernetes,Amazon EKS,Elastic Load Balancing(ELB)"><meta name=description content="はじめに みなさん、こんにちは。今回は Amazon Elastic Kubernetes Service(EKS) を利用する際に併せて利用したい AWS Load Balancer Controller のお話です。
みなさんは Amazon EKS を活用して Kubernetes クラスタを AWS 上で動かすとなった際に、他のマネージドサービスの利用はどうされていますか。もちろんすべて Kubernetes 上で動かしてシステムを完結させるという選択肢もあるかと思いますが、やはり多くの方が他の AWS のマネージドサービスの併用も検討されるのではないでしょうか。その一方で、これら併用環境のコード化 (IaC、Infrastructure as Code) を実現しようとすると、Kubernetes アプリケーションの管理は Helm で、AWS リソースの管理は Terraform で、などという別々のツールでの管理になってしまいがちです。
そんな悩みを解決する一つの手段が AWS Load Balancer Controller や AWS Controllers for Kubernetes といった Kubernetes クラスタ機能を拡張する各種コントローラの活用です。これらのコントローラを利用することで、AWS リソースについても Kubernetes マニフェストファイルで定義できるようになり、Kubernetes 側に運用管理を寄せてシンプル化することができます。
今回はそのうちの一つ、Elastic Load Balancing(ELB) を Kubernetes クラスタで管理できるようにする AWS Load Balancer Controller について、簡単なサンプルアプリケーションを交えて紹介していきたいと思います。これから Amazon EKS 上にアプリケーションを展開しようと考えている方は参考にしてみてはいかがでしょうか。
AWS Load Balancer Controller とは AWS Load Balancer Controller (旧AWS ALB Ingress Controller) は、ELB を Kubernetes クラスタから管理するためのコントローラです。このコントローラを活用することで、Kubernetes Ingress リソースとして L7 ロードバランサの Application Load Balancer(ALB) を、Kuberntes Service リソースとして L4 ロードバランサの Network Load Balancer(NLB) を利用することができるようになります。"><meta name=author content><link rel=canonical href=https://chacco38.github.io/posts/2021/12/aws-load-balancer-controller/><link crossorigin=anonymous href=/assets/css/stylesheet.min.317d4c109e98a8137e18d0fd1222603a2a157f4e40f59a79576eb3861cc09531.css integrity="sha256-MX1MEJ6YqBN+GND9EiJgOioVf05A9Zp5V26zhhzAlTE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://chacco38.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://chacco38.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://chacco38.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://chacco38.github.io/apple-touch-icon.png><link rel=mask-icon href=https://chacco38.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="AWS Load Balancer Controller を使って ELB を Kubernetes のマニフェストファイルで管理しよう"><meta property="og:description" content="はじめに みなさん、こんにちは。今回は Amazon Elastic Kubernetes Service(EKS) を利用する際に併せて利用したい AWS Load Balancer Controller のお話です。
みなさんは Amazon EKS を活用して Kubernetes クラスタを AWS 上で動かすとなった際に、他のマネージドサービスの利用はどうされていますか。もちろんすべて Kubernetes 上で動かしてシステムを完結させるという選択肢もあるかと思いますが、やはり多くの方が他の AWS のマネージドサービスの併用も検討されるのではないでしょうか。その一方で、これら併用環境のコード化 (IaC、Infrastructure as Code) を実現しようとすると、Kubernetes アプリケーションの管理は Helm で、AWS リソースの管理は Terraform で、などという別々のツールでの管理になってしまいがちです。
そんな悩みを解決する一つの手段が AWS Load Balancer Controller や AWS Controllers for Kubernetes といった Kubernetes クラスタ機能を拡張する各種コントローラの活用です。これらのコントローラを利用することで、AWS リソースについても Kubernetes マニフェストファイルで定義できるようになり、Kubernetes 側に運用管理を寄せてシンプル化することができます。
今回はそのうちの一つ、Elastic Load Balancing(ELB) を Kubernetes クラスタで管理できるようにする AWS Load Balancer Controller について、簡単なサンプルアプリケーションを交えて紹介していきたいと思います。これから Amazon EKS 上にアプリケーションを展開しようと考えている方は参考にしてみてはいかがでしょうか。
AWS Load Balancer Controller とは AWS Load Balancer Controller (旧AWS ALB Ingress Controller) は、ELB を Kubernetes クラスタから管理するためのコントローラです。このコントローラを活用することで、Kubernetes Ingress リソースとして L7 ロードバランサの Application Load Balancer(ALB) を、Kuberntes Service リソースとして L4 ロードバランサの Network Load Balancer(NLB) を利用することができるようになります。"><meta property="og:type" content="article"><meta property="og:url" content="https://chacco38.github.io/posts/2021/12/aws-load-balancer-controller/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-14T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-14T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS Load Balancer Controller を使って ELB を Kubernetes のマニフェストファイルで管理しよう"><meta name=twitter:description content="はじめに みなさん、こんにちは。今回は Amazon Elastic Kubernetes Service(EKS) を利用する際に併せて利用したい AWS Load Balancer Controller のお話です。
みなさんは Amazon EKS を活用して Kubernetes クラスタを AWS 上で動かすとなった際に、他のマネージドサービスの利用はどうされていますか。もちろんすべて Kubernetes 上で動かしてシステムを完結させるという選択肢もあるかと思いますが、やはり多くの方が他の AWS のマネージドサービスの併用も検討されるのではないでしょうか。その一方で、これら併用環境のコード化 (IaC、Infrastructure as Code) を実現しようとすると、Kubernetes アプリケーションの管理は Helm で、AWS リソースの管理は Terraform で、などという別々のツールでの管理になってしまいがちです。
そんな悩みを解決する一つの手段が AWS Load Balancer Controller や AWS Controllers for Kubernetes といった Kubernetes クラスタ機能を拡張する各種コントローラの活用です。これらのコントローラを利用することで、AWS リソースについても Kubernetes マニフェストファイルで定義できるようになり、Kubernetes 側に運用管理を寄せてシンプル化することができます。
今回はそのうちの一つ、Elastic Load Balancing(ELB) を Kubernetes クラスタで管理できるようにする AWS Load Balancer Controller について、簡単なサンプルアプリケーションを交えて紹介していきたいと思います。これから Amazon EKS 上にアプリケーションを展開しようと考えている方は参考にしてみてはいかがでしょうか。
AWS Load Balancer Controller とは AWS Load Balancer Controller (旧AWS ALB Ingress Controller) は、ELB を Kubernetes クラスタから管理するためのコントローラです。このコントローラを活用することで、Kubernetes Ingress リソースとして L7 ロードバランサの Application Load Balancer(ALB) を、Kuberntes Service リソースとして L4 ロードバランサの Network Load Balancer(NLB) を利用することができるようになります。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://chacco38.github.io/posts/"},{"@type":"ListItem","position":2,"name":"AWS Load Balancer Controller を使って ELB を Kubernetes のマニフェストファイルで管理しよう","item":"https://chacco38.github.io/posts/2021/12/aws-load-balancer-controller/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"AWS Load Balancer Controller を使って ELB を Kubernetes のマニフェストファイルで管理しよう","name":"AWS Load Balancer Controller を使って ELB を Kubernetes のマニフェストファイルで管理しよう","description":"はじめに みなさん、こんにちは。今回は Amazon Elastic Kubernetes Service(EKS) を利用する際に併せて利用したい AWS Load Balancer Controller のお話です。\nみなさんは Amazon EKS を活用して Kubernetes クラスタを AWS 上で動かすとなった際に、他のマネージドサービスの利用はどうされていますか。もちろんすべて Kubernetes 上で動かしてシステムを完結させるという選択肢もあるかと思いますが、やはり多くの方が他の AWS のマネージドサービスの併用も検討されるのではないでしょうか。その一方で、これら併用環境のコード化 (IaC、Infrastructure as Code) を実現しようとすると、Kubernetes アプリケーションの管理は Helm で、AWS リソースの管理は Terraform で、などという別々のツールでの管理になってしまいがちです。\nそんな悩みを解決する一つの手段が AWS Load Balancer Controller や AWS Controllers for Kubernetes といった Kubernetes クラスタ機能を拡張する各種コントローラの活用です。これらのコントローラを利用することで、AWS リソースについても Kubernetes マニフェストファイルで定義できるようになり、Kubernetes 側に運用管理を寄せてシンプル化することができます。\n今回はそのうちの一つ、Elastic Load Balancing(ELB) を Kubernetes クラスタで管理できるようにする AWS Load Balancer Controller について、簡単なサンプルアプリケーションを交えて紹介していきたいと思います。これから Amazon EKS 上にアプリケーションを展開しようと考えている方は参考にしてみてはいかがでしょうか。\nAWS Load Balancer Controller とは AWS Load Balancer Controller (旧AWS ALB Ingress Controller) は、ELB を Kubernetes クラスタから管理するためのコントローラです。このコントローラを活用することで、Kubernetes Ingress リソースとして L7 ロードバランサの Application Load Balancer(ALB) を、Kuberntes Service リソースとして L4 ロードバランサの Network Load Balancer(NLB) を利用することができるようになります。","keywords":["AWS","Kubernetes","Amazon EKS","Elastic Load Balancing(ELB)"],"articleBody":"はじめに みなさん、こんにちは。今回は Amazon Elastic Kubernetes Service(EKS) を利用する際に併せて利用したい AWS Load Balancer Controller のお話です。\nみなさんは Amazon EKS を活用して Kubernetes クラスタを AWS 上で動かすとなった際に、他のマネージドサービスの利用はどうされていますか。もちろんすべて Kubernetes 上で動かしてシステムを完結させるという選択肢もあるかと思いますが、やはり多くの方が他の AWS のマネージドサービスの併用も検討されるのではないでしょうか。その一方で、これら併用環境のコード化 (IaC、Infrastructure as Code) を実現しようとすると、Kubernetes アプリケーションの管理は Helm で、AWS リソースの管理は Terraform で、などという別々のツールでの管理になってしまいがちです。\nそんな悩みを解決する一つの手段が AWS Load Balancer Controller や AWS Controllers for Kubernetes といった Kubernetes クラスタ機能を拡張する各種コントローラの活用です。これらのコントローラを利用することで、AWS リソースについても Kubernetes マニフェストファイルで定義できるようになり、Kubernetes 側に運用管理を寄せてシンプル化することができます。\n今回はそのうちの一つ、Elastic Load Balancing(ELB) を Kubernetes クラスタで管理できるようにする AWS Load Balancer Controller について、簡単なサンプルアプリケーションを交えて紹介していきたいと思います。これから Amazon EKS 上にアプリケーションを展開しようと考えている方は参考にしてみてはいかがでしょうか。\nAWS Load Balancer Controller とは AWS Load Balancer Controller (旧AWS ALB Ingress Controller) は、ELB を Kubernetes クラスタから管理するためのコントローラです。このコントローラを活用することで、Kubernetes Ingress リソースとして L7 ロードバランサの Application Load Balancer(ALB) を、Kuberntes Service リソースとして L4 ロードバランサの Network Load Balancer(NLB) を利用することができるようになります。\nKubernetes Service/Ingress リソースでの処理を外部ロードバランサである ELB へ切り出すことによって、ワークロードへの性能影響の低減、ノードリソースの利用効率の向上、Service/Ingress リソースのスケーリングなどを AWS 側へ任せることで運用負荷の低減といったことができる見込みです。\nhttps://github.com/kubernetes-sigs/aws-load-balancer-controller\nAWS Load Balancer Controller を導入してみよう Step1. 作業環境の設定 今回は Amazon EKS や AWS Load Balancer Controller の管理を行う環境として AWS CloudShell を利用していきたいと思います。まずは操作に必要な各種ツールの設定を AWS CloudShell にしてきましょう。\nAWS CLI の設定 AWS リソースの操作を行えるように次のコマンドを実行し、AWS CLI の設定を行いましょう。\nAWS CLIの設定 aws configure  kubectl コマンドのインストール 次に Kubernetes 管理ツールの kubectl コマンドをインストールしましょう。\nhttps://docs.aws.amazon.com/ja_jp/eks/latest/userguide/install-kubectl.html#linux\nkubectlコマンドのインストール # kubectl コマンドのダウンロード curl -o kubectl https://amazon-eks.s3.us-west-2.amazonaws.com/1.21.2/2021-07-05/bin/linux/amd64/kubectl  # 実行権限の付与 chmod +x kubectl  # 実行ファイルのパスを設定 mkdir -p ${HOME}/bin \u0026\u0026 mv kubectl ${HOME}/bin \u0026\u0026 export PATH=${PATH}:${HOME}/bin  # シェルの起動時に $HOME/bin をパスへ追加 echo 'export PATH=${PATH}:${HOME}/bin'  ~/.bashrc  # インストールが成功していることを確認 kubectl version --short --client  インストールに成功していれば出力例のようにバージョン情報の出力を確認できます。\n出力例 $ kubectl version --short --client Client Version: v1.21.2-13+d2965f0db10712  eksctl コマンドのインストール 続いて Amazon EKS 管理ツールの eksctl コマンドをインストールしましょう。\nhttps://docs.aws.amazon.com/ja_jp/eks/latest/userguide/eksctl.html#linux\neksctlコマンドのインストール # eksctl の最新バージョンをダウンロード curl -L \"https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz\" | tar xz -C /tmp  # 実行ファイルをパスの通ったディレクトリへ移動 mv /tmp/eksctl ${HOME}/bin  # インストールが成功していることを確認 eksctl version  インストールに成功していれば出力例のようにバージョン情報の出力を確認できます。\n出力例 $ eksctl version 0.76.0  helm コマンドのインストール 最後に Kubernetes 上で稼働するアプリケーションを管理するためのツールである helm コマンドをインストールしましょう。\nhttps://docs.aws.amazon.com/ja_jp/eks/latest/userguide/helm.html\nhelmコマンドのインストール # 前提パッケージのインストール sudo yum install -y openssl  # インストールスクリプトのダウンロード curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3  get_helm.sh  # 実行権限の付与 chmod 700 get_helm.sh  # インストールスクリプトの実行 ./get_helm.sh  # インストールが成功していることを確認 helm version --short  インストールに成功していれば出力例のようにバージョン情報の出力を確認できます。\n出力例 $ helm version --short v3.7.2+g663a896  以上で作業環境(AWS CloudShell)の設定は完了です。\nStep2. EKS クラスタの作成 続いて AWS Load Balancer Controller を導入する対象の Amazon EKS クラスタを作成していきましょう。今回は Kubernetes ノードには AWS Fargate を使用していきたいと思います。それでは eksctl コマンドを実行してクラスタを作成しましょう。\nhttps://docs.aws.amazon.com/ja_jp/eks/latest/userguide/getting-started-eksctl.html\nEKSクラスタの作成 # 環境変数の設定 export CLUSTER=\"my-tokyo-cluster\"  # EKS クラスタの作成 eksctl create cluster --name ${CLUSTER} --version 1.21 --fargate  # サービスアカウントでの IAM ロール使用を許可 eksctl utils associate-iam-oidc-provider --cluster ${CLUSTER} --approve  ここまで終わりましたら AWS Load Balancer Controller を利用するための事前準備は完了です。\nStep3. コントローラのデプロイ それでは AWS Load Balancer Controller を Amazon EKS クラスタにデプロイしていきましょう。\nhttps://docs.aws.amazon.com/ja_jp/eks/latest/userguide/aws-load-balancer-controller.html\nサービスアカウントの作成 まずは AWS Load Balancer Controller 用のサービスアカウントの作成を行っていきます。今回は kube-system Namespace に aws-load-balancer-controller という名前でサービスアカウントを作成して行きたいと思います。それでは次のコマンドを実行してサービスアカウントを作成しましょう。\nサービスアカウントの作成 AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query \"Account\" --output text) POLICY_NAME=\"myAWSLoadBalancerControllerIAMPolicy\" SERVICE_ACCOUNT=\"aws-load-balancer-controller\"  # IAM ポリシー定義ファイルのダウンロード curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/main/docs/install/iam_policy.json  # IAM ポリシーの作成 aws iam create-policy \\  --policy-name ${POLICY_NAME} \\  --policy-document file://iam_policy.json  # サービスアカウントの作成 eksctl create iamserviceaccount \\  --name=${SERVICE_ACCOUNT} \\  --cluster=${CLUSTER} \\  --namespace=\"kube-system\" \\  --attach-policy-arn=arn:aws:iam::${AWS_ACCOUNT_ID}:policy/${POLICY_NAME} \\  --override-existing-serviceaccounts \\  --approve  コントローラのインストール 次に AWS Load Balancer Controller をインストールしていきましょう。なお、AWS Load Balancer Controller のインストール方法はいくつか用意されていますが、AWS Fargate 環境の場合は Helm を利用したインストール方法を選択する必要があるためご注意ください。\nコントローラのインストール # EKS 用の Helm レポジトリを追加 helm repo add eks https://aws.github.io/eks-charts  # TargetGroupBinding カスタムリソースをインストール kubectl apply -k \"github.com/aws/eks-charts/stable/aws-load-balancer-controller//crds?ref=master\"  # Helm チャートからインストール helm install aws-load-balancer-controller eks/aws-load-balancer-controller \\  --set clusterName=${CLUSTER} \\  --set serviceAccount.create=false \\  --set vpcId=$(aws cloudformation describe-stacks \\  --stack-name \"eksctl-${CLUSTER}-cluster\" \\  --query 'Stacks[0].Outputs[?OutputKey==`VPC`].OutputValue' \\  --output text) \\  --set serviceAccount.name=${SERVICE_ACCOUNT} \\  -n kube-system  # 確認 kubectl get deployment -n kube-system aws-load-balancer-controller  インストールに成功していれば出力例のようにコントローラが一覧に表示されるようになります。\n出力例 $ kubectl get deployment -n kube-system aws-load-balancer-controller NAME READY UP-TO-DATE AVAILABLE AGE aws-load-balancer-controller 2/2 2 2 42s  以上で AWS Load Balancer Controller の導入は完了です。\nAWS Load Balancer Controller を使ってみよう Network Load Balancer (Serviceリソース) の使い方 AWS Load Balancer Controller 環境では、次のサンプルのように Kubernetes Service リソース定義にて「LoadBalancer タイプの指定」と「アノテーションとして各種パラメータを指定」をすることによって Network Load Balancer(NLB) をプロビジョニングすることができます。\nhttps://docs.aws.amazon.com/ja_jp/eks/latest/userguide/network-load-balancing.html\nServiceリソース定義サンプル apiVersion: v1 kind: Service metadata:  name: sample-service  annotations:  service.beta.kubernetes.io/aws-load-balancer-type: external  service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing  service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip spec:  type: LoadBalancer  ports:  - port: 80  protocol: TCP  selector:  app: sample-app  アノテーションに指定する主要なパラメータとしては次の通りです。アノテーションに指定可能なパラメータの一覧につきましては次の URL を参照してください。\nhttps://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.3/guide/service/annotations/\n   アノテーション名 説明     service.beta.kubernetes.io/aws-load-balancer-type ロードバランサのプロビジョニングに使用するコントローラを指定します。AWS Load Balancer Controller の場合は “external” を指定します。   service.beta.kubernetes.io/aws-load-balancer-scheme ロードバランサのスキームを指定します。内部向けの場合は “internal\"、インターネット向けの場合は “internet-facing” を指定します。   service.beta.kubernetes.io/aws-load-balancer-nlb-target-type バックエンドに指定するターゲットタイプを指定します。トラフィックを直接 Pod にルーティングするには “ip” を指定します。   service.beta.kubernetes.io/aws-load-balancer-healthcheck-port バックエンドのヘルスチェック用ポート(”traffic-port\"/\"ポート番号\")を指定します。デフォルトは “traffic-port” です。   service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol バックエンドのヘルスチェック用プロトコル(\"tcp\"/\"http\"/\"https\")を指定します。デフォルトは “tcp” です。   service.beta.kubernetes.io/aws-load-balancer-healthcheck-path バックエンドの HTTP/HTTPS ヘルスチェック用パスを指定します。デフォルトは “/” です。    NLB Service のサンプル それではサンプルアプリケーションをデプロイして NLB Service リソースを実際に動かしてみましょう。今回は次のサンプルアプリケーションをベースに少しだけ手を加えたものを用いて動作確認をしていきたいと思います。\nhttps://github.com/istio/istio/tree/master/samples/helloworld\nhelloworld-nlb-sample.yaml（サンプルアプリケーション定義ファイル） apiVersion: v1 kind: Service metadata:  name: helloworld  labels:  app: helloworld  annotations:  service.beta.kubernetes.io/aws-load-balancer-type: external  service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing  service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip  service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol: http  service.beta.kubernetes.io/aws-load-balancer-healthcheck-path: /health spec:  type: LoadBalancer  ports:  - port: 80  targetPort: 5000  name: http  selector:  app: helloworld --- apiVersion: apps/v1 kind: Deployment metadata:  name: helloworld-v1  labels:  app: helloworld  version: v1 spec:  replicas: 1  selector:  matchLabels:  app: helloworld  version: v1  template:  metadata:  labels:  app: helloworld  version: v1  spec:  containers:  - name: helloworld  image: docker.io/istio/examples-helloworld-v1  ports:  - containerPort: 5000  それでは次のコマンドを実行してサンプルアプリケーションをデプロイしていきましょう。\nサンプルアプリケーションのデプロイ export FARGATEPROFILE=\"sample-app\" export NAMESPACE=\"sample\"  # Fargate プロファイルの作成 eksctl create fargateprofile --cluster ${CLUSTER} --name ${FARGATEPROFILE} --namespace ${NAMESPACE}  # サンプルアプリケーション用 Namespace の作成 kubectl create namespace ${NAMESPACE}  # サンプルアプリケーションのデプロイ kubectl apply -n ${NAMESPACE} -f helloworld-nlb-sample.yaml  # サービスがデプロイされたことを確認 kubectl get -n ${NAMESPACE} service helloworld  NLB Service のデプロイに成功した場合は次の出力例のように Service リソース一覧に表示されます。\n出力例 $ kubectl get -n ${NAMESPACE} service helloworld NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE helloworld LoadBalancer 10.100.114.79 k8s-sample-hellowor-xxxxxxxxxx-xxxxxxxxxxxxxxxx.elb.ap-northeast-1.amazonaws.com 80:32642/TCP 32h  NLB のヘルスチェックが正常になるまで数分待った後、NLB のパブリックエンドポイントにアクセスしてみましょう。\nサンプルアプリケーションへアクセス # NLB の DNS 名を取得 ENDPOINT=$(kubectl get -n ${NAMESPACE} service helloworld \\  -o custom-columns=HOSTNAME:status.loadBalancer.ingress[0].hostname \\  --no-headers)  # テストの実行 curl http://${ENDPOINT}/hello  期待通りのレスポンスが返ってくることが確認できたら成功です。\nサンプルアプリケーション出力例 $ curl http://${ENDPOINT}/hello Hello version: v1, instance: helloworld-v1-b9d9d6679-hdqsq  最後にサンプルアプリケーションを削除して動作確認は終了です。お疲れ様でした。\nサンプルアプリケーションの削除 kubectl delete namespace ${NAMESPACE}  Application Load Balancer (Ingressリソース) の使い方 AWS Load Balancer Controller 環境では、次のサンプルのように「Kubernetes IngressClass リソースにてコントローラの指定」を、「Kubernetes Ingress リソース定義のアノテーションとして各種パラメータを指定」をすることによって Application Load Balancer(ALB) をプロビジョニングすることができます。\nhttps://docs.aws.amazon.com/ja_jp/eks/latest/userguide/alb-ingress.html\nwarn Kubernetes Ingress リソースのアノテーションに kubernetes.io/ingress.class: alb を指定することでも作成できますが、Kubernetes 1.18 以降は kubernetes.io/ingress.class の利用は非推奨となっておりますのでご注意ください。\n Ingressリソース定義サンプル apiVersion: networking.k8s.io/v1 kind: IngressClass metadata:  name: sample-ingress-class spec:  controller: ingress.k8s.aws/alb --- apiVersion: networking.k8s.io/v1 kind: Ingress metadata:  name: sample-ingress  annotations:  alb.ingress.kubernetes.io/scheme: internet-facing  alb.ingress.kubernetes.io/target-type: ip spec:  ingressClassName: sample-ingress-class  rules:  - http:  paths:  - path: /hello  pathType: Exact  backend:  service:  name: sample-service  port:  number: 80  アノテーションに指定する主要なパラメータとしては次の通りです。なお、ALB Ingress は AWS WAF や AWS Shield による脅威からの保護、Amazon Cognito 認証などさまざまなマネージドサービスとの連携が可能です。アノテーションに指定可能なパラメータの一覧につきましては次の URL を参照してください。\nhttps://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.3/guide/ingress/annotations/\n   アノテーション名 説明     alb.ingress.kubernetes.io/group.name 複数の Ingress リソースを 1 つの ALB に統合する際にグループ名を指定します。   alb.ingress.kubernetes.io/scheme ロードバランサのスキームを指定します。内部向けの場合は “internal\"、インターネット向けの場合は “internet-facing” を指定します。   alb.ingress.kubernetes.io/listen-ports ロードバランサの受付ポートを指定します。デフォルトは ’[{“HTTP”: 80}]’ | ‘[{“HTTPS”: 443}]’ です。   alb.ingress.kubernetes.io/target-type バックエンドに指定するターゲットタイプを指定します。トラフィックを直接 Pod にルーティングするには “ip” を指定します。   alb.ingress.kubernetes.io/healthcheck-port バックエンドのヘルスチェック用ポート(”traffic-port\"/\"ポート番号\")を指定します。デフォルトは “traffic-port” です。   alb.ingress.kubernetes.io/healthcheck-protocol バックエンドのヘルスチェック用プロトコル(\"http\"/\"https\")を指定します。デフォルトは “http” です。   alb.ingress.kubernetes.io/healthcheck-path バックエンドの HTTP/HTTPS ヘルスチェック用パスを指定します。デフォルトは “/” です。    ALB Ingress のサンプル それではサンプルアプリケーションをデプロイして ALB Ingress リソースを実際に動かしてみましょう。今回は次のサンプルアプリケーションをベースに少しだけ手を加えたものを用いて動作確認をしていきたいと思います。\nhttps://github.com/istio/istio/tree/master/samples/helloworld\nhelloworld-alb-sample.yaml（サンプルアプリケーション定義ファイル） apiVersion: networking.k8s.io/v1 kind: IngressClass metadata:  name: alb-ingress spec:  controller: ingress.k8s.aws/alb --- apiVersion: networking.k8s.io/v1 kind: Ingress metadata:  name: helloworld  annotations:  alb.ingress.kubernetes.io/scheme: internet-facing  alb.ingress.kubernetes.io/target-type: ip  alb.ingress.kubernetes.io/healthcheck-path: /health spec:  ingressClassName: alb-ingress  rules:  - http:  paths:  - path: /hello  pathType: Exact  backend:  service:  name: helloworld  port:  number: 80 --- apiVersion: v1 kind: Service metadata:  name: helloworld  labels:  app: helloworld  service: helloworld spec:  ports:  - port: 80  targetPort: 5000  name: http  selector:  app: helloworld --- apiVersion: apps/v1 kind: Deployment metadata:  name: helloworld-v1  labels:  app: helloworld  version: v1 spec:  replicas: 1  selector:  matchLabels:  app: helloworld  version: v1  template:  metadata:  labels:  app: helloworld  version: v1  spec:  containers:  - name: helloworld  image: docker.io/istio/examples-helloworld-v1  ports:  - containerPort: 5000  それでは次のコマンドを実行してサンプルアプリケーションをデプロイしていきましょう。\nサンプルアプリケーションのデプロイ export FARGATEPROFILE=\"sample-app\" export NAMESPACE=\"sample\"  # Fargate プロファイルの作成 eksctl create fargateprofile --cluster ${CLUSTER} --name ${FARGATEPROFILE} --namespace ${NAMESPACE}  # サンプルアプリケーション用 Namespace の作成 kubectl create namespace ${NAMESPACE}  # サンプルアプリケーションのデプロイ kubectl apply -n ${NAMESPACE} -f helloworld-alb-sample.yaml  # Ingress がデプロイされたことを確認 kubectl get -n ${NAMESPACE} ingress helloworld  ALB Ingress のデプロイに成功した場合は次の出力例のように Ingress リソース一覧に表示されます。\n出力例 $ kubectl get -n ${NAMESPACE} ingress helloworld NAME CLASS HOSTS ADDRESS PORTS AGE helloworld  * k8s-sample-hellowor-xxxxxxxxxx-xxxxxxxx.ap-northeast-1.elb.amazonaws.com 80 70s  DNS への登録などが反映されるまで数分待った後、ALB のパブリックエンドポイントにアクセスしてみましょう。\nサンプルアプリケーションへアクセス # NLB の DNS 名を取得 ENDPOINT=$(kubectl get -n ${NAMESPACE} ingress helloworld \\  -o custom-columns=HOSTNAME:status.loadBalancer.ingress[0].hostname \\  --no-headers)  # テストの実行 curl http://${ENDPOINT}/hello  期待通りのレスポンスが返ってくることが確認できたら成功です。\nサンプルアプリケーション出力例 $ curl http://${ENDPOINT}/hello Hello version: v1, instance: helloworld-v1-b9d9d6679-rpfzl  最後にサンプルアプリケーションを削除して動作確認は終了です。お疲れ様でした。\nサンプルアプリケーションの削除 kubectl delete namespace ${NAMESPACE}  終わりに 今回は Amazon Elastic Kubernetes Service(EKS) を利用する際に併せて利用したい AWS Load Balancer Controller のご紹介でしたが、いかがだったでしょうか？\n今回は IaC を実現する 1 つの手段として、というカットでの紹介でしたが Kubernetes Ingress/Service リソースを ELB にすることでさまざまなメリットが期待できますので、Amazon EKS をご利用の際は AWS Load Balancer Controller の併用も視野に入れてみてはいかがでしょうか。\nなお、今回は紹介しませんでしたが AWS Load Balancer Controller は使いたいけれど、ELB リソースのライフサイクルは Kubernetes からは切り離したいというケースもあるかと思います。そういった場合は AWS Load Balancer Controller の TargetGroupBinding 機能を利用することで実現可能なので参考にしていただければと思います。TargetGroupBinding 機能の詳細については公式ドキュメントを参照してください。\nhttps://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.3/guide/targetgroupbinding/targetgroupbinding/\n以上、Kubernetes Service/Ingress リソースと Elastic Load Balancing(ELB) との統合を実現する「AWS Load Balancer Controller」のご紹介でした。\n  AWS は、米国その他の諸国における Amazon.com, Inc. またはその関連会社の商標です。 Kubernetes は、The Linux Foundation の米国およびその他の国における登録商標または商標です。 その他、本資料に記述してある会社名、製品名は、各社の登録商品または商標です。  ","wordCount":"1204","inLanguage":"en","datePublished":"2021-12-14T00:00:00Z","dateModified":"2021-12-14T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://chacco38.github.io/posts/2021/12/aws-load-balancer-controller/"},"publisher":{"@type":"Organization","name":"クラウドCoEの何でも屋","logo":{"@type":"ImageObject","url":"https://chacco38.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://chacco38.github.io/ accesskey=h title="クラウドCoEの何でも屋 (Alt + H)">クラウドCoEの何でも屋</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://chacco38.github.io/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://chacco38.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://chacco38.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://chacco38.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://chacco38.github.io/posts/>Posts</a></div><h1 class=post-title>AWS Load Balancer Controller を使って ELB を Kubernetes のマニフェストファイルで管理しよう</h1><div class=post-meta><span title="2021-12-14 00:00:00 +0000 UTC">December 14, 2021</span>&nbsp;·&nbsp;6 min&nbsp;|&nbsp;<a href=https://github.com/chacco38/chacco38.github.io/tree/main/content/posts/2021/12/aws-load-balancer-controller/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e3%81%af%e3%81%98%e3%82%81%e3%81%ab aria-label=はじめに>はじめに</a></li><li><a href=#aws-load-balancer-controller-%e3%81%a8%e3%81%af aria-label="AWS Load Balancer Controller とは">AWS Load Balancer Controller とは</a></li><li><a href=#aws-load-balancer-controller-%e3%82%92%e5%b0%8e%e5%85%a5%e3%81%97%e3%81%a6%e3%81%bf%e3%82%88%e3%81%86 aria-label="AWS Load Balancer Controller を導入してみよう">AWS Load Balancer Controller を導入してみよう</a><ul><li><a href=#step1-%e4%bd%9c%e6%a5%ad%e7%92%b0%e5%a2%83%e3%81%ae%e8%a8%ad%e5%ae%9a aria-label="Step1. 作業環境の設定">Step1. 作業環境の設定</a><ul><li><a href=#aws-cli-%e3%81%ae%e8%a8%ad%e5%ae%9a aria-label="AWS CLI の設定">AWS CLI の設定</a></li><li><a href=#kubectl-%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89%e3%81%ae%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab aria-label="kubectl コマンドのインストール">kubectl コマンドのインストール</a></li><li><a href=#eksctl-%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89%e3%81%ae%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab aria-label="eksctl コマンドのインストール">eksctl コマンドのインストール</a></li><li><a href=#helm-%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89%e3%81%ae%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab aria-label="helm コマンドのインストール">helm コマンドのインストール</a></li></ul></li><li><a href=#step2-eks-%e3%82%af%e3%83%a9%e3%82%b9%e3%82%bf%e3%81%ae%e4%bd%9c%e6%88%90 aria-label="Step2. EKS クラスタの作成">Step2. EKS クラスタの作成</a></li><li><a href=#step3-%e3%82%b3%e3%83%b3%e3%83%88%e3%83%ad%e3%83%bc%e3%83%a9%e3%81%ae%e3%83%87%e3%83%97%e3%83%ad%e3%82%a4 aria-label="Step3. コントローラのデプロイ">Step3. コントローラのデプロイ</a><ul><li><a href=#%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e3%82%a2%e3%82%ab%e3%82%a6%e3%83%b3%e3%83%88%e3%81%ae%e4%bd%9c%e6%88%90 aria-label=サービスアカウントの作成>サービスアカウントの作成</a></li><li><a href=#%e3%82%b3%e3%83%b3%e3%83%88%e3%83%ad%e3%83%bc%e3%83%a9%e3%81%ae%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab aria-label=コントローラのインストール>コントローラのインストール</a></li></ul></li></ul></li><li><a href=#aws-load-balancer-controller-%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%81%bf%e3%82%88%e3%81%86 aria-label="AWS Load Balancer Controller を使ってみよう">AWS Load Balancer Controller を使ってみよう</a><ul><li><a href=#network-load-balancer-service%e3%83%aa%e3%82%bd%e3%83%bc%e3%82%b9-%e3%81%ae%e4%bd%bf%e3%81%84%e6%96%b9 aria-label="Network Load Balancer (Serviceリソース) の使い方">Network Load Balancer (Serviceリソース) の使い方</a><ul><li><a href=#nlb-service-%e3%81%ae%e3%82%b5%e3%83%b3%e3%83%97%e3%83%ab aria-label="NLB Service のサンプル">NLB Service のサンプル</a></li></ul></li><li><a href=#application-load-balancer-ingress%e3%83%aa%e3%82%bd%e3%83%bc%e3%82%b9-%e3%81%ae%e4%bd%bf%e3%81%84%e6%96%b9 aria-label="Application Load Balancer (Ingressリソース) の使い方">Application Load Balancer (Ingressリソース) の使い方</a><ul><li><a href=#alb-ingress-%e3%81%ae%e3%82%b5%e3%83%b3%e3%83%97%e3%83%ab aria-label="ALB Ingress のサンプル">ALB Ingress のサンプル</a></li></ul></li></ul></li><li><a href=#%e7%b5%82%e3%82%8f%e3%82%8a%e3%81%ab aria-label=終わりに>終わりに</a></li></ul></div></details></div><div class=post-content><h1 id=はじめに>はじめに<a hidden class=anchor aria-hidden=true href=#はじめに>#</a></h1><p>みなさん、こんにちは。今回は Amazon Elastic Kubernetes Service(EKS) を利用する際に併せて利用したい AWS Load Balancer Controller のお話です。</p><p>みなさんは Amazon EKS を活用して Kubernetes クラスタを AWS 上で動かすとなった際に、他のマネージドサービスの利用はどうされていますか。もちろんすべて Kubernetes 上で動かしてシステムを完結させるという選択肢もあるかと思いますが、やはり多くの方が他の AWS のマネージドサービスの併用も検討されるのではないでしょうか。その一方で、これら併用環境のコード化 (IaC、Infrastructure as Code) を実現しようとすると、Kubernetes アプリケーションの管理は Helm で、AWS リソースの管理は Terraform で、などという別々のツールでの管理になってしまいがちです。</p><p>そんな悩みを解決する一つの手段が AWS Load Balancer Controller や AWS Controllers for Kubernetes といった Kubernetes クラスタ機能を拡張する各種コントローラの活用です。これらのコントローラを利用することで、AWS リソースについても Kubernetes マニフェストファイルで定義できるようになり、Kubernetes 側に運用管理を寄せてシンプル化することができます。</p><p>今回はそのうちの一つ、Elastic Load Balancing(ELB) を Kubernetes クラスタで管理できるようにする AWS Load Balancer Controller について、簡単なサンプルアプリケーションを交えて紹介していきたいと思います。これから Amazon EKS 上にアプリケーションを展開しようと考えている方は参考にしてみてはいかがでしょうか。</p><h1 id=aws-load-balancer-controller-とは>AWS Load Balancer Controller とは<a hidden class=anchor aria-hidden=true href=#aws-load-balancer-controller-とは>#</a></h1><p>AWS Load Balancer Controller (旧AWS ALB Ingress Controller) は、ELB を Kubernetes クラスタから管理するためのコントローラです。このコントローラを活用することで、Kubernetes Ingress リソースとして L7 ロードバランサの Application Load Balancer(ALB) を、Kuberntes Service リソースとして L4 ロードバランサの Network Load Balancer(NLB) を利用することができるようになります。</p><p>Kubernetes Service/Ingress リソースでの処理を外部ロードバランサである ELB へ切り出すことによって、ワークロードへの性能影響の低減、ノードリソースの利用効率の向上、Service/Ingress リソースのスケーリングなどを AWS 側へ任せることで運用負荷の低減といったことができる見込みです。</p><p><a href=https://github.com/kubernetes-sigs/aws-load-balancer-controller>https://github.com/kubernetes-sigs/aws-load-balancer-controller</a></p><h1 id=aws-load-balancer-controller-を導入してみよう>AWS Load Balancer Controller を導入してみよう<a hidden class=anchor aria-hidden=true href=#aws-load-balancer-controller-を導入してみよう>#</a></h1><h2 id=step1-作業環境の設定>Step1. 作業環境の設定<a hidden class=anchor aria-hidden=true href=#step1-作業環境の設定>#</a></h2><p>今回は Amazon EKS や AWS Load Balancer Controller の管理を行う環境として AWS CloudShell を利用していきたいと思います。まずは操作に必要な各種ツールの設定を AWS CloudShell にしてきましょう。</p><h3 id=aws-cli-の設定>AWS CLI の設定<a hidden class=anchor aria-hidden=true href=#aws-cli-の設定>#</a></h3><p>AWS リソースの操作を行えるように次のコマンドを実行し、AWS CLI の設定を行いましょう。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>AWS CLIの設定</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws configure</span></span></code></pre></div></div></figure><h3 id=kubectl-コマンドのインストール>kubectl コマンドのインストール<a hidden class=anchor aria-hidden=true href=#kubectl-コマンドのインストール>#</a></h3><p>次に Kubernetes 管理ツールの <code>kubectl</code> コマンドをインストールしましょう。</p><p><a href=https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/install-kubectl.html#linux>https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/install-kubectl.html#linux</a></p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>kubectlコマンドのインストール</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># kubectl コマンドのダウンロード</span>
</span></span><span style=display:flex><span>curl -o kubectl https://amazon-eks.s3.us-west-2.amazonaws.com/1.21.2/2021-07-05/bin/linux/amd64/kubectl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 実行権限の付与</span>
</span></span><span style=display:flex><span>chmod +x kubectl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 実行ファイルのパスを設定</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>${</span>HOME<span style=color:#e6db74>}</span>/bin <span style=color:#f92672>&amp;&amp;</span> mv kubectl <span style=color:#e6db74>${</span>HOME<span style=color:#e6db74>}</span>/bin <span style=color:#f92672>&amp;&amp;</span> export PATH<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>PATH<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>HOME<span style=color:#e6db74>}</span>/bin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># シェルの起動時に $HOME/bin をパスへ追加</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;export PATH=${PATH}:${HOME}/bin&#39;</span> &gt;&gt; ~/.bashrc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># インストールが成功していることを確認</span>
</span></span><span style=display:flex><span>kubectl version --short --client</span></span></code></pre></div></div></figure><p>インストールに成功していれば出力例のようにバージョン情報の出力を確認できます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ kubectl version --short --client
</span></span><span style=display:flex><span>Client Version: v1.21.2-13+d2965f0db10712</span></span></code></pre></div></div></figure><h3 id=eksctl-コマンドのインストール>eksctl コマンドのインストール<a hidden class=anchor aria-hidden=true href=#eksctl-コマンドのインストール>#</a></h3><p>続いて Amazon EKS 管理ツールの <code>eksctl</code> コマンドをインストールしましょう。</p><p><a href=https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/eksctl.html#linux>https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/eksctl.html#linux</a></p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>eksctlコマンドのインストール</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eksctl の最新バージョンをダウンロード</span>
</span></span><span style=display:flex><span>curl -L <span style=color:#e6db74>&#34;https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_</span><span style=color:#66d9ef>$(</span>uname -s<span style=color:#66d9ef>)</span><span style=color:#e6db74>_amd64.tar.gz&#34;</span> | tar xz -C /tmp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 実行ファイルをパスの通ったディレクトリへ移動</span>
</span></span><span style=display:flex><span>mv /tmp/eksctl <span style=color:#e6db74>${</span>HOME<span style=color:#e6db74>}</span>/bin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># インストールが成功していることを確認</span>
</span></span><span style=display:flex><span>eksctl version</span></span></code></pre></div></div></figure><p>インストールに成功していれば出力例のようにバージョン情報の出力を確認できます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ eksctl version
</span></span><span style=display:flex><span>0.76.0</span></span></code></pre></div></div></figure><h3 id=helm-コマンドのインストール>helm コマンドのインストール<a hidden class=anchor aria-hidden=true href=#helm-コマンドのインストール>#</a></h3><p>最後に Kubernetes 上で稼働するアプリケーションを管理するためのツールである <code>helm</code> コマンドをインストールしましょう。</p><p><a href=https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/helm.html>https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/helm.html</a></p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>helmコマンドのインストール</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 前提パッケージのインストール</span>
</span></span><span style=display:flex><span>sudo yum install -y openssl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># インストールスクリプトのダウンロード</span>
</span></span><span style=display:flex><span>curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 &gt; get_helm.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 実行権限の付与</span>
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>700</span> get_helm.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># インストールスクリプトの実行</span>
</span></span><span style=display:flex><span>./get_helm.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># インストールが成功していることを確認</span>
</span></span><span style=display:flex><span>helm version --short</span></span></code></pre></div></div></figure><p>インストールに成功していれば出力例のようにバージョン情報の出力を確認できます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ helm version --short
</span></span><span style=display:flex><span>v3.7.2+g663a896</span></span></code></pre></div></div></figure><p>以上で作業環境(AWS CloudShell)の設定は完了です。</p><h2 id=step2-eks-クラスタの作成>Step2. EKS クラスタの作成<a hidden class=anchor aria-hidden=true href=#step2-eks-クラスタの作成>#</a></h2><p>続いて AWS Load Balancer Controller を導入する対象の Amazon EKS クラスタを作成していきましょう。今回は Kubernetes ノードには AWS Fargate を使用していきたいと思います。それでは <code>eksctl</code> コマンドを実行してクラスタを作成しましょう。</p><p><a href=https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/getting-started-eksctl.html>https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/getting-started-eksctl.html</a></p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>EKSクラスタの作成</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 環境変数の設定</span>
</span></span><span style=display:flex><span>export CLUSTER<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;my-tokyo-cluster&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># EKS クラスタの作成</span>
</span></span><span style=display:flex><span>eksctl create cluster --name <span style=color:#e6db74>${</span>CLUSTER<span style=color:#e6db74>}</span> --version 1.21 --fargate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># サービスアカウントでの IAM ロール使用を許可</span>
</span></span><span style=display:flex><span>eksctl utils associate-iam-oidc-provider --cluster <span style=color:#e6db74>${</span>CLUSTER<span style=color:#e6db74>}</span> --approve</span></span></code></pre></div></div></figure><p>ここまで終わりましたら AWS Load Balancer Controller を利用するための事前準備は完了です。</p><h2 id=step3-コントローラのデプロイ>Step3. コントローラのデプロイ<a hidden class=anchor aria-hidden=true href=#step3-コントローラのデプロイ>#</a></h2><p>それでは AWS Load Balancer Controller を Amazon EKS クラスタにデプロイしていきましょう。</p><p><a href=https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/aws-load-balancer-controller.html>https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/aws-load-balancer-controller.html</a></p><h3 id=サービスアカウントの作成>サービスアカウントの作成<a hidden class=anchor aria-hidden=true href=#サービスアカウントの作成>#</a></h3><p>まずは AWS Load Balancer Controller 用のサービスアカウントの作成を行っていきます。今回は <code>kube-system</code> Namespace に <code>aws-load-balancer-controller</code> という名前でサービスアカウントを作成して行きたいと思います。それでは次のコマンドを実行してサービスアカウントを作成しましょう。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>サービスアカウントの作成</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>AWS_ACCOUNT_ID<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>aws sts get-caller-identity --query <span style=color:#e6db74>&#34;Account&#34;</span> --output text<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>POLICY_NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;myAWSLoadBalancerControllerIAMPolicy&#34;</span>
</span></span><span style=display:flex><span>SERVICE_ACCOUNT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;aws-load-balancer-controller&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># IAM ポリシー定義ファイルのダウンロード</span>
</span></span><span style=display:flex><span>curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/main/docs/install/iam_policy.json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># IAM ポリシーの作成</span>
</span></span><span style=display:flex><span>aws iam create-policy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --policy-name <span style=color:#e6db74>${</span>POLICY_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --policy-document file://iam_policy.json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># サービスアカウントの作成</span>
</span></span><span style=display:flex><span>eksctl create iamserviceaccount <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --name<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>SERVICE_ACCOUNT<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --cluster<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>CLUSTER<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --namespace<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;kube-system&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --attach-policy-arn<span style=color:#f92672>=</span>arn:aws:iam::<span style=color:#e6db74>${</span>AWS_ACCOUNT_ID<span style=color:#e6db74>}</span>:policy/<span style=color:#e6db74>${</span>POLICY_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --override-existing-serviceaccounts <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --approve</span></span></code></pre></div></div></figure><h3 id=コントローラのインストール>コントローラのインストール<a hidden class=anchor aria-hidden=true href=#コントローラのインストール>#</a></h3><p>次に AWS Load Balancer Controller をインストールしていきましょう。なお、AWS Load Balancer Controller のインストール方法はいくつか用意されていますが、AWS Fargate 環境の場合は Helm を利用したインストール方法を選択する必要があるためご注意ください。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>コントローラのインストール</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># EKS 用の Helm レポジトリを追加</span>
</span></span><span style=display:flex><span>helm repo add eks https://aws.github.io/eks-charts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># TargetGroupBinding カスタムリソースをインストール</span>
</span></span><span style=display:flex><span>kubectl apply -k <span style=color:#e6db74>&#34;github.com/aws/eks-charts/stable/aws-load-balancer-controller//crds?ref=master&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Helm チャートからインストール</span>
</span></span><span style=display:flex><span>helm install aws-load-balancer-controller eks/aws-load-balancer-controller <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --set clusterName<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>CLUSTER<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --set serviceAccount.create<span style=color:#f92672>=</span>false <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --set vpcId<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>aws cloudformation describe-stacks <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --stack-name <span style=color:#e6db74>&#34;eksctl-</span><span style=color:#e6db74>${</span>CLUSTER<span style=color:#e6db74>}</span><span style=color:#e6db74>-cluster&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --query <span style=color:#e6db74>&#39;Stacks[0].Outputs[?OutputKey==`VPC`].OutputValue&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --output text<span style=color:#66d9ef>)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --set serviceAccount.name<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>SERVICE_ACCOUNT<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -n kube-system
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 確認</span>
</span></span><span style=display:flex><span>kubectl get deployment -n kube-system aws-load-balancer-controller</span></span></code></pre></div></div></figure><p>インストールに成功していれば出力例のようにコントローラが一覧に表示されるようになります。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ kubectl get deployment -n kube-system aws-load-balancer-controller
</span></span><span style=display:flex><span>NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>aws-load-balancer-controller   2/2     2            2           42s</span></span></code></pre></div></div></figure><p>以上で AWS Load Balancer Controller の導入は完了です。</p><h1 id=aws-load-balancer-controller-を使ってみよう>AWS Load Balancer Controller を使ってみよう<a hidden class=anchor aria-hidden=true href=#aws-load-balancer-controller-を使ってみよう>#</a></h1><h2 id=network-load-balancer-serviceリソース-の使い方>Network Load Balancer (Serviceリソース) の使い方<a hidden class=anchor aria-hidden=true href=#network-load-balancer-serviceリソース-の使い方>#</a></h2><p>AWS Load Balancer Controller 環境では、次のサンプルのように Kubernetes Service リソース定義にて「<strong>LoadBalancer タイプの指定</strong>」と「<strong>アノテーションとして各種パラメータを指定</strong>」をすることによって Network Load Balancer(NLB) をプロビジョニングすることができます。</p><p><a href=https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/network-load-balancing.html>https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/network-load-balancing.html</a></p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Serviceリソース定義サンプル</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sample-service</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>service.beta.kubernetes.io/aws-load-balancer-type</span>: <span style=color:#ae81ff>external</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>service.beta.kubernetes.io/aws-load-balancer-scheme</span>: <span style=color:#ae81ff>internet-facing</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>service.beta.kubernetes.io/aws-load-balancer-nlb-target-type</span>: <span style=color:#ae81ff>ip</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>LoadBalancer</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>sample-app</span></span></span></code></pre></div></div></figure><p>アノテーションに指定する主要なパラメータとしては次の通りです。アノテーションに指定可能なパラメータの一覧につきましては次の URL を参照してください。</p><p><a href=https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.3/guide/service/annotations/>https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.3/guide/service/annotations/</a></p><table><thead><tr><th>アノテーション名</th><th>説明</th></tr></thead><tbody><tr><td>service.beta.kubernetes.io/aws-load-balancer-type</td><td>ロードバランサのプロビジョニングに使用するコントローラを指定します。AWS Load Balancer Controller の場合は &ldquo;<strong>external</strong>&rdquo; を指定します。</td></tr><tr><td>service.beta.kubernetes.io/aws-load-balancer-scheme</td><td>ロードバランサのスキームを指定します。内部向けの場合は &ldquo;<strong>internal</strong>"、インターネット向けの場合は &ldquo;<strong>internet-facing</strong>&rdquo; を指定します。</td></tr><tr><td>service.beta.kubernetes.io/aws-load-balancer-nlb-target-type</td><td>バックエンドに指定するターゲットタイプを指定します。トラフィックを直接 Pod にルーティングするには &ldquo;<strong>ip</strong>&rdquo; を指定します。</td></tr><tr><td>service.beta.kubernetes.io/aws-load-balancer-healthcheck-port</td><td>バックエンドのヘルスチェック用ポート(&rdquo;<strong>traffic-port</strong>"/"<strong>ポート番号</strong>")を指定します。デフォルトは &ldquo;<strong>traffic-port</strong>&rdquo; です。</td></tr><tr><td>service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol</td><td>バックエンドのヘルスチェック用プロトコル("<strong>tcp</strong>"/"<strong>http</strong>"/"<strong>https</strong>")を指定します。デフォルトは &ldquo;<strong>tcp</strong>&rdquo; です。</td></tr><tr><td>service.beta.kubernetes.io/aws-load-balancer-healthcheck-path</td><td>バックエンドの HTTP/HTTPS ヘルスチェック用パスを指定します。デフォルトは &ldquo;<strong>/</strong>&rdquo; です。</td></tr></tbody></table><h3 id=nlb-service-のサンプル>NLB Service のサンプル<a hidden class=anchor aria-hidden=true href=#nlb-service-のサンプル>#</a></h3><p>それではサンプルアプリケーションをデプロイして NLB Service リソースを実際に動かしてみましょう。今回は次のサンプルアプリケーションをベースに少しだけ手を加えたものを用いて動作確認をしていきたいと思います。</p><p><a href=https://github.com/istio/istio/tree/master/samples/helloworld>https://github.com/istio/istio/tree/master/samples/helloworld</a></p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>helloworld-nlb-sample.yaml（サンプルアプリケーション定義ファイル）</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>service.beta.kubernetes.io/aws-load-balancer-type</span>: <span style=color:#ae81ff>external</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>service.beta.kubernetes.io/aws-load-balancer-scheme</span>: <span style=color:#ae81ff>internet-facing</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>service.beta.kubernetes.io/aws-load-balancer-nlb-target-type</span>: <span style=color:#ae81ff>ip</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>service.beta.kubernetes.io/aws-load-balancer-healthcheck-path</span>: <span style=color:#ae81ff>/health</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>LoadBalancer</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>5000</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>helloworld-v1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker.io/istio/examples-helloworld-v1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>5000</span></span></span></code></pre></div></div></figure><p>それでは次のコマンドを実行してサンプルアプリケーションをデプロイしていきましょう。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>サンプルアプリケーションのデプロイ</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export FARGATEPROFILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;sample-app&#34;</span>
</span></span><span style=display:flex><span>export NAMESPACE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;sample&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Fargate プロファイルの作成</span>
</span></span><span style=display:flex><span>eksctl create fargateprofile --cluster <span style=color:#e6db74>${</span>CLUSTER<span style=color:#e6db74>}</span> --name <span style=color:#e6db74>${</span>FARGATEPROFILE<span style=color:#e6db74>}</span> --namespace <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># サンプルアプリケーション用 Namespace の作成</span>
</span></span><span style=display:flex><span>kubectl create namespace <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># サンプルアプリケーションのデプロイ</span>
</span></span><span style=display:flex><span>kubectl apply -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> -f helloworld-nlb-sample.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># サービスがデプロイされたことを確認</span>
</span></span><span style=display:flex><span>kubectl get -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> service helloworld</span></span></code></pre></div></div></figure><p>NLB Service のデプロイに成功した場合は次の出力例のように Service リソース一覧に表示されます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ kubectl get -n ${NAMESPACE} service helloworld
</span></span><span style=display:flex><span>NAME         TYPE           CLUSTER-IP      EXTERNAL-IP                                                                        PORT(S)        AGE
</span></span><span style=display:flex><span>helloworld   LoadBalancer   10.100.114.79   k8s-sample-hellowor-xxxxxxxxxx-xxxxxxxxxxxxxxxx.elb.ap-northeast-1.amazonaws.com   80:32642/TCP   32h</span></span></code></pre></div></div></figure><p>NLB のヘルスチェックが正常になるまで数分待った後、NLB のパブリックエンドポイントにアクセスしてみましょう。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>サンプルアプリケーションへアクセス</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># NLB の DNS 名を取得</span>
</span></span><span style=display:flex><span>ENDPOINT<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>kubectl get -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> service helloworld <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -o custom-columns<span style=color:#f92672>=</span>HOSTNAME:status.loadBalancer.ingress<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.hostname <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --no-headers<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># テストの実行</span>
</span></span><span style=display:flex><span>curl http://<span style=color:#e6db74>${</span>ENDPOINT<span style=color:#e6db74>}</span>/hello</span></span></code></pre></div></div></figure><p>期待通りのレスポンスが返ってくることが確認できたら成功です。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>サンプルアプリケーション出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ curl http://${ENDPOINT}/hello
</span></span><span style=display:flex><span>Hello version: v1, instance: helloworld-v1-b9d9d6679-hdqsq</span></span></code></pre></div></div></figure><p>最後にサンプルアプリケーションを削除して動作確認は終了です。お疲れ様でした。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>サンプルアプリケーションの削除</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete namespace <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span></span></span></code></pre></div></div></figure><h2 id=application-load-balancer-ingressリソース-の使い方>Application Load Balancer (Ingressリソース) の使い方<a hidden class=anchor aria-hidden=true href=#application-load-balancer-ingressリソース-の使い方>#</a></h2><p>AWS Load Balancer Controller 環境では、次のサンプルのように「<strong>Kubernetes IngressClass リソースにてコントローラの指定</strong>」を、「<strong>Kubernetes Ingress リソース定義のアノテーションとして各種パラメータを指定</strong>」をすることによって Application Load Balancer(ALB) をプロビジョニングすることができます。</p><p><a href=https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/alb-ingress.html>https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/alb-ingress.html</a></p><figcaption class="note_title warn">warn</figcaption><div class="note warn"><p>Kubernetes Ingress リソースのアノテーションに <code>kubernetes.io/ingress.class: alb</code> を指定することでも作成できますが、Kubernetes 1.18 以降は <code>kubernetes.io/ingress.class</code> の利用は非推奨となっておりますのでご注意ください。</p></div><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Ingressリソース定義サンプル</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>IngressClass</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sample-ingress-class</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>controller</span>: <span style=color:#ae81ff>ingress.k8s.aws/alb</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Ingress</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sample-ingress</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>alb.ingress.kubernetes.io/scheme</span>: <span style=color:#ae81ff>internet-facing</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>alb.ingress.kubernetes.io/target-type</span>: <span style=color:#ae81ff>ip</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ingressClassName</span>: <span style=color:#ae81ff>sample-ingress-class</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/hello</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>pathType</span>: <span style=color:#ae81ff>Exact</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>backend</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sample-service</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>number</span>: <span style=color:#ae81ff>80</span></span></span></code></pre></div></div></figure><p>アノテーションに指定する主要なパラメータとしては次の通りです。なお、ALB Ingress は AWS WAF や AWS Shield による脅威からの保護、Amazon Cognito 認証などさまざまなマネージドサービスとの連携が可能です。アノテーションに指定可能なパラメータの一覧につきましては次の URL を参照してください。</p><p><a href=https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.3/guide/ingress/annotations/>https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.3/guide/ingress/annotations/</a></p><table><thead><tr><th>アノテーション名</th><th>説明</th></tr></thead><tbody><tr><td>alb.ingress.kubernetes.io/group.name</td><td>複数の Ingress リソースを 1 つの ALB に統合する際にグループ名を指定します。</td></tr><tr><td>alb.ingress.kubernetes.io/scheme</td><td>ロードバランサのスキームを指定します。内部向けの場合は &ldquo;<strong>internal</strong>"、インターネット向けの場合は &ldquo;<strong>internet-facing</strong>&rdquo; を指定します。</td></tr><tr><td>alb.ingress.kubernetes.io/listen-ports</td><td>ロードバランサの受付ポートを指定します。デフォルトは <strong>&rsquo;[{&ldquo;HTTP&rdquo;: 80}]&rsquo; | &lsquo;[{&ldquo;HTTPS&rdquo;: 443}]&rsquo;</strong> です。</td></tr><tr><td>alb.ingress.kubernetes.io/target-type</td><td>バックエンドに指定するターゲットタイプを指定します。トラフィックを直接 Pod にルーティングするには &ldquo;<strong>ip</strong>&rdquo; を指定します。</td></tr><tr><td>alb.ingress.kubernetes.io/healthcheck-port</td><td>バックエンドのヘルスチェック用ポート(&rdquo;<strong>traffic-port</strong>"/"<strong>ポート番号</strong>")を指定します。デフォルトは &ldquo;<strong>traffic-port</strong>&rdquo; です。</td></tr><tr><td>alb.ingress.kubernetes.io/healthcheck-protocol</td><td>バックエンドのヘルスチェック用プロトコル("<strong>http</strong>"/"<strong>https</strong>")を指定します。デフォルトは &ldquo;<strong>http</strong>&rdquo; です。</td></tr><tr><td>alb.ingress.kubernetes.io/healthcheck-path</td><td>バックエンドの HTTP/HTTPS ヘルスチェック用パスを指定します。デフォルトは &ldquo;<strong>/</strong>&rdquo; です。</td></tr></tbody></table><h3 id=alb-ingress-のサンプル>ALB Ingress のサンプル<a hidden class=anchor aria-hidden=true href=#alb-ingress-のサンプル>#</a></h3><p>それではサンプルアプリケーションをデプロイして ALB Ingress リソースを実際に動かしてみましょう。今回は次のサンプルアプリケーションをベースに少しだけ手を加えたものを用いて動作確認をしていきたいと思います。</p><p><a href=https://github.com/istio/istio/tree/master/samples/helloworld>https://github.com/istio/istio/tree/master/samples/helloworld</a></p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>helloworld-alb-sample.yaml（サンプルアプリケーション定義ファイル）</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>IngressClass</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>alb-ingress</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>controller</span>: <span style=color:#ae81ff>ingress.k8s.aws/alb</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Ingress</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>alb.ingress.kubernetes.io/scheme</span>: <span style=color:#ae81ff>internet-facing</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>alb.ingress.kubernetes.io/target-type</span>: <span style=color:#ae81ff>ip</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>alb.ingress.kubernetes.io/healthcheck-path</span>: <span style=color:#ae81ff>/health</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ingressClassName</span>: <span style=color:#ae81ff>alb-ingress</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/hello</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>pathType</span>: <span style=color:#ae81ff>Exact</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>backend</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>number</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>service</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>5000</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>helloworld-v1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>helloworld</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker.io/istio/examples-helloworld-v1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>5000</span></span></span></code></pre></div></div></figure><p>それでは次のコマンドを実行してサンプルアプリケーションをデプロイしていきましょう。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>サンプルアプリケーションのデプロイ</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export FARGATEPROFILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;sample-app&#34;</span>
</span></span><span style=display:flex><span>export NAMESPACE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;sample&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Fargate プロファイルの作成</span>
</span></span><span style=display:flex><span>eksctl create fargateprofile --cluster <span style=color:#e6db74>${</span>CLUSTER<span style=color:#e6db74>}</span> --name <span style=color:#e6db74>${</span>FARGATEPROFILE<span style=color:#e6db74>}</span> --namespace <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># サンプルアプリケーション用 Namespace の作成</span>
</span></span><span style=display:flex><span>kubectl create namespace <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># サンプルアプリケーションのデプロイ</span>
</span></span><span style=display:flex><span>kubectl apply -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> -f helloworld-alb-sample.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Ingress がデプロイされたことを確認</span>
</span></span><span style=display:flex><span>kubectl get -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> ingress helloworld</span></span></code></pre></div></div></figure><p>ALB Ingress のデプロイに成功した場合は次の出力例のように Ingress リソース一覧に表示されます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ kubectl get -n ${NAMESPACE} ingress helloworld
</span></span><span style=display:flex><span>NAME         CLASS    HOSTS   ADDRESS                                                                    PORTS   AGE
</span></span><span style=display:flex><span>helloworld   &lt;none&gt;   *       k8s-sample-hellowor-xxxxxxxxxx-xxxxxxxx.ap-northeast-1.elb.amazonaws.com   80      70s</span></span></code></pre></div></div></figure><p>DNS への登録などが反映されるまで数分待った後、ALB のパブリックエンドポイントにアクセスしてみましょう。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>サンプルアプリケーションへアクセス</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># NLB の DNS 名を取得</span>
</span></span><span style=display:flex><span>ENDPOINT<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>kubectl get -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> ingress helloworld <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -o custom-columns<span style=color:#f92672>=</span>HOSTNAME:status.loadBalancer.ingress<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.hostname <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --no-headers<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># テストの実行</span>
</span></span><span style=display:flex><span>curl http://<span style=color:#e6db74>${</span>ENDPOINT<span style=color:#e6db74>}</span>/hello</span></span></code></pre></div></div></figure><p>期待通りのレスポンスが返ってくることが確認できたら成功です。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>サンプルアプリケーション出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ curl http://${ENDPOINT}/hello
</span></span><span style=display:flex><span>Hello version: v1, instance: helloworld-v1-b9d9d6679-rpfzl</span></span></code></pre></div></div></figure><p>最後にサンプルアプリケーションを削除して動作確認は終了です。お疲れ様でした。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>サンプルアプリケーションの削除</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete namespace <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span></span></span></code></pre></div></div></figure><h1 id=終わりに>終わりに<a hidden class=anchor aria-hidden=true href=#終わりに>#</a></h1><p>今回は Amazon Elastic Kubernetes Service(EKS) を利用する際に併せて利用したい AWS Load Balancer Controller のご紹介でしたが、いかがだったでしょうか？</p><p>今回は IaC を実現する 1 つの手段として、というカットでの紹介でしたが Kubernetes Ingress/Service リソースを ELB にすることでさまざまなメリットが期待できますので、Amazon EKS をご利用の際は AWS Load Balancer Controller の併用も視野に入れてみてはいかがでしょうか。</p><p>なお、今回は紹介しませんでしたが AWS Load Balancer Controller は使いたいけれど、ELB リソースのライフサイクルは Kubernetes からは切り離したいというケースもあるかと思います。そういった場合は AWS Load Balancer Controller の TargetGroupBinding 機能を利用することで実現可能なので参考にしていただければと思います。TargetGroupBinding 機能の詳細については公式ドキュメントを参照してください。</p><p><a href=https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.3/guide/targetgroupbinding/targetgroupbinding/>https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.3/guide/targetgroupbinding/targetgroupbinding/</a></p><p>以上、Kubernetes Service/Ingress リソースと Elastic Load Balancing(ELB) との統合を実現する「AWS Load Balancer Controller」のご紹介でした。</p><hr><ul><li>AWS は、米国その他の諸国における Amazon.com, Inc. またはその関連会社の商標です。</li><li>Kubernetes は、The Linux Foundation の米国およびその他の国における登録商標または商標です。</li><li>その他、本資料に記述してある会社名、製品名は、各社の登録商品または商標です。</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://chacco38.github.io/tags/aws/>AWS</a></li><li><a href=https://chacco38.github.io/tags/kubernetes/>Kubernetes</a></li><li><a href=https://chacco38.github.io/tags/amazon-eks/>Amazon EKS</a></li><li><a href=https://chacco38.github.io/tags/elastic-load-balancingelb/>Elastic Load Balancing(ELB)</a></li></ul><nav class=paginav><a class=prev href=https://chacco38.github.io/posts/2021/12/gcp-new-asm-installation-options/><span class=title>« Prev Page</span><br><span>GKE クラスタ作成時のオプションで Anthos Service Mesh を有効化できるようになりました</span></a>
<a class=next href=https://chacco38.github.io/posts/2021/12/gcp-multi-asm-cluster/><span class=title>Next Page »</span><br><span>単一リージョンの複数 GKE クラスタと Anthos Service Mesh でマルチクラスタメッシュ環境を構築してみた</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share AWS Load Balancer Controller を使って ELB を Kubernetes のマニフェストファイルで管理しよう on twitter" href="https://twitter.com/intent/tweet/?text=AWS%20Load%20Balancer%20Controller%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%20ELB%20%e3%82%92%20Kubernetes%20%e3%81%ae%e3%83%9e%e3%83%8b%e3%83%95%e3%82%a7%e3%82%b9%e3%83%88%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%a7%e7%ae%a1%e7%90%86%e3%81%97%e3%82%88%e3%81%86&url=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2faws-load-balancer-controller%2f&hashtags=AWS%2cKubernetes%2cAmazonEKS%2cElasticLoadBalancing%28ELB%29"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share AWS Load Balancer Controller を使って ELB を Kubernetes のマニフェストファイルで管理しよう on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2faws-load-balancer-controller%2f&title=AWS%20Load%20Balancer%20Controller%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%20ELB%20%e3%82%92%20Kubernetes%20%e3%81%ae%e3%83%9e%e3%83%8b%e3%83%95%e3%82%a7%e3%82%b9%e3%83%88%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%a7%e7%ae%a1%e7%90%86%e3%81%97%e3%82%88%e3%81%86&summary=AWS%20Load%20Balancer%20Controller%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%20ELB%20%e3%82%92%20Kubernetes%20%e3%81%ae%e3%83%9e%e3%83%8b%e3%83%95%e3%82%a7%e3%82%b9%e3%83%88%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%a7%e7%ae%a1%e7%90%86%e3%81%97%e3%82%88%e3%81%86&source=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2faws-load-balancer-controller%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share AWS Load Balancer Controller を使って ELB を Kubernetes のマニフェストファイルで管理しよう on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2faws-load-balancer-controller%2f&title=AWS%20Load%20Balancer%20Controller%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%20ELB%20%e3%82%92%20Kubernetes%20%e3%81%ae%e3%83%9e%e3%83%8b%e3%83%95%e3%82%a7%e3%82%b9%e3%83%88%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%a7%e7%ae%a1%e7%90%86%e3%81%97%e3%82%88%e3%81%86"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share AWS Load Balancer Controller を使って ELB を Kubernetes のマニフェストファイルで管理しよう on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2faws-load-balancer-controller%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share AWS Load Balancer Controller を使って ELB を Kubernetes のマニフェストファイルで管理しよう on whatsapp" href="https://api.whatsapp.com/send?text=AWS%20Load%20Balancer%20Controller%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%20ELB%20%e3%82%92%20Kubernetes%20%e3%81%ae%e3%83%9e%e3%83%8b%e3%83%95%e3%82%a7%e3%82%b9%e3%83%88%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%a7%e7%ae%a1%e7%90%86%e3%81%97%e3%82%88%e3%81%86%20-%20https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2faws-load-balancer-controller%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share AWS Load Balancer Controller を使って ELB を Kubernetes のマニフェストファイルで管理しよう on telegram" href="https://telegram.me/share/url?text=AWS%20Load%20Balancer%20Controller%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%20ELB%20%e3%82%92%20Kubernetes%20%e3%81%ae%e3%83%9e%e3%83%8b%e3%83%95%e3%82%a7%e3%82%b9%e3%83%88%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%a7%e7%ae%a1%e7%90%86%e3%81%97%e3%82%88%e3%81%86&url=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2faws-load-balancer-controller%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>© 2022 Satoshi Matsuzawa</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>