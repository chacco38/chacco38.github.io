<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>GKE Autopilot と Anthos Service Mesh を使ってフルマネージドなサービスメッシュ環境を構築してみた | クラウドCoEの何でも屋</title><meta name=keywords content="Google Cloud,Anthos Service Mesh,Google Kubernetes Engine(GKE),GKE Autopilot,Kubernetes,Istio"><meta name=description content="はじめに みなさん、こんにちは。今回は Google Cloud が提供するマネージドサービスメッシュサービスの Anthos Service Mesh に関するお話です。
Anthos Service Mesh はここ半年で「マネージドコントロールプレーン機能の一般公開」、「マネージドデータプレーン機能のプレビュー公開」と Google マネージドの範囲を徐々に広げてきましたが、2021 年 11 月 19 日の更新でプレビュー段階ではありますが「Google Kubernetes Engine(GKE) Autopilot 上でも Anthos Service Mesh を利用できる」ようになりました。
今回はそんなプレビュー公開されたばかりの GKE Autopilot と Anthos Service Mesh(ASM) を使った Kubernetes 部分も含めてフルマネージドなサービスメッシュ環境を構築していきたいと思います。
構築するシステムについて 次の図に示すように限定公開クラスタおよび承認済みネットワーク機能を有効化した GKE Autopilot クラスタに対して Anthos Service Mesh を導入し、サービスメッシュ上でサンプルアプリケーションを動かしていきたいと思います。
それでは構築していきましょう いつも通り公式ドキュメントを参考にしつつ、公式ドキュメントに書かれていない部分を補足しながら構築をしていきたいと思います。
https://cloud.google.com/service-mesh/docs/unified-install/managed-asmcli-experimental
Step1. VPC ネットワークの作成 まずは GKE ノードを配置する VPC ネットワークおよび東京リージョンにサブネットを作成します。今回の例では GKE ノードからプライベートネットワーク経由で Artifact Registry などの他のマネージドサービスへアクセスできるように限定公開の Google アクセスをオンにしています。
プライベートネットワークからインターネット上の Docker Hub などへ接続できるよう Cloud NAT リソースも作成しておきたいと思います。"><meta name=author content><link rel=canonical href=https://chacco38.github.io/posts/2021/12/gcp-asm-with-gke-autopilot/><link crossorigin=anonymous href=/assets/css/stylesheet.min.317d4c109e98a8137e18d0fd1222603a2a157f4e40f59a79576eb3861cc09531.css integrity="sha256-MX1MEJ6YqBN+GND9EiJgOioVf05A9Zp5V26zhhzAlTE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://chacco38.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://chacco38.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://chacco38.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://chacco38.github.io/apple-touch-icon.png><link rel=mask-icon href=https://chacco38.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="GKE Autopilot と Anthos Service Mesh を使ってフルマネージドなサービスメッシュ環境を構築してみた"><meta property="og:description" content="はじめに みなさん、こんにちは。今回は Google Cloud が提供するマネージドサービスメッシュサービスの Anthos Service Mesh に関するお話です。
Anthos Service Mesh はここ半年で「マネージドコントロールプレーン機能の一般公開」、「マネージドデータプレーン機能のプレビュー公開」と Google マネージドの範囲を徐々に広げてきましたが、2021 年 11 月 19 日の更新でプレビュー段階ではありますが「Google Kubernetes Engine(GKE) Autopilot 上でも Anthos Service Mesh を利用できる」ようになりました。
今回はそんなプレビュー公開されたばかりの GKE Autopilot と Anthos Service Mesh(ASM) を使った Kubernetes 部分も含めてフルマネージドなサービスメッシュ環境を構築していきたいと思います。
構築するシステムについて 次の図に示すように限定公開クラスタおよび承認済みネットワーク機能を有効化した GKE Autopilot クラスタに対して Anthos Service Mesh を導入し、サービスメッシュ上でサンプルアプリケーションを動かしていきたいと思います。
それでは構築していきましょう いつも通り公式ドキュメントを参考にしつつ、公式ドキュメントに書かれていない部分を補足しながら構築をしていきたいと思います。
https://cloud.google.com/service-mesh/docs/unified-install/managed-asmcli-experimental
Step1. VPC ネットワークの作成 まずは GKE ノードを配置する VPC ネットワークおよび東京リージョンにサブネットを作成します。今回の例では GKE ノードからプライベートネットワーク経由で Artifact Registry などの他のマネージドサービスへアクセスできるように限定公開の Google アクセスをオンにしています。
プライベートネットワークからインターネット上の Docker Hub などへ接続できるよう Cloud NAT リソースも作成しておきたいと思います。"><meta property="og:type" content="article"><meta property="og:url" content="https://chacco38.github.io/posts/2021/12/gcp-asm-with-gke-autopilot/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-01T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-01T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="GKE Autopilot と Anthos Service Mesh を使ってフルマネージドなサービスメッシュ環境を構築してみた"><meta name=twitter:description content="はじめに みなさん、こんにちは。今回は Google Cloud が提供するマネージドサービスメッシュサービスの Anthos Service Mesh に関するお話です。
Anthos Service Mesh はここ半年で「マネージドコントロールプレーン機能の一般公開」、「マネージドデータプレーン機能のプレビュー公開」と Google マネージドの範囲を徐々に広げてきましたが、2021 年 11 月 19 日の更新でプレビュー段階ではありますが「Google Kubernetes Engine(GKE) Autopilot 上でも Anthos Service Mesh を利用できる」ようになりました。
今回はそんなプレビュー公開されたばかりの GKE Autopilot と Anthos Service Mesh(ASM) を使った Kubernetes 部分も含めてフルマネージドなサービスメッシュ環境を構築していきたいと思います。
構築するシステムについて 次の図に示すように限定公開クラスタおよび承認済みネットワーク機能を有効化した GKE Autopilot クラスタに対して Anthos Service Mesh を導入し、サービスメッシュ上でサンプルアプリケーションを動かしていきたいと思います。
それでは構築していきましょう いつも通り公式ドキュメントを参考にしつつ、公式ドキュメントに書かれていない部分を補足しながら構築をしていきたいと思います。
https://cloud.google.com/service-mesh/docs/unified-install/managed-asmcli-experimental
Step1. VPC ネットワークの作成 まずは GKE ノードを配置する VPC ネットワークおよび東京リージョンにサブネットを作成します。今回の例では GKE ノードからプライベートネットワーク経由で Artifact Registry などの他のマネージドサービスへアクセスできるように限定公開の Google アクセスをオンにしています。
プライベートネットワークからインターネット上の Docker Hub などへ接続できるよう Cloud NAT リソースも作成しておきたいと思います。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://chacco38.github.io/posts/"},{"@type":"ListItem","position":2,"name":"GKE Autopilot と Anthos Service Mesh を使ってフルマネージドなサービスメッシュ環境を構築してみた","item":"https://chacco38.github.io/posts/2021/12/gcp-asm-with-gke-autopilot/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"GKE Autopilot と Anthos Service Mesh を使ってフルマネージドなサービスメッシュ環境を構築してみた","name":"GKE Autopilot と Anthos Service Mesh を使ってフルマネージドなサービスメッシュ環境を構築してみた","description":"はじめに みなさん、こんにちは。今回は Google Cloud が提供するマネージドサービスメッシュサービスの Anthos Service Mesh に関するお話です。\nAnthos Service Mesh はここ半年で「マネージドコントロールプレーン機能の一般公開」、「マネージドデータプレーン機能のプレビュー公開」と Google マネージドの範囲を徐々に広げてきましたが、2021 年 11 月 19 日の更新でプレビュー段階ではありますが「Google Kubernetes Engine(GKE) Autopilot 上でも Anthos Service Mesh を利用できる」ようになりました。\n今回はそんなプレビュー公開されたばかりの GKE Autopilot と Anthos Service Mesh(ASM) を使った Kubernetes 部分も含めてフルマネージドなサービスメッシュ環境を構築していきたいと思います。\n構築するシステムについて 次の図に示すように限定公開クラスタおよび承認済みネットワーク機能を有効化した GKE Autopilot クラスタに対して Anthos Service Mesh を導入し、サービスメッシュ上でサンプルアプリケーションを動かしていきたいと思います。\nそれでは構築していきましょう いつも通り公式ドキュメントを参考にしつつ、公式ドキュメントに書かれていない部分を補足しながら構築をしていきたいと思います。\nhttps://cloud.google.com/service-mesh/docs/unified-install/managed-asmcli-experimental\nStep1. VPC ネットワークの作成 まずは GKE ノードを配置する VPC ネットワークおよび東京リージョンにサブネットを作成します。今回の例では GKE ノードからプライベートネットワーク経由で Artifact Registry などの他のマネージドサービスへアクセスできるように限定公開の Google アクセスをオンにしています。\nプライベートネットワークからインターネット上の Docker Hub などへ接続できるよう Cloud NAT リソースも作成しておきたいと思います。","keywords":["Google Cloud","Anthos Service Mesh","Google Kubernetes Engine(GKE)","GKE Autopilot","Kubernetes","Istio"],"articleBody":"はじめに みなさん、こんにちは。今回は Google Cloud が提供するマネージドサービスメッシュサービスの Anthos Service Mesh に関するお話です。\nAnthos Service Mesh はここ半年で「マネージドコントロールプレーン機能の一般公開」、「マネージドデータプレーン機能のプレビュー公開」と Google マネージドの範囲を徐々に広げてきましたが、2021 年 11 月 19 日の更新でプレビュー段階ではありますが「Google Kubernetes Engine(GKE) Autopilot 上でも Anthos Service Mesh を利用できる」ようになりました。\n今回はそんなプレビュー公開されたばかりの GKE Autopilot と Anthos Service Mesh(ASM) を使った Kubernetes 部分も含めてフルマネージドなサービスメッシュ環境を構築していきたいと思います。\n構築するシステムについて 次の図に示すように限定公開クラスタおよび承認済みネットワーク機能を有効化した GKE Autopilot クラスタに対して Anthos Service Mesh を導入し、サービスメッシュ上でサンプルアプリケーションを動かしていきたいと思います。\nそれでは構築していきましょう いつも通り公式ドキュメントを参考にしつつ、公式ドキュメントに書かれていない部分を補足しながら構築をしていきたいと思います。\nhttps://cloud.google.com/service-mesh/docs/unified-install/managed-asmcli-experimental\nStep1. VPC ネットワークの作成 まずは GKE ノードを配置する VPC ネットワークおよび東京リージョンにサブネットを作成します。今回の例では GKE ノードからプライベートネットワーク経由で Artifact Registry などの他のマネージドサービスへアクセスできるように限定公開の Google アクセスをオンにしています。\nプライベートネットワークからインターネット上の Docker Hub などへ接続できるよう Cloud NAT リソースも作成しておきたいと思います。\nStep2. GKE Autopilot クラスタの作成 次に GKE Autopilot クラスタを作成していきます。Google Cloud コンソールから操作する場合は GKE クラスタ画面の「+作成」ボタンをクリックし、GKE Autopilot クラスタの作成画面へと遷移します。\nAutopilot クラスタの作成画面では、クラスタを展開するネットワークの選択とリリースチャンネルの選択をしていきます。今回はセキュリティの観点から限定公開クラスタに設定し、GKE Autopilot リリースチャンネルには Anthos Service Mesh が現時点で唯一サポート対象としている Rapid チャンネルを指定しています。作成ボタンを押してからクラスタの作成が完了するまで 5 分程度かかりました。\nなお、Anthos Service Mesh がサポートする GKE Autopilot リリースチャンネルについては近い将来変更が生じる可能性が高いため、構築を行う際には最新のサポート状況を公式ドキュメントから確認するようにしましょう。\nhttps://cloud.google.com/service-mesh/docs/supported-features-mcp\nStep3. Anthos Service Mesh のインストール ここからは Cloud Shell から操作を実施していきたいと思います。まずは Kubernetes API へ接続できるように GKE コントロールプレーンの承認済みネットワークに Cloud Shell の IP アドレスを登録し、kubectl を実行できるようにクラスタ認証情報を取得します。\nクラスタ認証情報の取得 export PROJECT_ID=`gcloud config list --format \"value(core.project)\"` export CLUSTER_NAME=\"matt-tokyo-autopilot-cluster-001\" export CLUSTER_LOCATION=\"asia-northeast1\"  # CloudShellの承認済みネットワーク登録 gcloud container clusters update ${CLUSTER_NAME} \\  --region ${CLUSTER_LOCATION} \\  --enable-master-authorized-networks \\  --master-authorized-networks \\  \"`dig +short myip.opendns.com @resolver1.opendns.com`/32\"  # クラスタ認証情報の取得 gcloud container clusters get-credentials ${CLUSTER_NAME} \\  --region ${CLUSTER_LOCATION}  次に Anthos Service Mesh v1.11 から正式な管理ツールとなった asmcli をダウンロードします。\nasmcliツールのダウンロード curl https://storage.googleapis.com/csm-artifacts/asm/asmcli_1.11  asmcli  # 実行権限の付与 chmod +x asmcli  asmcli を使って GKE Autopilot クラスタに Rapid チャンネル(※1)の Anthos Service Mesh をインストールします。コマンドが完了するまでおおよそ 5 分程度かかりました。\n※1: 現時点では GKE Autopilot は Anthos Service Mesh の Rapid チャンネルでのみサポートされているため\nAnthosServiceMeshのインストール ./asmcli x install \\  --project_id ${PROJECT_ID} \\  --cluster_location ${CLUSTER_LOCATION} \\  --cluster_name ${CLUSTER_NAME} \\  --managed \\  --use_managed_cni \\  --channel \"rapid\" \\  --enable-all \\  --output_dir ${CLUSTER_NAME}  インストールに成功した場合は次のようなメッセージが出力されます。\nインストール成功時のメッセージ出力 asmcli: Successfully installed ASM.  Step4. ファイアウォールルールの更新 (限定公開クラスタ時のみ) 限定公開クラスタに Anthos Service Mesh をインストールした場合は、コントロールプレーンからのポート 15017 による通信を追加で許可する必要があります。まず次のコマンドを実行し、既存のファイアウォールルール名を取得します。\nファイアウォールルールの確認 gcloud compute firewall-rules list --filter=\"name~${CLUSTER_NAME}-.*-master\"  次のコマンドのファイアウォールルール名 ${FIREWALL_RULE_NAME} を前のコマンドで取得した名前に置き替え、コマンド実行してコントロールプレーンからのポート 15017 による通信を許可します。\nファイアウォールルールの更新 gcloud compute firewall-rules update ${FIREWALL_RULE_NAME} \\  --allow tcp:10250,tcp:443,tcp:15017  Step5. マネージドデータプレーンの有効化 (Namespace 毎に設定) マネージドデータプレーンは Kubernetes Namespace リソースごとにアノテーションを設定して有効化を行います。次のコマンドの ${NAMESPACE_NAME} を設定対象の Namespace 名に置き替え、コマンド実行してマネージドデータプレーンを有効化します。\nマネージドデータプレーンの有効化 kubectl annotate --overwrite namespace ${NAMESPACE_NAME} \\  mesh.cloud.google.com/proxy='{\"managed\":\"true\"}'  Step6. Ingress Gateway のデプロイ asmcli でインストールした場合は自動で Ingress Gateway はデプロイされないため、メッシュ外からのアクセスをさせるためには Ingress Gateway をデプロイする必要があります。まず次のコマンドで istio-gateway Namespace を新たに作成します。\nIngressGateway用のNamespace作成 export GATEWAY_NAMESPACE=\"istio-gateway\"  kubectl apply -f - apiVersion: v1 kind: Namespace metadata: name: ${GATEWAY_NAMESPACE} annotations: # マネージドデータプレーン有効化の設定 mesh.cloud.google.com/proxy: '{\"managed\":\"true\"}' labels: # 自動サイドカーインジェクション(Rapid)有効化の設定 istio.io/rev: asm-managed-rapid EOF  次のコマンドを実行して Ingress Gateway をデプロイします。なお、今回は Anthos Service Mesh をインストールした際に --output_dir で指定したディレクトリに Ingress Gateway の定義ファイルが配置されているのでこちらをそのまま利用しています。\nIngressGatewayのデプロイ kubectl apply -n ${GATEWAY_NAMESPACE} \\  -f ${CLUSTER_NAME}/samples/gateways/istio-ingressgateway  なお、今回利用した Ingress Gateway の詳細については次の URL をご参照ください。\nhttps://github.com/GoogleCloudPlatform/anthos-service-mesh-packages/tree/main/samples/gateways/istio-ingressgateway\n以上でアプリケーションをデプロイする準備が整いました。\nStep7. サンプルアプリケーションのデプロイ 最後にサンプルアプリケーションをデプロイし、環境に問題がないかを確認していきましょう。まず次のコマンドでサンプルアプリケーション用の Namespace を新たに作成します。\nNamespaceの作成 export SAMPLE_NAMESPACE=\"sample\"  # サンプルアプリケーション用 Namespace リソースの作成 kubectl apply -f - apiVersion: v1 kind: Namespace metadata: annotations: # マネージドデータプレーン有効化の設定 mesh.cloud.google.com/proxy: '{\"managed\":\"true\"}' labels: # 自動サイドカーインジェクション(Rapid)有効化の設定 istio.io/rev: asm-managed-rapid EOF  サンプルアプリケーションをデプロイします。今回は Anthos Service Mesh をインストールした際に --output_dir で指定したディレクトリに格納されているサンプルアプリケーションの中から HelloWorld というサンプルアプリケーションを使用しています。\nHelloWorldアプリケーションのデプロイ # Kubernetes Service リソースのデプロイ kubectl apply -n ${SAMPLE_NAMESPACE} \\  -f ${CLUSTER_NAME}/istio-1.11.2-asm.17/samples/helloworld/helloworld.yaml \\  -l service=helloworld  # Kubernetes Deployment リソースのデプロイ kubectl apply -n ${SAMPLE_NAMESPACE} \\  -f ${CLUSTER_NAME}/istio-1.11.2-asm.17/samples/helloworld/helloworld.yaml \\  -l version=v1  # Istio Gateway/VirtualService リソースのデプロイ kubectl apply -n ${SAMPLE_NAMESPACE} \\  -f ${CLUSTER_NAME}/istio-1.11.2-asm.17/samples/helloworld/helloworld-gateway.yaml  アプリケーションのデプロイが終わったので Ingress Gateway 経由でアプリケーションにアクセスできるかを確認していきましょう。まず次のコマンドを実行して Ingress Gateway の External IP アドレスを取得します。\nIngressGatewayの設定 kubectl -n ${GATEWAY_NAMESPACE} get service istio-ingressgateway  External IP アドレスが取得できたら curl コマンドなどで http:///hello にアクセスしてみましょう。次のようなメッセージが表示されていれば成功です。\n成功時のメッセージ Hello version: v1, instance: helloworld-v1-xxxxxxxxxx-xxxxx  以上で構築は終わりです。お疲れ様でした。\n終わりに さて今回はプレビュー公開されたばかりの Google Kubernetes Engine(GKE) Autopilot と Anthos Service Mesh(ASM) を使ったフルマネージドなサービスメッシュ環境を構築する方法のご紹介でした。いかがだったでしょうか。\nこれで晴れて Kubernetes 部分も含めフルマネージドなサービスメッシュ環境が実現できるようになり、こちらの活用により従来よりも運用負荷を大きく軽減できる未来が近づいてきましたね。\nもちろん安定性、保守性といった観点からプロダクション用途へのプレビュー段階の機能の適用は、現時点ではお勧めできませんが、もしこれから検証目的で試してみたいという方は参考にしてみてはいかがでしょうか。\n  Google Cloud は、Google LLC の商標または登録商標です。 その他、記載されている会社名および商品・製品・サービス名は、各社の商標または登録商標です。  ","wordCount":"493","inLanguage":"en","datePublished":"2021-12-01T00:00:00Z","dateModified":"2021-12-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://chacco38.github.io/posts/2021/12/gcp-asm-with-gke-autopilot/"},"publisher":{"@type":"Organization","name":"クラウドCoEの何でも屋","logo":{"@type":"ImageObject","url":"https://chacco38.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://chacco38.github.io/ accesskey=h title="クラウドCoEの何でも屋 (Alt + H)">クラウドCoEの何でも屋</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://chacco38.github.io/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://chacco38.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://chacco38.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://chacco38.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://chacco38.github.io/posts/>Posts</a></div><h1 class=post-title>GKE Autopilot と Anthos Service Mesh を使ってフルマネージドなサービスメッシュ環境を構築してみた</h1><div class=post-meta><span title="2021-12-01 00:00:00 +0000 UTC">December 1, 2021</span>&nbsp;·&nbsp;3 min&nbsp;|&nbsp;<a href=https://github.com/chacco38/chacco38.github.io/tree/main/content/posts/2021/12/gcp-asm-with-gke-autopilot/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e3%81%af%e3%81%98%e3%82%81%e3%81%ab aria-label=はじめに>はじめに</a></li><li><a href=#%e6%a7%8b%e7%af%89%e3%81%99%e3%82%8b%e3%82%b7%e3%82%b9%e3%83%86%e3%83%a0%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6 aria-label=構築するシステムについて>構築するシステムについて</a></li><li><a href=#%e3%81%9d%e3%82%8c%e3%81%a7%e3%81%af%e6%a7%8b%e7%af%89%e3%81%97%e3%81%a6%e3%81%84%e3%81%8d%e3%81%be%e3%81%97%e3%82%87%e3%81%86 aria-label=それでは構築していきましょう>それでは構築していきましょう</a><ul><ul><li><a href=#step1-vpc-%e3%83%8d%e3%83%83%e3%83%88%e3%83%af%e3%83%bc%e3%82%af%e3%81%ae%e4%bd%9c%e6%88%90 aria-label="Step1. VPC ネットワークの作成">Step1. VPC ネットワークの作成</a></li><li><a href=#step2-gke-autopilot-%e3%82%af%e3%83%a9%e3%82%b9%e3%82%bf%e3%81%ae%e4%bd%9c%e6%88%90 aria-label="Step2. GKE Autopilot クラスタの作成">Step2. GKE Autopilot クラスタの作成</a></li><li><a href=#step3-anthos-service-mesh-%e3%81%ae%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab aria-label="Step3. Anthos Service Mesh のインストール">Step3. Anthos Service Mesh のインストール</a></li><li><a href=#step4-%e3%83%95%e3%82%a1%e3%82%a4%e3%82%a2%e3%82%a6%e3%82%a9%e3%83%bc%e3%83%ab%e3%83%ab%e3%83%bc%e3%83%ab%e3%81%ae%e6%9b%b4%e6%96%b0-%e9%99%90%e5%ae%9a%e5%85%ac%e9%96%8b%e3%82%af%e3%83%a9%e3%82%b9%e3%82%bf%e6%99%82%e3%81%ae%e3%81%bf aria-label="Step4. ファイアウォールルールの更新 (限定公開クラスタ時のみ)">Step4. ファイアウォールルールの更新 (限定公開クラスタ時のみ)</a></li><li><a href=#step5-%e3%83%9e%e3%83%8d%e3%83%bc%e3%82%b8%e3%83%89%e3%83%87%e3%83%bc%e3%82%bf%e3%83%97%e3%83%ac%e3%83%bc%e3%83%b3%e3%81%ae%e6%9c%89%e5%8a%b9%e5%8c%96-namespace-%e6%af%8e%e3%81%ab%e8%a8%ad%e5%ae%9a aria-label="Step5. マネージドデータプレーンの有効化 (Namespace 毎に設定)">Step5. マネージドデータプレーンの有効化 (Namespace 毎に設定)</a></li><li><a href=#step6-ingress-gateway-%e3%81%ae%e3%83%87%e3%83%97%e3%83%ad%e3%82%a4 aria-label="Step6. Ingress Gateway のデプロイ">Step6. Ingress Gateway のデプロイ</a></li><li><a href=#step7-%e3%82%b5%e3%83%b3%e3%83%97%e3%83%ab%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%ae%e3%83%87%e3%83%97%e3%83%ad%e3%82%a4 aria-label="Step7. サンプルアプリケーションのデプロイ">Step7. サンプルアプリケーションのデプロイ</a></li></ul></ul></li><li><a href=#%e7%b5%82%e3%82%8f%e3%82%8a%e3%81%ab aria-label=終わりに>終わりに</a></li></ul></div></details></div><div class=post-content><h1 id=はじめに>はじめに<a hidden class=anchor aria-hidden=true href=#はじめに>#</a></h1><p>みなさん、こんにちは。今回は Google Cloud が提供するマネージドサービスメッシュサービスの Anthos Service Mesh に関するお話です。</p><p>Anthos Service Mesh はここ半年で「マネージドコントロールプレーン機能の一般公開」、「マネージドデータプレーン機能のプレビュー公開」と Google マネージドの範囲を徐々に広げてきましたが、2021 年 11 月 19 日の更新でプレビュー段階ではありますが「Google Kubernetes Engine(GKE) Autopilot 上でも Anthos Service Mesh を利用できる」ようになりました。</p><p>今回はそんなプレビュー公開されたばかりの GKE Autopilot と Anthos Service Mesh(ASM) を使った Kubernetes 部分も含めてフルマネージドなサービスメッシュ環境を構築していきたいと思います。</p><h1 id=構築するシステムについて>構築するシステムについて<a hidden class=anchor aria-hidden=true href=#構築するシステムについて>#</a></h1><p>次の図に示すように限定公開クラスタおよび承認済みネットワーク機能を有効化した GKE Autopilot クラスタに対して Anthos Service Mesh を導入し、サービスメッシュ上でサンプルアプリケーションを動かしていきたいと思います。</p><p><img loading=lazy src=images/01-architecture.png alt=01-architecture.png></p><h1 id=それでは構築していきましょう>それでは構築していきましょう<a hidden class=anchor aria-hidden=true href=#それでは構築していきましょう>#</a></h1><p>いつも通り公式ドキュメントを参考にしつつ、公式ドキュメントに書かれていない部分を補足しながら構築をしていきたいと思います。</p><p><a href=https://cloud.google.com/service-mesh/docs/unified-install/managed-asmcli-experimental>https://cloud.google.com/service-mesh/docs/unified-install/managed-asmcli-experimental</a></p><h3 id=step1-vpc-ネットワークの作成>Step1. VPC ネットワークの作成<a hidden class=anchor aria-hidden=true href=#step1-vpc-ネットワークの作成>#</a></h3><p>まずは GKE ノードを配置する VPC ネットワークおよび東京リージョンにサブネットを作成します。今回の例では GKE ノードからプライベートネットワーク経由で Artifact Registry などの他のマネージドサービスへアクセスできるように限定公開の Google アクセスをオンにしています。</p><p><img loading=lazy src=images/02-create-vpc-network.png alt=02-create-vpc-network.png></p><p>プライベートネットワークからインターネット上の Docker Hub などへ接続できるよう Cloud NAT リソースも作成しておきたいと思います。</p><p><img loading=lazy src=images/03-create-nat.png alt=03-create-nat.png></p><h3 id=step2-gke-autopilot-クラスタの作成>Step2. GKE Autopilot クラスタの作成<a hidden class=anchor aria-hidden=true href=#step2-gke-autopilot-クラスタの作成>#</a></h3><p>次に GKE Autopilot クラスタを作成していきます。Google Cloud コンソールから操作する場合は GKE クラスタ画面の「+作成」ボタンをクリックし、GKE Autopilot クラスタの作成画面へと遷移します。</p><p><img loading=lazy src=images/04-select-gke-cluster-type.png alt=04-select-gke-cluster-type.png></p><p>Autopilot クラスタの作成画面では、クラスタを展開するネットワークの選択とリリースチャンネルの選択をしていきます。今回はセキュリティの観点から限定公開クラスタに設定し、GKE Autopilot リリースチャンネルには Anthos Service Mesh が現時点で唯一サポート対象としている Rapid チャンネルを指定しています。作成ボタンを押してからクラスタの作成が完了するまで 5 分程度かかりました。</p><p><img loading=lazy src=images/05-create-gke-autopilot-cluster.png alt=05-create-gke-autopilot-cluster.png></p><p>なお、Anthos Service Mesh がサポートする GKE Autopilot リリースチャンネルについては近い将来変更が生じる可能性が高いため、構築を行う際には最新のサポート状況を公式ドキュメントから確認するようにしましょう。</p><p><a href=https://cloud.google.com/service-mesh/docs/supported-features-mcp>https://cloud.google.com/service-mesh/docs/supported-features-mcp</a></p><h3 id=step3-anthos-service-mesh-のインストール>Step3. Anthos Service Mesh のインストール<a hidden class=anchor aria-hidden=true href=#step3-anthos-service-mesh-のインストール>#</a></h3><p>ここからは Cloud Shell から操作を実施していきたいと思います。まずは Kubernetes API へ接続できるように GKE コントロールプレーンの承認済みネットワークに Cloud Shell の IP アドレスを登録し、<code>kubectl</code> を実行できるようにクラスタ認証情報を取得します。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>クラスタ認証情報の取得</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export PROJECT_ID<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>gcloud config list --format <span style=color:#e6db74>&#34;value(core.project)&#34;</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>export CLUSTER_NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;matt-tokyo-autopilot-cluster-001&#34;</span>
</span></span><span style=display:flex><span>export CLUSTER_LOCATION<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;asia-northeast1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># CloudShellの承認済みネットワーク登録</span>
</span></span><span style=display:flex><span>gcloud container clusters update <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --region <span style=color:#e6db74>${</span>CLUSTER_LOCATION<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --enable-master-authorized-networks <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --master-authorized-networks <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#e6db74>&#34;`dig +short myip.opendns.com @resolver1.opendns.com`/32&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># クラスタ認証情報の取得</span>
</span></span><span style=display:flex><span>gcloud container clusters get-credentials <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --region <span style=color:#e6db74>${</span>CLUSTER_LOCATION<span style=color:#e6db74>}</span></span></span></code></pre></div></div></figure><p>次に Anthos Service Mesh v1.11 から正式な管理ツールとなった <code>asmcli</code> をダウンロードします。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>asmcliツールのダウンロード</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://storage.googleapis.com/csm-artifacts/asm/asmcli_1.11 &gt; asmcli
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 実行権限の付与</span>
</span></span><span style=display:flex><span>chmod +x asmcli</span></span></code></pre></div></div></figure><p><code>asmcli</code> を使って GKE Autopilot クラスタに Rapid チャンネル(※1)の Anthos Service Mesh をインストールします。コマンドが完了するまでおおよそ 5 分程度かかりました。</p><p>※1: 現時点では GKE Autopilot は Anthos Service Mesh の Rapid チャンネルでのみサポートされているため</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>AnthosServiceMeshのインストール</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./asmcli x install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --project_id <span style=color:#e6db74>${</span>PROJECT_ID<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --cluster_location <span style=color:#e6db74>${</span>CLUSTER_LOCATION<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --cluster_name <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --managed <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --use_managed_cni <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --channel <span style=color:#e6db74>&#34;rapid&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --enable-all <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --output_dir <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span></span></span></code></pre></div></div></figure><p>インストールに成功した場合は次のようなメッセージが出力されます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>インストール成功時のメッセージ出力</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>asmcli: Successfully installed ASM.</span></span></code></pre></div></div></figure><h3 id=step4-ファイアウォールルールの更新-限定公開クラスタ時のみ>Step4. ファイアウォールルールの更新 (限定公開クラスタ時のみ)<a hidden class=anchor aria-hidden=true href=#step4-ファイアウォールルールの更新-限定公開クラスタ時のみ>#</a></h3><p>限定公開クラスタに Anthos Service Mesh をインストールした場合は、コントロールプレーンからのポート 15017 による通信を追加で許可する必要があります。まず次のコマンドを実行し、既存のファイアウォールルール名を取得します。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>ファイアウォールルールの確認</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute firewall-rules list --filter<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;name~</span><span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>-.*-master&#34;</span></span></span></code></pre></div></div></figure><p>次のコマンドのファイアウォールルール名 <code>${FIREWALL_RULE_NAME}</code> を前のコマンドで取得した名前に置き替え、コマンド実行してコントロールプレーンからのポート 15017 による通信を許可します。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>ファイアウォールルールの更新</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcloud compute firewall-rules update <span style=color:#e6db74>${</span>FIREWALL_RULE_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --allow tcp:10250,tcp:443,tcp:15017</span></span></code></pre></div></div></figure><h3 id=step5-マネージドデータプレーンの有効化-namespace-毎に設定>Step5. マネージドデータプレーンの有効化 (Namespace 毎に設定)<a hidden class=anchor aria-hidden=true href=#step5-マネージドデータプレーンの有効化-namespace-毎に設定>#</a></h3><p>マネージドデータプレーンは Kubernetes Namespace リソースごとにアノテーションを設定して有効化を行います。次のコマンドの <code>${NAMESPACE_NAME}</code> を設定対象の Namespace 名に置き替え、コマンド実行してマネージドデータプレーンを有効化します。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>マネージドデータプレーンの有効化</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl annotate --overwrite namespace <span style=color:#e6db74>${</span>NAMESPACE_NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    mesh.cloud.google.com/proxy<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{&#34;managed&#34;:&#34;true&#34;}&#39;</span></span></span></code></pre></div></div></figure><h3 id=step6-ingress-gateway-のデプロイ>Step6. Ingress Gateway のデプロイ<a hidden class=anchor aria-hidden=true href=#step6-ingress-gateway-のデプロイ>#</a></h3><p><code>asmcli</code> でインストールした場合は自動で Ingress Gateway はデプロイされないため、メッシュ外からのアクセスをさせるためには Ingress Gateway をデプロイする必要があります。まず次のコマンドで istio-gateway Namespace を新たに作成します。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>IngressGateway用のNamespace作成</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export GATEWAY_NAMESPACE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;istio-gateway&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl apply -f - <span style=color:#e6db74>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: Namespace
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  name: ${GATEWAY_NAMESPACE}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # マネージドデータプレーン有効化の設定
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mesh.cloud.google.com/proxy: &#39;{&#34;managed&#34;:&#34;true&#34;}&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  labels:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 自動サイドカーインジェクション(Rapid)有効化の設定
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    istio.io/rev: asm-managed-rapid
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span></span></span></code></pre></div></div></figure><p>次のコマンドを実行して Ingress Gateway をデプロイします。なお、今回は Anthos Service Mesh をインストールした際に <code>--output_dir</code> で指定したディレクトリに Ingress Gateway の定義ファイルが配置されているのでこちらをそのまま利用しています。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>IngressGatewayのデプロイ</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -n <span style=color:#e6db74>${</span>GATEWAY_NAMESPACE<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -f <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>/samples/gateways/istio-ingressgateway</span></span></code></pre></div></div></figure><p>なお、今回利用した Ingress Gateway の詳細については次の URL をご参照ください。</p><p><a href=https://github.com/GoogleCloudPlatform/anthos-service-mesh-packages/tree/main/samples/gateways/istio-ingressgateway>https://github.com/GoogleCloudPlatform/anthos-service-mesh-packages/tree/main/samples/gateways/istio-ingressgateway</a></p><p>以上でアプリケーションをデプロイする準備が整いました。</p><h3 id=step7-サンプルアプリケーションのデプロイ>Step7. サンプルアプリケーションのデプロイ<a hidden class=anchor aria-hidden=true href=#step7-サンプルアプリケーションのデプロイ>#</a></h3><p>最後にサンプルアプリケーションをデプロイし、環境に問題がないかを確認していきましょう。まず次のコマンドでサンプルアプリケーション用の Namespace を新たに作成します。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Namespaceの作成</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export SAMPLE_NAMESPACE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;sample&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># サンプルアプリケーション用 Namespace リソースの作成</span>
</span></span><span style=display:flex><span>kubectl apply -f - <span style=color:#e6db74>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kind: Namespace
</span></span></span><span style=display:flex><span><span style=color:#e6db74>metadata:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # マネージドデータプレーン有効化の設定
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mesh.cloud.google.com/proxy: &#39;{&#34;managed&#34;:&#34;true&#34;}&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  labels:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # 自動サイドカーインジェクション(Rapid)有効化の設定
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    istio.io/rev: asm-managed-rapid
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span></span></span></code></pre></div></div></figure><p>サンプルアプリケーションをデプロイします。今回は Anthos Service Mesh をインストールした際に <code>--output_dir</code> で指定したディレクトリに格納されているサンプルアプリケーションの中から HelloWorld というサンプルアプリケーションを使用しています。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>HelloWorldアプリケーションのデプロイ</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Kubernetes Service リソースのデプロイ</span>
</span></span><span style=display:flex><span>kubectl apply -n <span style=color:#e6db74>${</span>SAMPLE_NAMESPACE<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -f <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>/istio-1.11.2-asm.17/samples/helloworld/helloworld.yaml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -l service<span style=color:#f92672>=</span>helloworld
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Kubernetes Deployment リソースのデプロイ</span>
</span></span><span style=display:flex><span>kubectl apply -n <span style=color:#e6db74>${</span>SAMPLE_NAMESPACE<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -f <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>/istio-1.11.2-asm.17/samples/helloworld/helloworld.yaml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -l version<span style=color:#f92672>=</span>v1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Istio Gateway/VirtualService リソースのデプロイ</span>
</span></span><span style=display:flex><span>kubectl apply -n <span style=color:#e6db74>${</span>SAMPLE_NAMESPACE<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -f <span style=color:#e6db74>${</span>CLUSTER_NAME<span style=color:#e6db74>}</span>/istio-1.11.2-asm.17/samples/helloworld/helloworld-gateway.yaml</span></span></code></pre></div></div></figure><p>アプリケーションのデプロイが終わったので Ingress Gateway 経由でアプリケーションにアクセスできるかを確認していきましょう。まず次のコマンドを実行して Ingress Gateway の External IP アドレスを取得します。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>IngressGatewayの設定</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n <span style=color:#e6db74>${</span>GATEWAY_NAMESPACE<span style=color:#e6db74>}</span> get service istio-ingressgateway</span></span></code></pre></div></div></figure><p>External IP アドレスが取得できたら <code>curl</code> コマンドなどで <strong>http://&lt;EXTERNAL_IP>/hello</strong> にアクセスしてみましょう。次のようなメッセージが表示されていれば成功です。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>成功時のメッセージ</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>Hello version: v1, instance: helloworld-v1-xxxxxxxxxx-xxxxx</span></span></code></pre></div></div></figure><p>以上で構築は終わりです。お疲れ様でした。</p><h1 id=終わりに>終わりに<a hidden class=anchor aria-hidden=true href=#終わりに>#</a></h1><p>さて今回はプレビュー公開されたばかりの Google Kubernetes Engine(GKE) Autopilot と Anthos Service Mesh(ASM) を使ったフルマネージドなサービスメッシュ環境を構築する方法のご紹介でした。いかがだったでしょうか。</p><p>これで晴れて Kubernetes 部分も含めフルマネージドなサービスメッシュ環境が実現できるようになり、こちらの活用により従来よりも運用負荷を大きく軽減できる未来が近づいてきましたね。</p><p>もちろん安定性、保守性といった観点からプロダクション用途へのプレビュー段階の機能の適用は、現時点ではお勧めできませんが、もしこれから検証目的で試してみたいという方は参考にしてみてはいかがでしょうか。</p><hr><ul><li>Google Cloud は、Google LLC の商標または登録商標です。</li><li>その他、記載されている会社名および商品・製品・サービス名は、各社の商標または登録商標です。</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://chacco38.github.io/tags/google-cloud/>Google Cloud</a></li><li><a href=https://chacco38.github.io/tags/anthos-service-mesh/>Anthos Service Mesh</a></li><li><a href=https://chacco38.github.io/tags/google-kubernetes-enginegke/>Google Kubernetes Engine(GKE)</a></li><li><a href=https://chacco38.github.io/tags/gke-autopilot/>GKE Autopilot</a></li><li><a href=https://chacco38.github.io/tags/kubernetes/>Kubernetes</a></li><li><a href=https://chacco38.github.io/tags/istio/>Istio</a></li></ul><nav class=paginav><a class=prev href=https://chacco38.github.io/posts/2021/12/ghec-audit-log-cli/><span class=title>« Prev Page</span><br><span>GHEC Audit Log CLI を使って GitHub Enterprise Cloud の監査ログを取得してみた</span></a>
<a class=next href=https://chacco38.github.io/posts/2021/11/azure-sentinel-logicapps-data-connector-for-ghec/><span class=title>Next Page »</span><br><span>Microsoft Sentinel を使って GitHub Enterprise Cloud のセキュリティを強化しよう (Azure Logic Apps コネクタ編)</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share GKE Autopilot と Anthos Service Mesh を使ってフルマネージドなサービスメッシュ環境を構築してみた on twitter" href="https://twitter.com/intent/tweet/?text=GKE%20Autopilot%20%e3%81%a8%20Anthos%20Service%20Mesh%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%83%95%e3%83%ab%e3%83%9e%e3%83%8d%e3%83%bc%e3%82%b8%e3%83%89%e3%81%aa%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e3%83%a1%e3%83%83%e3%82%b7%e3%83%a5%e7%92%b0%e5%a2%83%e3%82%92%e6%a7%8b%e7%af%89%e3%81%97%e3%81%a6%e3%81%bf%e3%81%9f&url=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2fgcp-asm-with-gke-autopilot%2f&hashtags=GoogleCloud%2cAnthosServiceMesh%2cGoogleKubernetesEngine%28GKE%29%2cGKEAutopilot%2cKubernetes%2cIstio"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share GKE Autopilot と Anthos Service Mesh を使ってフルマネージドなサービスメッシュ環境を構築してみた on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2fgcp-asm-with-gke-autopilot%2f&title=GKE%20Autopilot%20%e3%81%a8%20Anthos%20Service%20Mesh%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%83%95%e3%83%ab%e3%83%9e%e3%83%8d%e3%83%bc%e3%82%b8%e3%83%89%e3%81%aa%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e3%83%a1%e3%83%83%e3%82%b7%e3%83%a5%e7%92%b0%e5%a2%83%e3%82%92%e6%a7%8b%e7%af%89%e3%81%97%e3%81%a6%e3%81%bf%e3%81%9f&summary=GKE%20Autopilot%20%e3%81%a8%20Anthos%20Service%20Mesh%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%83%95%e3%83%ab%e3%83%9e%e3%83%8d%e3%83%bc%e3%82%b8%e3%83%89%e3%81%aa%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e3%83%a1%e3%83%83%e3%82%b7%e3%83%a5%e7%92%b0%e5%a2%83%e3%82%92%e6%a7%8b%e7%af%89%e3%81%97%e3%81%a6%e3%81%bf%e3%81%9f&source=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2fgcp-asm-with-gke-autopilot%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share GKE Autopilot と Anthos Service Mesh を使ってフルマネージドなサービスメッシュ環境を構築してみた on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2fgcp-asm-with-gke-autopilot%2f&title=GKE%20Autopilot%20%e3%81%a8%20Anthos%20Service%20Mesh%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%83%95%e3%83%ab%e3%83%9e%e3%83%8d%e3%83%bc%e3%82%b8%e3%83%89%e3%81%aa%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e3%83%a1%e3%83%83%e3%82%b7%e3%83%a5%e7%92%b0%e5%a2%83%e3%82%92%e6%a7%8b%e7%af%89%e3%81%97%e3%81%a6%e3%81%bf%e3%81%9f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share GKE Autopilot と Anthos Service Mesh を使ってフルマネージドなサービスメッシュ環境を構築してみた on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2fgcp-asm-with-gke-autopilot%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share GKE Autopilot と Anthos Service Mesh を使ってフルマネージドなサービスメッシュ環境を構築してみた on whatsapp" href="https://api.whatsapp.com/send?text=GKE%20Autopilot%20%e3%81%a8%20Anthos%20Service%20Mesh%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%83%95%e3%83%ab%e3%83%9e%e3%83%8d%e3%83%bc%e3%82%b8%e3%83%89%e3%81%aa%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e3%83%a1%e3%83%83%e3%82%b7%e3%83%a5%e7%92%b0%e5%a2%83%e3%82%92%e6%a7%8b%e7%af%89%e3%81%97%e3%81%a6%e3%81%bf%e3%81%9f%20-%20https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2fgcp-asm-with-gke-autopilot%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share GKE Autopilot と Anthos Service Mesh を使ってフルマネージドなサービスメッシュ環境を構築してみた on telegram" href="https://telegram.me/share/url?text=GKE%20Autopilot%20%e3%81%a8%20Anthos%20Service%20Mesh%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%83%95%e3%83%ab%e3%83%9e%e3%83%8d%e3%83%bc%e3%82%b8%e3%83%89%e3%81%aa%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e3%83%a1%e3%83%83%e3%82%b7%e3%83%a5%e7%92%b0%e5%a2%83%e3%82%92%e6%a7%8b%e7%af%89%e3%81%97%e3%81%a6%e3%81%bf%e3%81%9f&url=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2fgcp-asm-with-gke-autopilot%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>© 2022 Satoshi Matsuzawa</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>