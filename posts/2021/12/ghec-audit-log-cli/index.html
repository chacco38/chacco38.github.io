<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>GHEC Audit Log CLI を使って GitHub Enterprise Cloud の監査ログを取得してみた | クラウドCoEの何でも屋</title><meta name=keywords content="GitHub,GitHub Actions"><meta name=description content="はじめに みなさん、こんにちは。今回は GitHub Enterprise Cloud(GHEC) の監査ログ(Audit Log) の取得方法についてのお話です。
GHEC 監査ログの取得方法としてはいくつか方法はあるのですが、この記事では GHEC の監査ログを取得するためのコマンドラインインタフェースである GHEC Audit Log CLI を使った方法をご紹介していきたいと思います。
https://github.com/github/ghec-audit-log-cli
GHEC Audit Log CLI を使ってみよう 今回は Linux(AWS CloudShell) 上に環境を作って試しに実行してみるところからはじめて、定期的に監査ログ取得を行う自動化フローの構築まで紹介していきたいと思います。
ローカル環境で実行してみよう Step1. 前提パッケージのインストール GHEC Audit Log CLI の前提パッケージとして Node.js が必要となります。GitHub からソースコードを入手する必要があるため、git コマンドと併せてインストールしましょう。
前提パッケージの導入 $ curl --silent --location https://rpm.nodesource.com/setup_16.x | sudo bash - $ sudo yum install -y nodejs git  Step2. GHEC Audit Log CLI のインストール GitHub からソースコードを取得し、npm コマンドを使って GHEC Audit Log CLI をインストールします。最後の ghce-audit-log-cli -v コマンドにてバージョン情報が出力されれば CLI のインストールは完了です。"><meta name=author content><link rel=canonical href=https://chacco38.github.io/posts/2021/12/ghec-audit-log-cli/><link crossorigin=anonymous href=/assets/css/stylesheet.min.317d4c109e98a8137e18d0fd1222603a2a157f4e40f59a79576eb3861cc09531.css integrity="sha256-MX1MEJ6YqBN+GND9EiJgOioVf05A9Zp5V26zhhzAlTE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://chacco38.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://chacco38.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://chacco38.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://chacco38.github.io/apple-touch-icon.png><link rel=mask-icon href=https://chacco38.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="GHEC Audit Log CLI を使って GitHub Enterprise Cloud の監査ログを取得してみた"><meta property="og:description" content="はじめに みなさん、こんにちは。今回は GitHub Enterprise Cloud(GHEC) の監査ログ(Audit Log) の取得方法についてのお話です。
GHEC 監査ログの取得方法としてはいくつか方法はあるのですが、この記事では GHEC の監査ログを取得するためのコマンドラインインタフェースである GHEC Audit Log CLI を使った方法をご紹介していきたいと思います。
https://github.com/github/ghec-audit-log-cli
GHEC Audit Log CLI を使ってみよう 今回は Linux(AWS CloudShell) 上に環境を作って試しに実行してみるところからはじめて、定期的に監査ログ取得を行う自動化フローの構築まで紹介していきたいと思います。
ローカル環境で実行してみよう Step1. 前提パッケージのインストール GHEC Audit Log CLI の前提パッケージとして Node.js が必要となります。GitHub からソースコードを入手する必要があるため、git コマンドと併せてインストールしましょう。
前提パッケージの導入 $ curl --silent --location https://rpm.nodesource.com/setup_16.x | sudo bash - $ sudo yum install -y nodejs git  Step2. GHEC Audit Log CLI のインストール GitHub からソースコードを取得し、npm コマンドを使って GHEC Audit Log CLI をインストールします。最後の ghce-audit-log-cli -v コマンドにてバージョン情報が出力されれば CLI のインストールは完了です。"><meta property="og:type" content="article"><meta property="og:url" content="https://chacco38.github.io/posts/2021/12/ghec-audit-log-cli/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-07T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-07T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="GHEC Audit Log CLI を使って GitHub Enterprise Cloud の監査ログを取得してみた"><meta name=twitter:description content="はじめに みなさん、こんにちは。今回は GitHub Enterprise Cloud(GHEC) の監査ログ(Audit Log) の取得方法についてのお話です。
GHEC 監査ログの取得方法としてはいくつか方法はあるのですが、この記事では GHEC の監査ログを取得するためのコマンドラインインタフェースである GHEC Audit Log CLI を使った方法をご紹介していきたいと思います。
https://github.com/github/ghec-audit-log-cli
GHEC Audit Log CLI を使ってみよう 今回は Linux(AWS CloudShell) 上に環境を作って試しに実行してみるところからはじめて、定期的に監査ログ取得を行う自動化フローの構築まで紹介していきたいと思います。
ローカル環境で実行してみよう Step1. 前提パッケージのインストール GHEC Audit Log CLI の前提パッケージとして Node.js が必要となります。GitHub からソースコードを入手する必要があるため、git コマンドと併せてインストールしましょう。
前提パッケージの導入 $ curl --silent --location https://rpm.nodesource.com/setup_16.x | sudo bash - $ sudo yum install -y nodejs git  Step2. GHEC Audit Log CLI のインストール GitHub からソースコードを取得し、npm コマンドを使って GHEC Audit Log CLI をインストールします。最後の ghce-audit-log-cli -v コマンドにてバージョン情報が出力されれば CLI のインストールは完了です。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://chacco38.github.io/posts/"},{"@type":"ListItem","position":2,"name":"GHEC Audit Log CLI を使って GitHub Enterprise Cloud の監査ログを取得してみた","item":"https://chacco38.github.io/posts/2021/12/ghec-audit-log-cli/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"GHEC Audit Log CLI を使って GitHub Enterprise Cloud の監査ログを取得してみた","name":"GHEC Audit Log CLI を使って GitHub Enterprise Cloud の監査ログを取得してみた","description":"はじめに みなさん、こんにちは。今回は GitHub Enterprise Cloud(GHEC) の監査ログ(Audit Log) の取得方法についてのお話です。\nGHEC 監査ログの取得方法としてはいくつか方法はあるのですが、この記事では GHEC の監査ログを取得するためのコマンドラインインタフェースである GHEC Audit Log CLI を使った方法をご紹介していきたいと思います。\nhttps://github.com/github/ghec-audit-log-cli\nGHEC Audit Log CLI を使ってみよう 今回は Linux(AWS CloudShell) 上に環境を作って試しに実行してみるところからはじめて、定期的に監査ログ取得を行う自動化フローの構築まで紹介していきたいと思います。\nローカル環境で実行してみよう Step1. 前提パッケージのインストール GHEC Audit Log CLI の前提パッケージとして Node.js が必要となります。GitHub からソースコードを入手する必要があるため、git コマンドと併せてインストールしましょう。\n前提パッケージの導入 $ curl --silent --location https://rpm.nodesource.com/setup_16.x | sudo bash - $ sudo yum install -y nodejs git  Step2. GHEC Audit Log CLI のインストール GitHub からソースコードを取得し、npm コマンドを使って GHEC Audit Log CLI をインストールします。最後の ghce-audit-log-cli -v コマンドにてバージョン情報が出力されれば CLI のインストールは完了です。","keywords":["GitHub","GitHub Actions"],"articleBody":"はじめに みなさん、こんにちは。今回は GitHub Enterprise Cloud(GHEC) の監査ログ(Audit Log) の取得方法についてのお話です。\nGHEC 監査ログの取得方法としてはいくつか方法はあるのですが、この記事では GHEC の監査ログを取得するためのコマンドラインインタフェースである GHEC Audit Log CLI を使った方法をご紹介していきたいと思います。\nhttps://github.com/github/ghec-audit-log-cli\nGHEC Audit Log CLI を使ってみよう 今回は Linux(AWS CloudShell) 上に環境を作って試しに実行してみるところからはじめて、定期的に監査ログ取得を行う自動化フローの構築まで紹介していきたいと思います。\nローカル環境で実行してみよう Step1. 前提パッケージのインストール GHEC Audit Log CLI の前提パッケージとして Node.js が必要となります。GitHub からソースコードを入手する必要があるため、git コマンドと併せてインストールしましょう。\n前提パッケージの導入 $ curl --silent --location https://rpm.nodesource.com/setup_16.x | sudo bash - $ sudo yum install -y nodejs git  Step2. GHEC Audit Log CLI のインストール GitHub からソースコードを取得し、npm コマンドを使って GHEC Audit Log CLI をインストールします。最後の ghce-audit-log-cli -v コマンドにてバージョン情報が出力されれば CLI のインストールは完了です。\nソースコード取得とインストール $ git clone https://github.com/github/ghec-audit-log-cli.git $ cd ghec-audit-log-cli $ sudo npm link $ ghec-audit-log-cli -v 2.1.2 $ ghec-audit-log-cli --help Usage: ghec-audit-log-cli [options]  Options:  -v, --version Output the current version  -t, --token  the token to access the API (mandatory)  -o, --org  the organization we want to extract the audit log from  -cfg, --config  location for the config yaml file. Default \".ghec-audit-log\"  (default: \"./.ghec-audit-log\")  -p, --pretty prints the json data in a readable format (default: false)  -l, --limit  a maximum limit on the number of items retrieved  -f, --file  the output file where the result should be printed  -a, --api  the version of GitHub API to call (default: \"v4\")  -at, --api-type  Only if -a is v3. API type to bring, either all, web or git  (default: \"all\")  -c, --cursor  if provided, this cursor will be used to query the newest  entries from the cursor provided. If not present, the result  will contain all the audit log from the org  -s, --source  the source of the audit log. The source can be either a  GitHub Enterprise or a GitHub Enterprise Organization.  Accepts the following values: org | enterprise. Defaults to  org (default: \"org\")  -h, --help display help for command  Step3. GitHub アクセストークンの取得 次に GitHub のサイトへ移り、GitHub API へアクセスする際に利用するアクセストークンを作成します。Organization の Owner 権限を持つユーザで、Settings  Developer settings  Personal access tokens  Generate new tokens から作成しましょう。付与するスコープについては筆者の環境では次の 4 つの権限を付与することで動作を確認することができました。\n public_repo admin:org read:user admin:enterprise  Step4. GHEC Audit Log CLI の動作確認 ここまで来たら実際にコマンドを実行して監査ログが取得できるか試してみましょう。次のコマンドを実行して監査ログが出力されれば成功です。\n監査ログの取得 $ export ORG_NAME=\"Your GitHub organization account name\" $ export AUDIT_LOG_TOKEN=\"Your GitHub access token\"  $ ghec-audit-log-cli --org ${ORG_NAME} --token ${AUDIT_LOG_TOKEN} --api \"v3\" --pretty  なお、GitHub アクセストークンに付与した権限が足りない場合は次のようなメッセージを出力してコマンドがエラー終了します。エラーメッセージに不足している権限についての情報がありますので Step3 へ戻り、アクセストークンへ不足する権限を追加して再度 CLI を実行してください。\nコマンド失敗時の出力エラーメッセージ例 GraphqlError: Your token has not been granted the required scopes to execute this query. The 'organizationBillingEmail' field requires one of the following scopes: ['admin:org'], but your token has only been granted the: ['admin:enterprise', 'read:org'] scopes. Please modify your token's scopes at: https://github.com/settings/tokens.  以上で無事にローカル環境で GHEC Audit Log CLI を実行することができました。\n監査ログを取得するフローを自動化しよう 次は定期的に監査ログ取得を行う自動化フローの構築を行っていきたいと思います。今回はサンプルとして用意されているワークフロー定義を少し改造し、「1 時間ごと GHEC Audit Log CLI を使って監査ログを取得し、監査ログ格納用のリポジトリに追加する」といったフローを GitHub Actions を使って自動化していきたいと思います。\nStep1. 監査ログ格納用リポジトリの作成 まずは対象 Organization に監査ログを取得、格納するためのリポジトリを作成しましょう。今回は ghec-audit-log-cli という名前のリポジトリを作成しています。\nStep2. シークレットの登録 次にアクセストークンなどの機密性の高い情報をワークフローに渡すために Organization 設定にてシークレットの登録を行います。シークレットは次の 3 種類を登録しましょう。\n   シークレット名 説明     ORG_NAME 監査ログを取得する対象の Organization アカウント名を指定   AUDIT_LOG_TOKEN GitHub Audit Log API へアクセスする際に利用するアクセストークンを指定   COMMITTER_EMAIL 監査ログなどをリポジトリに Push するアカウントのメールアドレスを指定    Step3. GHEC Audit Log CLI のソースコード登録 GHEC Audit Log CLI のソースコードを取得し、新しく作成したリポジトリへソースコードを登録をしましょう。\nソースコードの登録 $ export ORG_NAME=\"Your GitHub organization account name\"  $ git clone https://github.com/github/ghec-audit-log-cli.git $ cd ghec-audit-log-cli  $ git remote add logging https://github.com/${ORG_NAME}/ghec-audit-log-cli.git $ git push -u logging main  Step4. ワークフロー定義の作成 次にサンプルのワークフロー定義が workflows ディレクトリに用意されていますので、こちらをベースにワークフロー定義を作成していきたいと思います。なお、v3 と v4 の 2 種類のサンプルが用意されていますが記事の執筆時点では ​v4 に不具合があったため v3 を利用しています。\nまずはサンプル定義ファイルを GitHub Actions 所定のディレクトリ .github/workflows へ複製します。\nサンプルワークフローを複製 $ cp workflows/forward-v3-workflow.yml .github/workflows/ghec-audit-log.yml  次に複製した .github/workflows/ghec-audit-log.yml ファイルを編集します。サンプルでは取得した監査ログを指定した URL へ POST するように定義されていますが、今回はこちらのリポジトリへコミットするように書き換えています。\n.github/workflows/ghec-audit-log.yml（差分）  ############################################  # Github Action Workflow to poll and aggregate logs #  ############################################  name: POLL/POST Audit Log Data from v3 API   ##############################################  # Run once an hour and when pushed to main #  ##############################################  on:  push:  branches: main  schedule:  - cron: '59 * * * *'   #################  # Build the job #  #################  jobs:  poll:  runs-on: ubuntu-latest   strategy:  matrix:  node-version: [12.x]   steps:  # Clone source code  - name: Checkout source code  uses: actions/checkout@v2   # Install congiure NodeJS  - name: Use Node.js ${{ matrix.node-version }}  uses: actions/setup-node@v1  with:  node-version: ${{ matrix.node-version }}   # Need to install NPM  - name: NPM Install  run: npm install   # If this is the first time we poll, then do a fresh poll. If not, poll from latest cursor.  - name: Poll from Cursor  run: | + FILE_SUFFIIX=$(date +%Y%m%d-%H%M) + mkdir -p audit-logs  if [ -f \".last-v3-cursor-update\" ]; then  LAST_CURSOR=$(cat .last-v3-cursor-update)  fi   if [ -z \"$LAST_CURSOR\" ]; then  echo \"FIRST TIME RUNNING AUDIT LOG POLL\" - npm start -- --token ${{secrets.AUDIT_LOG_TOKEN}} --org ${{secrets.ORG_NAME}} --api 'v3' --api-type 'all' --file \"audit-log-output.json\" + npm start -- --token ${{secrets.AUDIT_LOG_TOKEN}} \\ + --org ${{secrets.ORG_NAME}} --api 'v3' --api-type 'all' \\ + --file \"audit-logs/audit-log-output-${FILE_SUFFIIX}.json\" --pretty  else  echo \"RUNNING AUDIT LOG POLL FROM $LAST_CURSOR\" - npm start -- --token ${{secrets.AUDIT_LOG_TOKEN}} --org ${{secrets.ORG_NAME}} --api 'v3' --api-type 'all' --cursor $LAST_CURSOR --file \"audit-log-output.json\" + npm start -- --token ${{secrets.AUDIT_LOG_TOKEN}} \\ + --org ${{secrets.ORG_NAME}} --api 'v3' --api-type 'all' \\ + --cursor $LAST_CURSOR \\ + --file \"audit-logs/audit-log-output-${FILE_SUFFIIX}.json\" --pretty  fi - curl -X POST -H \"Content-Type: application/json\" -d @audit-log-output.json ${{secrets.WEBHOOK_URL}}   # Commit the cursor back to source  - name: Commit cursor  uses: EndBug/add-and-commit@v5  with:  author_name: Audit Log Integration  author_email: ${{ secrets.COMMITTER_EMAIL }}  message: \"Updating cursor for audit log\"  add: \".last-v3-cursor-update --force\"  env:  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} + - name: Commit audit log + uses: EndBug/add-and-commit@v5 + with: + author_name: Audit Log Integration + author_email: ${{ secrets.COMMITTER_EMAIL }} + message: \"Adding audit log\" + add: \"audit-logs/audit-log-output-*.json --force\" + env: + GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}   最後に定義ファイルをコミットして、リモートリポジトリへ登録しましょう。\nリポジトリにワークフローの登録 $ git add .github/workflows/ghec-audit-log.yml $ git commit -m \"add ghec-audit-log workflow\" $ git push -u logging main  このリポジトリへの Push をトリガーに GitHub Actions が起動しますので、この後はワークフローが期待通り動作しているかを確認していきましょう。\nStep5. ワークフローの動作確認 まずは GitHub Actions 画面へ遷移し、ワークフローの起動および処理が成功していることを確認します。出力例のように GitHub Actions のワークフロー実行履歴にて成功が記録されていれば OK です。\n次に監査ログが正しく格納されているか確認しましょう。出力例のように監査ログの格納が確認できれば OK です。\n以上でワークフローの設定も完了です。お疲れ様でした。以降はワークフローに定義したスケジュールに沿って 1 時間ごとに監査ログがエクスポートされるようになるかと思います。\n終わりに 今回は GitHub Enterprise Cloud (GHEC) の監査ログを取得する方法でした。GHEC の監査ログを長期(90 日以上)保存したい方はエクスポートが必須となってきますので参考にしてみてはいかがでしょうか。\n  GitHub は、GitHub Inc. の商標または登録商標です。 その他、本資料に記述してある会社名、製品名は、各社の登録商品または商標です。  ","wordCount":"884","inLanguage":"en","datePublished":"2021-12-07T00:00:00Z","dateModified":"2021-12-07T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://chacco38.github.io/posts/2021/12/ghec-audit-log-cli/"},"publisher":{"@type":"Organization","name":"クラウドCoEの何でも屋","logo":{"@type":"ImageObject","url":"https://chacco38.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://chacco38.github.io/ accesskey=h title="クラウドCoEの何でも屋 (Alt + H)">クラウドCoEの何でも屋</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://chacco38.github.io/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://chacco38.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://chacco38.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://chacco38.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://chacco38.github.io/posts/>Posts</a></div><h1 class=post-title>GHEC Audit Log CLI を使って GitHub Enterprise Cloud の監査ログを取得してみた</h1><div class=post-meta><span title="2021-12-07 00:00:00 +0000 UTC">December 7, 2021</span>&nbsp;·&nbsp;5 min&nbsp;|&nbsp;<a href=https://github.com/chacco38/chacco38.github.io/tree/main/content/posts/2021/12/ghec-audit-log-cli/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e3%81%af%e3%81%98%e3%82%81%e3%81%ab aria-label=はじめに>はじめに</a></li><li><a href=#ghec-audit-log-cli-%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%81%bf%e3%82%88%e3%81%86 aria-label="GHEC Audit Log CLI を使ってみよう">GHEC Audit Log CLI を使ってみよう</a><ul><li><a href=#%e3%83%ad%e3%83%bc%e3%82%ab%e3%83%ab%e7%92%b0%e5%a2%83%e3%81%a7%e5%ae%9f%e8%a1%8c%e3%81%97%e3%81%a6%e3%81%bf%e3%82%88%e3%81%86 aria-label=ローカル環境で実行してみよう>ローカル環境で実行してみよう</a><ul><li><a href=#step1-%e5%89%8d%e6%8f%90%e3%83%91%e3%83%83%e3%82%b1%e3%83%bc%e3%82%b8%e3%81%ae%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab aria-label="Step1. 前提パッケージのインストール">Step1. 前提パッケージのインストール</a></li><li><a href=#step2-ghec-audit-log-cli-%e3%81%ae%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab aria-label="Step2. GHEC Audit Log CLI のインストール">Step2. GHEC Audit Log CLI のインストール</a></li><li><a href=#step3-github-%e3%82%a2%e3%82%af%e3%82%bb%e3%82%b9%e3%83%88%e3%83%bc%e3%82%af%e3%83%b3%e3%81%ae%e5%8f%96%e5%be%97 aria-label="Step3. GitHub アクセストークンの取得">Step3. GitHub アクセストークンの取得</a></li><li><a href=#step4-ghec-audit-log-cli-%e3%81%ae%e5%8b%95%e4%bd%9c%e7%a2%ba%e8%aa%8d aria-label="Step4. GHEC Audit Log CLI の動作確認">Step4. GHEC Audit Log CLI の動作確認</a></li></ul></li><li><a href=#%e7%9b%a3%e6%9f%bb%e3%83%ad%e3%82%b0%e3%82%92%e5%8f%96%e5%be%97%e3%81%99%e3%82%8b%e3%83%95%e3%83%ad%e3%83%bc%e3%82%92%e8%87%aa%e5%8b%95%e5%8c%96%e3%81%97%e3%82%88%e3%81%86 aria-label=監査ログを取得するフローを自動化しよう>監査ログを取得するフローを自動化しよう</a><ul><li><a href=#step1-%e7%9b%a3%e6%9f%bb%e3%83%ad%e3%82%b0%e6%a0%bc%e7%b4%8d%e7%94%a8%e3%83%aa%e3%83%9d%e3%82%b8%e3%83%88%e3%83%aa%e3%81%ae%e4%bd%9c%e6%88%90 aria-label="Step1. 監査ログ格納用リポジトリの作成">Step1. 監査ログ格納用リポジトリの作成</a></li><li><a href=#step2-%e3%82%b7%e3%83%bc%e3%82%af%e3%83%ac%e3%83%83%e3%83%88%e3%81%ae%e7%99%bb%e9%8c%b2 aria-label="Step2. シークレットの登録">Step2. シークレットの登録</a></li><li><a href=#step3-ghec-audit-log-cli-%e3%81%ae%e3%82%bd%e3%83%bc%e3%82%b9%e3%82%b3%e3%83%bc%e3%83%89%e7%99%bb%e9%8c%b2 aria-label="Step3. GHEC Audit Log CLI のソースコード登録">Step3. GHEC Audit Log CLI のソースコード登録</a></li><li><a href=#step4-%e3%83%af%e3%83%bc%e3%82%af%e3%83%95%e3%83%ad%e3%83%bc%e5%ae%9a%e7%be%a9%e3%81%ae%e4%bd%9c%e6%88%90 aria-label="Step4. ワークフロー定義の作成">Step4. ワークフロー定義の作成</a></li><li><a href=#step5-%e3%83%af%e3%83%bc%e3%82%af%e3%83%95%e3%83%ad%e3%83%bc%e3%81%ae%e5%8b%95%e4%bd%9c%e7%a2%ba%e8%aa%8d aria-label="Step5. ワークフローの動作確認">Step5. ワークフローの動作確認</a></li></ul></li></ul></li><li><a href=#%e7%b5%82%e3%82%8f%e3%82%8a%e3%81%ab aria-label=終わりに>終わりに</a></li></ul></div></details></div><div class=post-content><h1 id=はじめに>はじめに<a hidden class=anchor aria-hidden=true href=#はじめに>#</a></h1><p>みなさん、こんにちは。今回は GitHub Enterprise Cloud(GHEC) の監査ログ(Audit Log) の取得方法についてのお話です。</p><p>GHEC 監査ログの取得方法としてはいくつか方法はあるのですが、この記事では GHEC の監査ログを取得するためのコマンドラインインタフェースである GHEC Audit Log CLI を使った方法をご紹介していきたいと思います。</p><p><a href=https://github.com/github/ghec-audit-log-cli>https://github.com/github/ghec-audit-log-cli</a></p><h1 id=ghec-audit-log-cli-を使ってみよう>GHEC Audit Log CLI を使ってみよう<a hidden class=anchor aria-hidden=true href=#ghec-audit-log-cli-を使ってみよう>#</a></h1><p>今回は Linux(AWS CloudShell) 上に環境を作って試しに実行してみるところからはじめて、定期的に監査ログ取得を行う自動化フローの構築まで紹介していきたいと思います。</p><h2 id=ローカル環境で実行してみよう>ローカル環境で実行してみよう<a hidden class=anchor aria-hidden=true href=#ローカル環境で実行してみよう>#</a></h2><h3 id=step1-前提パッケージのインストール>Step1. 前提パッケージのインストール<a hidden class=anchor aria-hidden=true href=#step1-前提パッケージのインストール>#</a></h3><p>GHEC Audit Log CLI の前提パッケージとして Node.js が必要となります。GitHub からソースコードを入手する必要があるため、git コマンドと併せてインストールしましょう。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>前提パッケージの導入</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl --silent --location https://rpm.nodesource.com/setup_16.x | sudo bash -
</span></span><span style=display:flex><span>$ sudo yum install -y nodejs git</span></span></code></pre></div></div></figure><h3 id=step2-ghec-audit-log-cli-のインストール>Step2. GHEC Audit Log CLI のインストール<a hidden class=anchor aria-hidden=true href=#step2-ghec-audit-log-cli-のインストール>#</a></h3><p>GitHub からソースコードを取得し、npm コマンドを使って GHEC Audit Log CLI をインストールします。最後の <code>ghce-audit-log-cli -v</code> コマンドにてバージョン情報が出力されれば CLI のインストールは完了です。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>ソースコード取得とインストール</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ git clone https://github.com/github/ghec-audit-log-cli.git
</span></span><span style=display:flex><span>$ cd ghec-audit-log-cli
</span></span><span style=display:flex><span>$ sudo npm link
</span></span><span style=display:flex><span>$ ghec-audit-log-cli -v
</span></span><span style=display:flex><span>2.1.2
</span></span><span style=display:flex><span>$ ghec-audit-log-cli --help
</span></span><span style=display:flex><span>Usage: ghec-audit-log-cli <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Options:
</span></span><span style=display:flex><span>  -v, --version             Output the current version
</span></span><span style=display:flex><span>  -t, --token &lt;string&gt;      the token to access the API <span style=color:#f92672>(</span>mandatory<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  -o, --org &lt;string&gt;        the organization we want to extract the audit log from
</span></span><span style=display:flex><span>  -cfg, --config &lt;string&gt;   location <span style=color:#66d9ef>for</span> the config yaml file. Default <span style=color:#e6db74>&#34;.ghec-audit-log&#34;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>(</span>default: <span style=color:#e6db74>&#34;./.ghec-audit-log&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  -p, --pretty              prints the json data in a readable format <span style=color:#f92672>(</span>default: false<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  -l, --limit &lt;number&gt;      a maximum limit on the number of items retrieved
</span></span><span style=display:flex><span>  -f, --file &lt;string&gt;       the output file where the result should be printed
</span></span><span style=display:flex><span>  -a, --api &lt;string&gt;        the version of GitHub API to call <span style=color:#f92672>(</span>default: <span style=color:#e6db74>&#34;v4&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  -at, --api-type &lt;string&gt;  Only <span style=color:#66d9ef>if</span> -a is v3. API type to bring, either all, web or git
</span></span><span style=display:flex><span>                            <span style=color:#f92672>(</span>default: <span style=color:#e6db74>&#34;all&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  -c, --cursor &lt;string&gt;     <span style=color:#66d9ef>if</span> provided, this cursor will be used to query the newest
</span></span><span style=display:flex><span>                            entries from the cursor provided. If not present, the result
</span></span><span style=display:flex><span>                            will contain all the audit log from the org
</span></span><span style=display:flex><span>  -s, --source &lt;string&gt;     the source of the audit log. The source can be either a
</span></span><span style=display:flex><span>                            GitHub Enterprise or a GitHub Enterprise Organization.
</span></span><span style=display:flex><span>                            Accepts the following values: org | enterprise. Defaults to
</span></span><span style=display:flex><span>                            org <span style=color:#f92672>(</span>default: <span style=color:#e6db74>&#34;org&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  -h, --help                display help <span style=color:#66d9ef>for</span> command</span></span></code></pre></div></div></figure><h3 id=step3-github-アクセストークンの取得>Step3. GitHub アクセストークンの取得<a hidden class=anchor aria-hidden=true href=#step3-github-アクセストークンの取得>#</a></h3><p>次に GitHub のサイトへ移り、GitHub API へアクセスする際に利用するアクセストークンを作成します。Organization の Owner 権限を持つユーザで、Settings > Developer settings > Personal access tokens > Generate new tokens から作成しましょう。付与するスコープについては筆者の環境では次の 4 つの権限を付与することで動作を確認することができました。</p><ul><li>public_repo</li><li>admin:org</li><li>read:user</li><li>admin:enterprise</li></ul><h3 id=step4-ghec-audit-log-cli-の動作確認>Step4. GHEC Audit Log CLI の動作確認<a hidden class=anchor aria-hidden=true href=#step4-ghec-audit-log-cli-の動作確認>#</a></h3><p>ここまで来たら実際にコマンドを実行して監査ログが取得できるか試してみましょう。次のコマンドを実行して監査ログが出力されれば成功です。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>監査ログの取得</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ export ORG_NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Your GitHub organization account name&#34;</span>
</span></span><span style=display:flex><span>$ export AUDIT_LOG_TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Your GitHub access token&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ ghec-audit-log-cli --org <span style=color:#e6db74>${</span>ORG_NAME<span style=color:#e6db74>}</span> --token <span style=color:#e6db74>${</span>AUDIT_LOG_TOKEN<span style=color:#e6db74>}</span> --api <span style=color:#e6db74>&#34;v3&#34;</span> --pretty</span></span></code></pre></div></div></figure><p>なお、GitHub アクセストークンに付与した権限が足りない場合は次のようなメッセージを出力してコマンドがエラー終了します。エラーメッセージに不足している権限についての情報がありますので Step3 へ戻り、アクセストークンへ不足する権限を追加して再度 CLI を実行してください。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>コマンド失敗時の出力エラーメッセージ例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>GraphqlError: Your token has not been granted the required scopes to execute this query.
</span></span><span style=display:flex><span>The &#39;organizationBillingEmail&#39; field requires one of the following scopes: [&#39;admin:org&#39;],
</span></span><span style=display:flex><span>but your token has only been granted the: [&#39;admin:enterprise&#39;, &#39;read:org&#39;] scopes.
</span></span><span style=display:flex><span>Please modify your token&#39;s scopes at: https://github.com/settings/tokens.</span></span></code></pre></div></div></figure><p>以上で無事にローカル環境で GHEC Audit Log CLI を実行することができました。</p><h2 id=監査ログを取得するフローを自動化しよう>監査ログを取得するフローを自動化しよう<a hidden class=anchor aria-hidden=true href=#監査ログを取得するフローを自動化しよう>#</a></h2><p>次は定期的に監査ログ取得を行う自動化フローの構築を行っていきたいと思います。今回はサンプルとして用意されているワークフロー定義を少し改造し、「1 時間ごと GHEC Audit Log CLI を使って監査ログを取得し、監査ログ格納用のリポジトリに追加する」といったフローを GitHub Actions を使って自動化していきたいと思います。</p><h3 id=step1-監査ログ格納用リポジトリの作成>Step1. 監査ログ格納用リポジトリの作成<a hidden class=anchor aria-hidden=true href=#step1-監査ログ格納用リポジトリの作成>#</a></h3><p>まずは対象 Organization に監査ログを取得、格納するためのリポジトリを作成しましょう。今回は <code>ghec-audit-log-cli</code> という名前のリポジトリを作成しています。</p><p><img loading=lazy src=images/01-create-repository.png alt=01-create-repository.png></p><h3 id=step2-シークレットの登録>Step2. シークレットの登録<a hidden class=anchor aria-hidden=true href=#step2-シークレットの登録>#</a></h3><p>次にアクセストークンなどの機密性の高い情報をワークフローに渡すために Organization 設定にてシークレットの登録を行います。シークレットは次の 3 種類を登録しましょう。</p><table><thead><tr><th>シークレット名</th><th>説明</th></tr></thead><tbody><tr><td>ORG_NAME</td><td>監査ログを取得する対象の Organization アカウント名を指定</td></tr><tr><td>AUDIT_LOG_TOKEN</td><td>GitHub Audit Log API へアクセスする際に利用するアクセストークンを指定</td></tr><tr><td>COMMITTER_EMAIL</td><td>監査ログなどをリポジトリに Push するアカウントのメールアドレスを指定</td></tr></tbody></table><p><img loading=lazy src=images/02-create-secrets.png alt=02-create-secrets.png></p><h3 id=step3-ghec-audit-log-cli-のソースコード登録>Step3. GHEC Audit Log CLI のソースコード登録<a hidden class=anchor aria-hidden=true href=#step3-ghec-audit-log-cli-のソースコード登録>#</a></h3><p>GHEC Audit Log CLI のソースコードを取得し、新しく作成したリポジトリへソースコードを登録をしましょう。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>ソースコードの登録</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ export ORG_NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Your GitHub organization account name&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ git clone https://github.com/github/ghec-audit-log-cli.git
</span></span><span style=display:flex><span>$ cd ghec-audit-log-cli
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ git remote add logging https://github.com/<span style=color:#e6db74>${</span>ORG_NAME<span style=color:#e6db74>}</span>/ghec-audit-log-cli.git
</span></span><span style=display:flex><span>$ git push -u logging main</span></span></code></pre></div></div></figure><h3 id=step4-ワークフロー定義の作成>Step4. ワークフロー定義の作成<a hidden class=anchor aria-hidden=true href=#step4-ワークフロー定義の作成>#</a></h3><p>次にサンプルのワークフロー定義が <code>workflows</code> ディレクトリに用意されていますので、こちらをベースにワークフロー定義を作成していきたいと思います。なお、v3 と v4 の 2 種類のサンプルが用意されていますが記事の執筆時点では ​v4 に不具合があったため <strong>v3</strong> を利用しています。</p><p>まずはサンプル定義ファイルを GitHub Actions 所定のディレクトリ <code>.github/workflows</code> へ複製します。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>サンプルワークフローを複製</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cp workflows/forward-v3-workflow.yml .github/workflows/ghec-audit-log.yml</span></span></code></pre></div></div></figure><p>次に複製した <code>.github/workflows/ghec-audit-log.yml</code> ファイルを編集します。サンプルでは取得した監査ログを指定した URL へ POST するように定義されていますが、今回はこちらのリポジトリへコミットするように書き換えています。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>.github/workflows/ghec-audit-log.yml（差分）</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>  ############################################
</span></span><span style=display:flex><span>  # Github Action Workflow to poll and aggregate logs #
</span></span><span style=display:flex><span>  ############################################
</span></span><span style=display:flex><span>  name: POLL/POST Audit Log Data from v3 API
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ##############################################
</span></span><span style=display:flex><span>  # Run once an hour and when pushed to main #
</span></span><span style=display:flex><span>  ##############################################
</span></span><span style=display:flex><span>  on:
</span></span><span style=display:flex><span>    push:
</span></span><span style=display:flex><span>      branches: main
</span></span><span style=display:flex><span>    schedule:
</span></span><span style=display:flex><span>      - cron: &#39;59 * * * *&#39;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  #################
</span></span><span style=display:flex><span>  # Build the job #
</span></span><span style=display:flex><span>  #################
</span></span><span style=display:flex><span>  jobs:
</span></span><span style=display:flex><span>    poll:
</span></span><span style=display:flex><span>      runs-on: ubuntu-latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      strategy:
</span></span><span style=display:flex><span>        matrix:
</span></span><span style=display:flex><span>          node-version: [12.x]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      steps:
</span></span><span style=display:flex><span>      # Clone source code
</span></span><span style=display:flex><span>      - name: Checkout source code
</span></span><span style=display:flex><span>        uses: actions/checkout@v2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      # Install congiure NodeJS
</span></span><span style=display:flex><span>      - name: Use Node.js ${{ matrix.node-version }}
</span></span><span style=display:flex><span>        uses: actions/setup-node@v1
</span></span><span style=display:flex><span>        with:
</span></span><span style=display:flex><span>          node-version: ${{ matrix.node-version }}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      # Need to install NPM
</span></span><span style=display:flex><span>      - name: NPM Install
</span></span><span style=display:flex><span>        run: npm install
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        # If this is the first time we poll, then do a fresh poll. If not, poll from latest cursor.
</span></span><span style=display:flex><span>      - name: Poll from Cursor
</span></span><span style=display:flex><span>        run: |
</span></span><span style=display:flex><span><span style=color:#a6e22e>+         FILE_SUFFIIX=$(date +%Y%m%d-%H%M)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+         mkdir -p audit-logs
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>          if [ -f &#34;.last-v3-cursor-update&#34; ]; then
</span></span><span style=display:flex><span>            LAST_CURSOR=$(cat .last-v3-cursor-update)
</span></span><span style=display:flex><span>          fi
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          if [ -z &#34;$LAST_CURSOR&#34; ]; then
</span></span><span style=display:flex><span>            echo &#34;FIRST TIME RUNNING AUDIT LOG POLL&#34;
</span></span><span style=display:flex><span><span style=color:#f92672>-           npm start -- --token ${{secrets.AUDIT_LOG_TOKEN}} --org ${{secrets.ORG_NAME}} --api &#39;v3&#39; --api-type &#39;all&#39; --file &#34;audit-log-output.json&#34;
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+           npm start -- --token ${{secrets.AUDIT_LOG_TOKEN}} \
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+               --org ${{secrets.ORG_NAME}} --api &#39;v3&#39; --api-type &#39;all&#39; \
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+               --file &#34;audit-logs/audit-log-output-${FILE_SUFFIIX}.json&#34; --pretty
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>          else
</span></span><span style=display:flex><span>            echo &#34;RUNNING AUDIT LOG POLL FROM $LAST_CURSOR&#34;
</span></span><span style=display:flex><span><span style=color:#f92672>-           npm start -- --token ${{secrets.AUDIT_LOG_TOKEN}} --org ${{secrets.ORG_NAME}} --api &#39;v3&#39; --api-type &#39;all&#39; --cursor $LAST_CURSOR --file &#34;audit-log-output.json&#34;
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+           npm start -- --token ${{secrets.AUDIT_LOG_TOKEN}} \
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+               --org ${{secrets.ORG_NAME}} --api &#39;v3&#39; --api-type &#39;all&#39; \
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+               --cursor $LAST_CURSOR \
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+               --file &#34;audit-logs/audit-log-output-${FILE_SUFFIIX}.json&#34; --pretty
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>          fi
</span></span><span style=display:flex><span><span style=color:#f92672>-         curl -X POST -H &#34;Content-Type: application/json&#34; -d @audit-log-output.json ${{secrets.WEBHOOK_URL}}
</span></span></span><span style=display:flex><span><span style=color:#f92672></span>
</span></span><span style=display:flex><span>      # Commit the cursor back to source
</span></span><span style=display:flex><span>      - name: Commit cursor
</span></span><span style=display:flex><span>        uses: EndBug/add-and-commit@v5
</span></span><span style=display:flex><span>        with:
</span></span><span style=display:flex><span>          author_name: Audit Log Integration
</span></span><span style=display:flex><span>          author_email: ${{ secrets.COMMITTER_EMAIL }}
</span></span><span style=display:flex><span>          message: &#34;Updating cursor for audit log&#34;
</span></span><span style=display:flex><span>          add: &#34;.last-v3-cursor-update --force&#34;
</span></span><span style=display:flex><span>        env:
</span></span><span style=display:flex><span>          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
</span></span><span style=display:flex><span><span style=color:#a6e22e>+     - name: Commit audit log
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       uses: EndBug/add-and-commit@v5
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       with:
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+         author_name: Audit Log Integration
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+         author_email: ${{ secrets.COMMITTER_EMAIL }}
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+         message: &#34;Adding audit log&#34;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+         add: &#34;audit-logs/audit-log-output-*.json --force&#34;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       env:
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
</span></span></span></code></pre></div></div></figure><p>最後に定義ファイルをコミットして、リモートリポジトリへ登録しましょう。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>リポジトリにワークフローの登録</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ git add .github/workflows/ghec-audit-log.yml
</span></span><span style=display:flex><span>$ git commit -m <span style=color:#e6db74>&#34;add ghec-audit-log workflow&#34;</span>
</span></span><span style=display:flex><span>$ git push -u logging main</span></span></code></pre></div></div></figure><p>このリポジトリへの Push をトリガーに GitHub Actions が起動しますので、この後はワークフローが期待通り動作しているかを確認していきましょう。</p><h3 id=step5-ワークフローの動作確認>Step5. ワークフローの動作確認<a hidden class=anchor aria-hidden=true href=#step5-ワークフローの動作確認>#</a></h3><p>まずは GitHub Actions 画面へ遷移し、ワークフローの起動および処理が成功していることを確認します。出力例のように GitHub Actions のワークフロー実行履歴にて成功が記録されていれば OK です。</p><p><img loading=lazy src=images/03-check-actions.png alt=03-check-actions.png></p><p>次に監査ログが正しく格納されているか確認しましょう。出力例のように監査ログの格納が確認できれば OK です。</p><p><img loading=lazy src=images/04-check-audit-logs.png alt=04-check-audit-logs.png></p><p>以上でワークフローの設定も完了です。お疲れ様でした。以降はワークフローに定義したスケジュールに沿って 1 時間ごとに監査ログがエクスポートされるようになるかと思います。</p><h1 id=終わりに>終わりに<a hidden class=anchor aria-hidden=true href=#終わりに>#</a></h1><p>今回は GitHub Enterprise Cloud (GHEC) の監査ログを取得する方法でした。GHEC の監査ログを長期(90 日以上)保存したい方はエクスポートが必須となってきますので参考にしてみてはいかがでしょうか。</p><hr><ul><li>GitHub は、GitHub Inc. の商標または登録商標です。</li><li>その他、本資料に記述してある会社名、製品名は、各社の登録商品または商標です。</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://chacco38.github.io/tags/github/>GitHub</a></li><li><a href=https://chacco38.github.io/tags/github-actions/>GitHub Actions</a></li></ul><nav class=paginav><a class=prev href=https://chacco38.github.io/posts/2021/12/gcp-multi-region-asm-cluster/><span class=title>« Prev Page</span><br><span>複数リージョンの GKE クラスタと Anthos Service Mesh でマルチクラスタメッシュ環境を構築してみた</span></a>
<a class=next href=https://chacco38.github.io/posts/2021/12/gcp-asm-with-gke-autopilot/><span class=title>Next Page »</span><br><span>GKE Autopilot と Anthos Service Mesh を使ってフルマネージドなサービスメッシュ環境を構築してみた</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share GHEC Audit Log CLI を使って GitHub Enterprise Cloud の監査ログを取得してみた on twitter" href="https://twitter.com/intent/tweet/?text=GHEC%20Audit%20Log%20CLI%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%20GitHub%20Enterprise%20Cloud%20%e3%81%ae%e7%9b%a3%e6%9f%bb%e3%83%ad%e3%82%b0%e3%82%92%e5%8f%96%e5%be%97%e3%81%97%e3%81%a6%e3%81%bf%e3%81%9f&url=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2fghec-audit-log-cli%2f&hashtags=GitHub%2cGitHubActions"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share GHEC Audit Log CLI を使って GitHub Enterprise Cloud の監査ログを取得してみた on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2fghec-audit-log-cli%2f&title=GHEC%20Audit%20Log%20CLI%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%20GitHub%20Enterprise%20Cloud%20%e3%81%ae%e7%9b%a3%e6%9f%bb%e3%83%ad%e3%82%b0%e3%82%92%e5%8f%96%e5%be%97%e3%81%97%e3%81%a6%e3%81%bf%e3%81%9f&summary=GHEC%20Audit%20Log%20CLI%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%20GitHub%20Enterprise%20Cloud%20%e3%81%ae%e7%9b%a3%e6%9f%bb%e3%83%ad%e3%82%b0%e3%82%92%e5%8f%96%e5%be%97%e3%81%97%e3%81%a6%e3%81%bf%e3%81%9f&source=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2fghec-audit-log-cli%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share GHEC Audit Log CLI を使って GitHub Enterprise Cloud の監査ログを取得してみた on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2fghec-audit-log-cli%2f&title=GHEC%20Audit%20Log%20CLI%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%20GitHub%20Enterprise%20Cloud%20%e3%81%ae%e7%9b%a3%e6%9f%bb%e3%83%ad%e3%82%b0%e3%82%92%e5%8f%96%e5%be%97%e3%81%97%e3%81%a6%e3%81%bf%e3%81%9f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share GHEC Audit Log CLI を使って GitHub Enterprise Cloud の監査ログを取得してみた on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2fghec-audit-log-cli%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share GHEC Audit Log CLI を使って GitHub Enterprise Cloud の監査ログを取得してみた on whatsapp" href="https://api.whatsapp.com/send?text=GHEC%20Audit%20Log%20CLI%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%20GitHub%20Enterprise%20Cloud%20%e3%81%ae%e7%9b%a3%e6%9f%bb%e3%83%ad%e3%82%b0%e3%82%92%e5%8f%96%e5%be%97%e3%81%97%e3%81%a6%e3%81%bf%e3%81%9f%20-%20https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2fghec-audit-log-cli%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share GHEC Audit Log CLI を使って GitHub Enterprise Cloud の監査ログを取得してみた on telegram" href="https://telegram.me/share/url?text=GHEC%20Audit%20Log%20CLI%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%20GitHub%20Enterprise%20Cloud%20%e3%81%ae%e7%9b%a3%e6%9f%bb%e3%83%ad%e3%82%b0%e3%82%92%e5%8f%96%e5%be%97%e3%81%97%e3%81%a6%e3%81%bf%e3%81%9f&url=https%3a%2f%2fchacco38.github.io%2fposts%2f2021%2f12%2fghec-audit-log-cli%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>© 2022 Satoshi Matsuzawa</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>