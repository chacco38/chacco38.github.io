<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>AWS Controllers for Kubernetesを使って各種AWSサービスをマニフェストファイルで管理しよう | クラウドCoEの何でも屋</title><meta name=keywords content="AWS,Amazon EKS,Kubernetes,Amazon S3,Amazon ECR"><meta name=description content="はじめに みなさん、こんにちは。今回はさまざまなAWSサービスをKubernetesから管理できるようにするAWS Controllers for Kubernetesのお話です。
みなさんはAmazon EKSを活用してKubernetesクラスタをAWS上で動かすとなった際に、他のマネージドサービスの利用はどうされていますか。もちろんすべてKubernetes上で動かしてシステムを完結させるという選択肢もあるかと思いますが、やはり多くの方が他のAWSのマネージドサービスの併用も検討されるのではないでしょうか。その一方で、これら併用環境のコード化 (IaC、Infrastructure as Code) を実現しようとすると、Kubernetesアプリケーションの管理はHelm、AWSリソースの管理はTerraform、などという別々のツールでの管理になってしまいがちです。
そんな悩みを解決する1つの手段がAWS Load Balancer ControllerやAWS Controllers for KubernetesといったKubernetesクラスタ機能を拡張する各種コントローラの活用です。これらのコントローラを利用することで、AWSリソースについてもKubernetesマニフェストファイルで定義できるようになり、Kubernetes側に運用管理を寄せてシンプル化することが可能です。
今回はそのうちの1つ、さまざまなAWSサービスを管理できるようにするAWS Controllers for Kubernetesについて、簡単なサンプルを交えて紹介していきたいと思います。これからAmazon EKS上にアプリケーションを展開しようと考えている方は参考にしてみてはいかがでしょうか。
AWS Controllers for Kubernetesとは AWS Controllers for Kubernetesは、さまざまなAWSサービスをKubernetesクラスタから管理するためのKubernetes API拡張コントローラ群の総称です。このコントローラ群を活用することで、Kubernetesクラスタから直接AWSサービスの定義、作成を行うことが可能になり、アプリケーションとその依存関係にあるデータベース、メッセージキュー、オブジェクトストレージなどのマネージドサービスを含むすべてをKubernetesにて一元管理することが可能となります。なお、現時点のAWS Controllers for Kubernetesでは、次のAWSサービス向けコントローラがディベロッパープレビュー機能として利用可能となっています。
 Amazon API Gateway V2 Amazon Application Auto Scaling Amazon DynamoDB Amazon ECR Amazon EKS Amazon ElastiCache Amazon EC2 Amazon MQ Amazon OpenSearch Service Amazon RDS Amazon SageMaker Amazon SNS AWS Step Functions Amazon S3  https://github."><meta name=author content><link rel=canonical href=https://chacco38.github.io/posts/2022/02/aws-controllers-for-kubernetes/><link crossorigin=anonymous href=/assets/css/stylesheet.min.317d4c109e98a8137e18d0fd1222603a2a157f4e40f59a79576eb3861cc09531.css integrity="sha256-MX1MEJ6YqBN+GND9EiJgOioVf05A9Zp5V26zhhzAlTE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://chacco38.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://chacco38.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://chacco38.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://chacco38.github.io/apple-touch-icon.png><link rel=mask-icon href=https://chacco38.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="AWS Controllers for Kubernetesを使って各種AWSサービスをマニフェストファイルで管理しよう"><meta property="og:description" content="はじめに みなさん、こんにちは。今回はさまざまなAWSサービスをKubernetesから管理できるようにするAWS Controllers for Kubernetesのお話です。
みなさんはAmazon EKSを活用してKubernetesクラスタをAWS上で動かすとなった際に、他のマネージドサービスの利用はどうされていますか。もちろんすべてKubernetes上で動かしてシステムを完結させるという選択肢もあるかと思いますが、やはり多くの方が他のAWSのマネージドサービスの併用も検討されるのではないでしょうか。その一方で、これら併用環境のコード化 (IaC、Infrastructure as Code) を実現しようとすると、Kubernetesアプリケーションの管理はHelm、AWSリソースの管理はTerraform、などという別々のツールでの管理になってしまいがちです。
そんな悩みを解決する1つの手段がAWS Load Balancer ControllerやAWS Controllers for KubernetesといったKubernetesクラスタ機能を拡張する各種コントローラの活用です。これらのコントローラを利用することで、AWSリソースについてもKubernetesマニフェストファイルで定義できるようになり、Kubernetes側に運用管理を寄せてシンプル化することが可能です。
今回はそのうちの1つ、さまざまなAWSサービスを管理できるようにするAWS Controllers for Kubernetesについて、簡単なサンプルを交えて紹介していきたいと思います。これからAmazon EKS上にアプリケーションを展開しようと考えている方は参考にしてみてはいかがでしょうか。
AWS Controllers for Kubernetesとは AWS Controllers for Kubernetesは、さまざまなAWSサービスをKubernetesクラスタから管理するためのKubernetes API拡張コントローラ群の総称です。このコントローラ群を活用することで、Kubernetesクラスタから直接AWSサービスの定義、作成を行うことが可能になり、アプリケーションとその依存関係にあるデータベース、メッセージキュー、オブジェクトストレージなどのマネージドサービスを含むすべてをKubernetesにて一元管理することが可能となります。なお、現時点のAWS Controllers for Kubernetesでは、次のAWSサービス向けコントローラがディベロッパープレビュー機能として利用可能となっています。
 Amazon API Gateway V2 Amazon Application Auto Scaling Amazon DynamoDB Amazon ECR Amazon EKS Amazon ElastiCache Amazon EC2 Amazon MQ Amazon OpenSearch Service Amazon RDS Amazon SageMaker Amazon SNS AWS Step Functions Amazon S3  https://github."><meta property="og:type" content="article"><meta property="og:url" content="https://chacco38.github.io/posts/2022/02/aws-controllers-for-kubernetes/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-16T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-16T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS Controllers for Kubernetesを使って各種AWSサービスをマニフェストファイルで管理しよう"><meta name=twitter:description content="はじめに みなさん、こんにちは。今回はさまざまなAWSサービスをKubernetesから管理できるようにするAWS Controllers for Kubernetesのお話です。
みなさんはAmazon EKSを活用してKubernetesクラスタをAWS上で動かすとなった際に、他のマネージドサービスの利用はどうされていますか。もちろんすべてKubernetes上で動かしてシステムを完結させるという選択肢もあるかと思いますが、やはり多くの方が他のAWSのマネージドサービスの併用も検討されるのではないでしょうか。その一方で、これら併用環境のコード化 (IaC、Infrastructure as Code) を実現しようとすると、Kubernetesアプリケーションの管理はHelm、AWSリソースの管理はTerraform、などという別々のツールでの管理になってしまいがちです。
そんな悩みを解決する1つの手段がAWS Load Balancer ControllerやAWS Controllers for KubernetesといったKubernetesクラスタ機能を拡張する各種コントローラの活用です。これらのコントローラを利用することで、AWSリソースについてもKubernetesマニフェストファイルで定義できるようになり、Kubernetes側に運用管理を寄せてシンプル化することが可能です。
今回はそのうちの1つ、さまざまなAWSサービスを管理できるようにするAWS Controllers for Kubernetesについて、簡単なサンプルを交えて紹介していきたいと思います。これからAmazon EKS上にアプリケーションを展開しようと考えている方は参考にしてみてはいかがでしょうか。
AWS Controllers for Kubernetesとは AWS Controllers for Kubernetesは、さまざまなAWSサービスをKubernetesクラスタから管理するためのKubernetes API拡張コントローラ群の総称です。このコントローラ群を活用することで、Kubernetesクラスタから直接AWSサービスの定義、作成を行うことが可能になり、アプリケーションとその依存関係にあるデータベース、メッセージキュー、オブジェクトストレージなどのマネージドサービスを含むすべてをKubernetesにて一元管理することが可能となります。なお、現時点のAWS Controllers for Kubernetesでは、次のAWSサービス向けコントローラがディベロッパープレビュー機能として利用可能となっています。
 Amazon API Gateway V2 Amazon Application Auto Scaling Amazon DynamoDB Amazon ECR Amazon EKS Amazon ElastiCache Amazon EC2 Amazon MQ Amazon OpenSearch Service Amazon RDS Amazon SageMaker Amazon SNS AWS Step Functions Amazon S3  https://github."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://chacco38.github.io/posts/"},{"@type":"ListItem","position":2,"name":"AWS Controllers for Kubernetesを使って各種AWSサービスをマニフェストファイルで管理しよう","item":"https://chacco38.github.io/posts/2022/02/aws-controllers-for-kubernetes/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"AWS Controllers for Kubernetesを使って各種AWSサービスをマニフェストファイルで管理しよう","name":"AWS Controllers for Kubernetesを使って各種AWSサービスをマニフェストファイルで管理しよう","description":"はじめに みなさん、こんにちは。今回はさまざまなAWSサービスをKubernetesから管理できるようにするAWS Controllers for Kubernetesのお話です。\nみなさんはAmazon EKSを活用してKubernetesクラスタをAWS上で動かすとなった際に、他のマネージドサービスの利用はどうされていますか。もちろんすべてKubernetes上で動かしてシステムを完結させるという選択肢もあるかと思いますが、やはり多くの方が他のAWSのマネージドサービスの併用も検討されるのではないでしょうか。その一方で、これら併用環境のコード化 (IaC、Infrastructure as Code) を実現しようとすると、Kubernetesアプリケーションの管理はHelm、AWSリソースの管理はTerraform、などという別々のツールでの管理になってしまいがちです。\nそんな悩みを解決する1つの手段がAWS Load Balancer ControllerやAWS Controllers for KubernetesといったKubernetesクラスタ機能を拡張する各種コントローラの活用です。これらのコントローラを利用することで、AWSリソースについてもKubernetesマニフェストファイルで定義できるようになり、Kubernetes側に運用管理を寄せてシンプル化することが可能です。\n今回はそのうちの1つ、さまざまなAWSサービスを管理できるようにするAWS Controllers for Kubernetesについて、簡単なサンプルを交えて紹介していきたいと思います。これからAmazon EKS上にアプリケーションを展開しようと考えている方は参考にしてみてはいかがでしょうか。\nAWS Controllers for Kubernetesとは AWS Controllers for Kubernetesは、さまざまなAWSサービスをKubernetesクラスタから管理するためのKubernetes API拡張コントローラ群の総称です。このコントローラ群を活用することで、Kubernetesクラスタから直接AWSサービスの定義、作成を行うことが可能になり、アプリケーションとその依存関係にあるデータベース、メッセージキュー、オブジェクトストレージなどのマネージドサービスを含むすべてをKubernetesにて一元管理することが可能となります。なお、現時点のAWS Controllers for Kubernetesでは、次のAWSサービス向けコントローラがディベロッパープレビュー機能として利用可能となっています。\n Amazon API Gateway V2 Amazon Application Auto Scaling Amazon DynamoDB Amazon ECR Amazon EKS Amazon ElastiCache Amazon EC2 Amazon MQ Amazon OpenSearch Service Amazon RDS Amazon SageMaker Amazon SNS AWS Step Functions Amazon S3  https://github.","keywords":["AWS","Amazon EKS","Kubernetes","Amazon S3","Amazon ECR"],"articleBody":"はじめに みなさん、こんにちは。今回はさまざまなAWSサービスをKubernetesから管理できるようにするAWS Controllers for Kubernetesのお話です。\nみなさんはAmazon EKSを活用してKubernetesクラスタをAWS上で動かすとなった際に、他のマネージドサービスの利用はどうされていますか。もちろんすべてKubernetes上で動かしてシステムを完結させるという選択肢もあるかと思いますが、やはり多くの方が他のAWSのマネージドサービスの併用も検討されるのではないでしょうか。その一方で、これら併用環境のコード化 (IaC、Infrastructure as Code) を実現しようとすると、Kubernetesアプリケーションの管理はHelm、AWSリソースの管理はTerraform、などという別々のツールでの管理になってしまいがちです。\nそんな悩みを解決する1つの手段がAWS Load Balancer ControllerやAWS Controllers for KubernetesといったKubernetesクラスタ機能を拡張する各種コントローラの活用です。これらのコントローラを利用することで、AWSリソースについてもKubernetesマニフェストファイルで定義できるようになり、Kubernetes側に運用管理を寄せてシンプル化することが可能です。\n今回はそのうちの1つ、さまざまなAWSサービスを管理できるようにするAWS Controllers for Kubernetesについて、簡単なサンプルを交えて紹介していきたいと思います。これからAmazon EKS上にアプリケーションを展開しようと考えている方は参考にしてみてはいかがでしょうか。\nAWS Controllers for Kubernetesとは AWS Controllers for Kubernetesは、さまざまなAWSサービスをKubernetesクラスタから管理するためのKubernetes API拡張コントローラ群の総称です。このコントローラ群を活用することで、Kubernetesクラスタから直接AWSサービスの定義、作成を行うことが可能になり、アプリケーションとその依存関係にあるデータベース、メッセージキュー、オブジェクトストレージなどのマネージドサービスを含むすべてをKubernetesにて一元管理することが可能となります。なお、現時点のAWS Controllers for Kubernetesでは、次のAWSサービス向けコントローラがディベロッパープレビュー機能として利用可能となっています。\n Amazon API Gateway V2 Amazon Application Auto Scaling Amazon DynamoDB Amazon ECR Amazon EKS Amazon ElastiCache Amazon EC2 Amazon MQ Amazon OpenSearch Service Amazon RDS Amazon SageMaker Amazon SNS AWS Step Functions Amazon S3  https://github.com/aws-controllers-k8s/community\nAWS Controllers for Kubernetesを導入してみよう Step1. 作業環境の設定 今回はAmazon EKSやAWS Controllers for Kubernetesの管理を行う環境としてAWS CloudShellを利用していきたいと思います。まずは操作に必要な各種ツールの設定をAWS CloudShellにしてきましょう。\nAWS CLIの設定 AWSリソースの操作を行えるように次のコマンドを実行し、AWS CLIの設定を行いましょう。\nAWS CLIの設定 aws configure  kubectlコマンドのインストール 次にKubernetes管理ツールのkubectlコマンドをインストールしましょう。\nhttps://docs.aws.amazon.com/ja_jp/eks/latest/userguide/install-kubectl.html#linux\nkubectlコマンドのインストール # kubectl コマンドのダウンロード curl -o kubectl https://amazon-eks.s3.us-west-2.amazonaws.com/1.21.2/2021-07-05/bin/linux/amd64/kubectl  # 実行権限の付与 chmod +x kubectl  # 実行ファイルのパスを設定 mkdir -p ${HOME}/bin \u0026\u0026 mv kubectl ${HOME}/bin \u0026\u0026 export PATH=${PATH}:${HOME}/bin  # シェルの起動時に $HOME/bin をパスへ追加 echo 'export PATH=${PATH}:${HOME}/bin'  ~/.bashrc  # インストールが成功していることを確認 kubectl version --short --client  インストールに成功していれば出力例のようにバージョン情報の出力を確認できます。\n出力例 $ kubectl version --short --client Client Version: v1.21.2-13+d2965f0db10712  eksctlコマンドのインストール 続いてAmazon EKS管理ツールのeksctlコマンドをインストールしましょう。\nhttps://docs.aws.amazon.com/ja_jp/eks/latest/userguide/eksctl.html#linux\neksctlコマンドのインストール # eksctl の最新バージョンをダウンロード curl -L \"https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz\" | tar xz -C /tmp  # 実行ファイルをパスの通ったディレクトリへ移動 mv /tmp/eksctl ${HOME}/bin  # インストールが成功していることを確認 eksctl version  インストールに成功していれば出力例のようにバージョン情報の出力を確認できます。\n出力例 $ eksctl version 0.83.0  helmコマンドのインストール 最後にKubernetes上で稼働するアプリケーションを管理するためのツールであるhelmコマンドをインストールしましょう。\nhttps://docs.aws.amazon.com/ja_jp/eks/latest/userguide/helm.html\nhelmコマンドのインストール # 前提パッケージのインストール sudo yum install -y openssl  # インストールスクリプトのダウンロード curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3  get_helm.sh  # 実行権限の付与 chmod 700 get_helm.sh  # インストールスクリプトの実行 ./get_helm.sh  # インストールが成功していることを確認 helm version --short  インストールに成功していれば出力例のようにバージョン情報の出力を確認できます。\n出力例 $ helm version --short v3.8.0+gd141386  以上で作業環境(AWS CloudShell)の設定は完了です。\nStep2. EKSクラスタの作成 続いてAWS Controllers for Kubernetesを導入する対象のAmazon EKSクラスタを作成していきましょう。今回はあくまで検証なのでeksctlコマンドでサクッと作成していきましょう。\nhttps://docs.aws.amazon.com/ja_jp/eks/latest/userguide/getting-started-eksctl.html\nEKSクラスタの作成 # 環境変数の設定 export CLUSTER=\"matt-tokyo-cluster\"  # EKS クラスタの作成 eksctl create cluster --name ${CLUSTER} --version 1.21  # サービスアカウントでの IAM ロール使用を許可 eksctl utils associate-iam-oidc-provider --cluster ${CLUSTER} --approve  ここまで終わりましたらAWS Controllers for Kubernetesを利用するための事前準備は完了です。\nStep3. コントローラのデプロイ それではAWS Controllers for KubernetesをAmazon EKSクラスタにデプロイしていきましょう。Amazon ECRパブリックギャラリーにて各AWSサービスに対応するコントローラ用Helmチャートが公開されておりますのでこちらを利用してデプロイしていきたいと思います。\nhttps://gallery.ecr.aws/aws-controllers-k8s\nインストールスクリプトの作成 AWS Controllers for Kubernetesは各AWSサービスに対応するコントローラをそれぞれ導入し、サービスアカウントの設定をしていく必要があるのですが、公式ドキュメントを見るとかなり煩雑な手順になっていることがわかります。そこでコマンド1つでインストールできるようにスクリプト化してみました。\nhttps://aws-controllers-k8s.github.io/community/docs/user-docs/install\nwarn 再実行を想定してない作りになっているのでご注意ください。\n install.sh #!/bin/bash set -eux  # 引数の確認 if [ $# -eq 0 ] \u0026\u0026 [ -z \"${SERVICE}\" ]; then  echo \"Error: usage: ./install.sh \"  exit 1 elif [ $# -eq 1 ] \u0026\u0026 [ -n \"$1\" ]; then  SERVICE=$1 fi  # 環境変数の設定 export HELM_EXPERIMENTAL_OCI=1 CHART_EXPORT_PATH=\"/tmp/chart\" ACK_K8S_NAMESPACE=${ACK_K8S_NAMESPACE:-\"ack-system\"} ACK_SERVICE_CONTROLLER=\"ack-${SERVICE}-controller\" AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query \"Account\" --output text) CLUSTER=${CLUSTER:-\"my-tokyo-cluster\"} OIDC_PROVIDER=$(aws eks describe-cluster --name ${CLUSTER} \\  --query \"cluster.identity.oidc.issuer\" --output text \\  | sed -e \"s/^https:\\/\\///\")  # 最新リリースバージョン名の取得 RELEASE_VERSION=$(curl -sL \\  https://api.github.com/repos/aws-controllers-k8s/${SERVICE}-controller/releases/latest \\  | grep '\"tag_name\":' | cut -d'\"' -f4)  if [ -z \"${RELEASE_VERSION}\" ]; then  # latestリリースが作成されていない場合は一覧から最新バージョンを取得  RELEASE_VERSION=$(curl -sL \\  https://api.github.com/repos/aws-controllers-k8s/${SERVICE}-controller/releases \\  | grep '\"tag_name\":' | head -n 1 | cut -d'\"' -f4)   # リリースを何も作成されていない場合はv0.0.1を設定(SNSコントローラ向け)  RELEASE_VERSION=${RELEASE_VERSION:-v0.0.1} fi  # Helmチャートのダウンロードディレクトリの作成 mkdir -p ${CHART_EXPORT_PATH}  # Helmチャートのダウンロード helm pull oci://public.ecr.aws/aws-controllers-k8s/${SERVICE}-chart \\  --version $RELEASE_VERSION -d ${CHART_EXPORT_PATH}  # アーカイブの解凍 tar xvf ${CHART_EXPORT_PATH}/${SERVICE}-chart-${RELEASE_VERSION}.tgz \\  -C ${CHART_EXPORT_PATH}  # 解凍後のパスチェック if [ -d ${CHART_EXPORT_PATH}/${SERVICE}-chart ]; then  CHART_PATH=${CHART_EXPORT_PATH}/${SERVICE}-chart else  # SNSコントローラ向け  CHART_PATH=${CHART_EXPORT_PATH}/${ACK_SERVICE_CONTROLLER} fi  # コントローラのインストール helm install --create-namespace ${ACK_SERVICE_CONTROLLER} \\  --namespace ${ACK_K8S_NAMESPACE} \\  --set aws.region=\"${AWS_REGION}\" ${CHART_PATH}  # IAMロール定義ファイルの作成 cat /tmp/${ACK_SERVICE_CONTROLLER}.json { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Allow\", \"Principal\": { \"Federated\": \"arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/${OIDC_PROVIDER}\" }, \"Action\": \"sts:AssumeRoleWithWebIdentity\", \"Condition\": { \"StringEquals\": { \"${OIDC_PROVIDER}:sub\": \"system:serviceaccount:${ACK_K8S_NAMESPACE}:${ACK_SERVICE_CONTROLLER}\" } } } ] } EOF  # IAMロールの作成 aws iam create-role \\  --role-name ${ACK_SERVICE_CONTROLLER} \\  --assume-role-policy-document file:///tmp/${ACK_SERVICE_CONTROLLER}.json  # 推奨IAMポリシーの設定 POLICY_ARN_STRINGS=$(curl -sL \\  https://raw.githubusercontent.com/aws-controllers-k8s/${SERVICE}-controller/main/config/iam/recommended-policy-arn)  if [ \"404: Not Found\" != \"${POLICY_ARN_STRINGS}\" ]; then  while IFS= read -r POLICY_ARN; do  aws iam attach-role-policy \\  --role-name \"${ACK_SERVICE_CONTROLLER}\" \\  --policy-arn \"${POLICY_ARN}\"  done  \"${POLICY_ARN_STRINGS}\" fi  # 推奨IAMポリシーの設定(EKSコントローラ向け) INLINE_POLICY=$(curl -sL \\  https://raw.githubusercontent.com/aws-controllers-k8s/${SERVICE}-controller/main/config/iam/recommended-inline-policy)  if [ \"404: Not Found\" != \"${INLINE_POLICY}\" ]; then  aws iam put-role-policy \\  --role-name \"${ACK_SERVICE_CONTROLLER}\" \\  --policy-name \"ack-recommended-policy\" \\  --policy-document \"${INLINE_POLICY}\" fi  # サービスアカウントにIAMロールを関連付け kubectl -n ${ACK_K8S_NAMESPACE} annotate serviceaccount \\  ${ACK_SERVICE_CONTROLLER} \\  eks.amazonaws.com/role-arn=$(aws iam get-role \\  --role-name=${ACK_SERVICE_CONTROLLER} --query Role.Arn --output text)  # Deploymentリソースを再起動 kubectl -n ${ACK_K8S_NAMESPACE} rollout restart deployment \\  $(kubectl -n ${ACK_K8S_NAMESPACE} get deployment \\  -o custom-columns=Name:metadata.name --no-headers \\  | grep ${ACK_SERVICE_CONTROLLER})  コントローラのインストール それではコントローラを導入していきたいと思います。本記事では例としてAmazon Simple Storage Service(S3)サービスに対応したコントローラをインストールしていきたいと思います。\nコントローラのインストール(S3の場合) # 環境変数の設定 export SERVICE=\"s3\" export ACK_K8S_NAMESPACE=\"ack-system\" export ACK_SERVICE_CONTROLLER=\"ack-${SERVICE}-controller\"  # コントローラのインストール bash install.sh  # 確認 helm list -n ${ACK_K8S_NAMESPACE} -o yaml -f ${ACK_SERVICE_CONTROLLER}  インストールに成功していれば出力例のようにコントローラが表示されるようになります。\n出力例 $ helm list -n ${ACK_K8S_NAMESPACE} -o yaml -f ${ACK_SERVICE_CONTROLLER} - app_version: v0.0.13  chart: s3-chart-v0.0.13  name: ack-s3-controller  namespace: ack-system  revision: \"1\"  status: deployed  updated: 2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC  なお、今回紹介したS3以外のコントローラを導入する際は、環境変数SERVICEの値を各 AWS サービスに対応する文字列へ置換することでインストールすることが可能です。各サービスに対応する文字列は次の通りです。\n   AWS サービス名 SERVICE 値     Amazon API Gateway V2 apigatewayv2   Amazon Application Auto Scaling applicationautoscaling   Amazon DynamoDB dynamodb   Amazon ECR ecr   Amazon EKS eks   Amazon ElastiCache elasticache   Amazon EC2 ec2   Amazon MQ mq   Amazon OpenSearch Service opensearchservice   Amazon RDS rds   Amazon SageMaker sagemaker   Amazon SNS sns   AWS Step Functions sfn   Amazon S3 s3    ちなみに、全部入れるとこのような感じでコントローラだらけになってしまいます^^;\n出力例 $ helm list -n ${ACK_K8S_NAMESPACE} NAME NAMESPACE REVISION UPDATED STATUS CHART APP VERSION ack-apigatewayv2-controller ack-system 1 2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed apigatewayv2-chart-v0.0.15 v0.0.15 ack-applicationautoscaling-controller ack-system 1 2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed applicationautoscaling-chart-v0.2.4 v0.2.4 ack-dynamodb-controller ack-system 1 2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed dynamodb-chart-v0.0.14 v0.0.14 ack-ec2-controller ack-system 1 2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed ec2-chart-v0.0.7 v0.0.7 ack-ecr-controller ack-system 1 2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed ecr-chart-v0.0.19 v0.0.19 ack-eks-controller ack-system 1 2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed eks-chart-v0.0.8 v0.0.8 ack-elasticache-controller ack-system 1 2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed elasticache-chart-v0.0.14 v0.0.14 ack-mq-controller ack-system 1 2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed mq-chart-v0.0.12 v0.0.12 ack-opensearchservice-controller ack-system 1 2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed opensearchservice-chart-v0.0.9 v0.0.9 ack-rds-controller ack-system 1 2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed rds-chart-v0.0.17 v0.0.17 ack-s3-controller ack-system 1 2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed s3-chart-v0.0.13 v0.0.13 ack-sagemaker-controller ack-system 1 2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed sagemaker-chart-v0.3.0 v0.3.0 ack-sfn-controller ack-system 1 2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed sfn-chart-v0.0.11 v0.0.11 ack-sns-controller ack-system 1 2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed ack-sns-controller-v0.0.1 v0.0.1  AWS Controllers for Kubernetesを使ってみよう 今回は一部のAWSサービス向けコントローラを簡単なサンプルを用いて使い方を紹介していきたいと思います。すべてのコントローラの使い方については公式ドキュメントを参照ください。\nhttps://aws-controllers-k8s.github.io/community/reference/\nAmazon ECRコントローラの使い方 AWS Controllers for Kubernetes環境では、次のサンプルのようにKubernetes Repositoryリソースを定義をすることによってECRリポジトリをプロビジョニングできます。定義可能なスペックの詳細については次の公式リファレンスドキュメントを参照ください。\nhttps://aws-controllers-k8s.github.io/community/reference/ecr/v1alpha1/repository/\nrepository.yaml（ECRリポジトリリソース定義サンプル） apiVersion: ecr.services.k8s.aws/v1alpha1 kind: Repository metadata:  name: \"matt-ecr-repository\" spec:  name: \"matt-ecr-repository\"  imageScanningConfiguration:  scanOnPush: true  それでは次のコマンドを実行してサンプルECRリポジトリリソースをデプロイしていきましょう。\nサンプルECRリポジトリのデプロイ export NAMESPACE=\"sample\"  # サンプルECRリポジトリ用Namespaceの作成 kubectl create namespace ${NAMESPACE}  # サンプルECRリポジトリのデプロイ kubectl apply -n ${NAMESPACE} -f repository.yaml  # サンプルECRリポジトリがデプロイされたことを確認 kubectl get -n ${NAMESPACE} repository  ECRリポジトリリソースのデプロイに成功した場合は次の出力例のようにRepositoryリソース一覧に表示されます。\n出力例 $ kubectl get -n ${NAMESPACE} repository NAME AGE matt-ecr-repository 10s  念のため、AWS CLIを実行してECRリポジトリが作成されているかを確認してみましょう。\nECRリポジトリの確認 aws ecr describe-repositories --repository-name matt-ecr-repository  AWS CLIでもECRリポジトリが確認できたら成功です。\n出力例 $ aws ecr describe-repositories --repository-name matt-ecr-repository repositories: - createdAt: '2022-02-xxTxx:xx:xx+00:00'  encryptionConfiguration:  encryptionType: AES256  imageScanningConfiguration:  scanOnPush: true  imageTagMutability: MUTABLE  registryId: 'xxxxxxxxxxxx'  repositoryArn: arn:aws:ecr:ap-northeast-1:xxxxxxxxxxxx:repository/matt-ecr-repository  repositoryName: matt-ecr-repository  repositoryUri: xxxxxxxxxxxx.dkr.ecr.ap-northeast-1.amazonaws.com/matt-ecr-repository  最後にサンプルを削除して動作確認は終了です。お疲れ様でした。\nサンプルの削除 kubectl delete namespace ${NAMESPACE}  Amazon S3コントローラの使い方 AWS Controllers for Kubernetes環境では、次のサンプルのようにKubernetes Bucketリソースを定義をすることによってS3バケットをプロビジョニングできます。定義可能なスペックの詳細については次の公式リファレンスドキュメントを参照ください。\nhttps://aws-controllers-k8s.github.io/community/reference/s3/v1alpha1/bucket/\nbucket.yaml（S3バケットリソース定義サンプル） apiVersion: s3.services.k8s.aws/v1alpha1 kind: Bucket metadata:  name: \"matt-s3-bucket\" spec:  name: \"matt-s3-bucket\"  publicAccessBlock:  blockPublicACLs: true  blockPublicPolicy: true  versioning:  status: Enabled  encryption:  rules:  - bucketKeyEnabled: false  applyServerSideEncryptionByDefault:  sseAlgorithm: AES256  それでは次のコマンドを実行してサンプルS3バケットリソースをデプロイしていきましょう。\nサンプルS3バケットのデプロイ export NAMESPACE=\"sample\"  # サンプルS3バケット用Namespaceの作成 kubectl create namespace ${NAMESPACE}  # サンプルS3バケットのデプロイ kubectl apply -n ${NAMESPACE} -f bucket.yaml  # サンプルS3バケットがデプロイされたことを確認 kubectl get -n ${NAMESPACE} bucket  S3バケットリソースのデプロイに成功した場合は次の出力例のようにBucketリソース一覧に表示されます。\n出力例 $ kubectl get -n ${NAMESPACE} bucket NAME AGE matt-s3-bucket 1m22s  念のため、AWS CLIを実行してS3バケットが作成されているかを確認してみましょう。\nS3バケットが作成されているかを確認 aws s3 ls | grep \"matt-s3-bucket\"  AWS CLIでもS3バケットが確認できたら成功です。\n出力例 $ aws s3 ls | grep \"matt-s3-bucket\" 2022-02-xx xx:xx:xx matt-s3-bucket  最後にサンプルを削除して動作確認は終了です。お疲れ様でした。\nサンプルの削除 kubectl delete namespace ${NAMESPACE}  終わりに 今回はさまざまなAWSサービスをAmazon Elastic Kubernetes Service(EKS)上で管理できるようにするAWS Controllers for Kubernetesのご紹介でしたがいかがだったでしょうか。\n現時点ではディベロッパープレビュー機能のためプロダクション用途での活用はまだまだオススメできませんが、もしAWS Controllers for Kubernetesの活用を検討されている方は参考にしていただければ幸いです。\n以上、さまざまなAWSサービスをKubernetesから管理できるようにする「AWS Controllers for Kubernetes」のご紹介でした。\n  AWS は、米国その他の諸国における Amazon.com, Inc. またはその関連会社の商標です。 Kubernetes は、The Linux Foundation の米国およびその他の国における登録商標または商標です。 その他、本資料に記述してある会社名、製品名は、各社の登録商品または商標です。  ","wordCount":"1079","inLanguage":"en","datePublished":"2022-02-16T00:00:00Z","dateModified":"2022-02-16T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://chacco38.github.io/posts/2022/02/aws-controllers-for-kubernetes/"},"publisher":{"@type":"Organization","name":"クラウドCoEの何でも屋","logo":{"@type":"ImageObject","url":"https://chacco38.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://chacco38.github.io/ accesskey=h title="クラウドCoEの何でも屋 (Alt + H)">クラウドCoEの何でも屋</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://chacco38.github.io/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://chacco38.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://chacco38.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://chacco38.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://chacco38.github.io/posts/>Posts</a></div><h1 class=post-title>AWS Controllers for Kubernetesを使って各種AWSサービスをマニフェストファイルで管理しよう</h1><div class=post-meta><span title="2022-02-16 00:00:00 +0000 UTC">February 16, 2022</span>&nbsp;·&nbsp;6 min&nbsp;|&nbsp;<a href=https://github.com/chacco38/chacco38.github.io/tree/main/content/posts/2022/02/aws-controllers-for-kubernetes/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e3%81%af%e3%81%98%e3%82%81%e3%81%ab aria-label=はじめに>はじめに</a></li><li><a href=#aws-controllers-for-kubernetes%e3%81%a8%e3%81%af aria-label="AWS Controllers for Kubernetesとは">AWS Controllers for Kubernetesとは</a></li><li><a href=#aws-controllers-for-kubernetes%e3%82%92%e5%b0%8e%e5%85%a5%e3%81%97%e3%81%a6%e3%81%bf%e3%82%88%e3%81%86 aria-label="AWS Controllers for Kubernetesを導入してみよう">AWS Controllers for Kubernetesを導入してみよう</a><ul><li><a href=#step1-%e4%bd%9c%e6%a5%ad%e7%92%b0%e5%a2%83%e3%81%ae%e8%a8%ad%e5%ae%9a aria-label="Step1. 作業環境の設定">Step1. 作業環境の設定</a><ul><li><a href=#aws-cli%e3%81%ae%e8%a8%ad%e5%ae%9a aria-label="AWS CLIの設定">AWS CLIの設定</a></li><li><a href=#kubectl%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89%e3%81%ae%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab aria-label=kubectlコマンドのインストール>kubectlコマンドのインストール</a></li><li><a href=#eksctl%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89%e3%81%ae%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab aria-label=eksctlコマンドのインストール>eksctlコマンドのインストール</a></li><li><a href=#helm%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89%e3%81%ae%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab aria-label=helmコマンドのインストール>helmコマンドのインストール</a></li></ul></li><li><a href=#step2-eks%e3%82%af%e3%83%a9%e3%82%b9%e3%82%bf%e3%81%ae%e4%bd%9c%e6%88%90 aria-label="Step2. EKSクラスタの作成">Step2. EKSクラスタの作成</a></li><li><a href=#step3-%e3%82%b3%e3%83%b3%e3%83%88%e3%83%ad%e3%83%bc%e3%83%a9%e3%81%ae%e3%83%87%e3%83%97%e3%83%ad%e3%82%a4 aria-label="Step3. コントローラのデプロイ">Step3. コントローラのデプロイ</a><ul><li><a href=#%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab%e3%82%b9%e3%82%af%e3%83%aa%e3%83%97%e3%83%88%e3%81%ae%e4%bd%9c%e6%88%90 aria-label=インストールスクリプトの作成>インストールスクリプトの作成</a></li><li><a href=#%e3%82%b3%e3%83%b3%e3%83%88%e3%83%ad%e3%83%bc%e3%83%a9%e3%81%ae%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab aria-label=コントローラのインストール>コントローラのインストール</a></li></ul></li></ul></li><li><a href=#aws-controllers-for-kubernetes%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e3%81%bf%e3%82%88%e3%81%86 aria-label="AWS Controllers for Kubernetesを使ってみよう">AWS Controllers for Kubernetesを使ってみよう</a><ul><li><a href=#amazon-ecr%e3%82%b3%e3%83%b3%e3%83%88%e3%83%ad%e3%83%bc%e3%83%a9%e3%81%ae%e4%bd%bf%e3%81%84%e6%96%b9 aria-label="Amazon ECRコントローラの使い方">Amazon ECRコントローラの使い方</a></li><li><a href=#amazon-s3%e3%82%b3%e3%83%b3%e3%83%88%e3%83%ad%e3%83%bc%e3%83%a9%e3%81%ae%e4%bd%bf%e3%81%84%e6%96%b9 aria-label="Amazon S3コントローラの使い方">Amazon S3コントローラの使い方</a></li></ul></li><li><a href=#%e7%b5%82%e3%82%8f%e3%82%8a%e3%81%ab aria-label=終わりに>終わりに</a></li></ul></div></details></div><div class=post-content><h1 id=はじめに>はじめに<a hidden class=anchor aria-hidden=true href=#はじめに>#</a></h1><p>みなさん、こんにちは。今回はさまざまなAWSサービスをKubernetesから管理できるようにするAWS Controllers for Kubernetesのお話です。</p><p>みなさんはAmazon EKSを活用してKubernetesクラスタをAWS上で動かすとなった際に、他のマネージドサービスの利用はどうされていますか。もちろんすべてKubernetes上で動かしてシステムを完結させるという選択肢もあるかと思いますが、やはり多くの方が他のAWSのマネージドサービスの併用も検討されるのではないでしょうか。その一方で、これら併用環境のコード化 (IaC、Infrastructure as Code) を実現しようとすると、Kubernetesアプリケーションの管理はHelm、AWSリソースの管理はTerraform、などという別々のツールでの管理になってしまいがちです。</p><p>そんな悩みを解決する1つの手段がAWS Load Balancer ControllerやAWS Controllers for KubernetesといったKubernetesクラスタ機能を拡張する各種コントローラの活用です。これらのコントローラを利用することで、AWSリソースについてもKubernetesマニフェストファイルで定義できるようになり、Kubernetes側に運用管理を寄せてシンプル化することが可能です。</p><p>今回はそのうちの1つ、さまざまなAWSサービスを管理できるようにするAWS Controllers for Kubernetesについて、簡単なサンプルを交えて紹介していきたいと思います。これからAmazon EKS上にアプリケーションを展開しようと考えている方は参考にしてみてはいかがでしょうか。</p><h1 id=aws-controllers-for-kubernetesとは>AWS Controllers for Kubernetesとは<a hidden class=anchor aria-hidden=true href=#aws-controllers-for-kubernetesとは>#</a></h1><p>AWS Controllers for Kubernetesは、さまざまなAWSサービスをKubernetesクラスタから管理するためのKubernetes API拡張コントローラ群の総称です。このコントローラ群を活用することで、Kubernetesクラスタから直接AWSサービスの定義、作成を行うことが可能になり、アプリケーションとその依存関係にあるデータベース、メッセージキュー、オブジェクトストレージなどのマネージドサービスを含むすべてをKubernetesにて一元管理することが可能となります。なお、現時点のAWS Controllers for Kubernetesでは、次のAWSサービス向けコントローラがディベロッパープレビュー機能として利用可能となっています。</p><ul><li>Amazon API Gateway V2</li><li>Amazon Application Auto Scaling</li><li>Amazon DynamoDB</li><li>Amazon ECR</li><li>Amazon EKS</li><li>Amazon ElastiCache</li><li>Amazon EC2</li><li>Amazon MQ</li><li>Amazon OpenSearch Service</li><li>Amazon RDS</li><li>Amazon SageMaker</li><li>Amazon SNS</li><li>AWS Step Functions</li><li>Amazon S3</li></ul><p><a href=https://github.com/aws-controllers-k8s/community>https://github.com/aws-controllers-k8s/community</a></p><h1 id=aws-controllers-for-kubernetesを導入してみよう>AWS Controllers for Kubernetesを導入してみよう<a hidden class=anchor aria-hidden=true href=#aws-controllers-for-kubernetesを導入してみよう>#</a></h1><h2 id=step1-作業環境の設定>Step1. 作業環境の設定<a hidden class=anchor aria-hidden=true href=#step1-作業環境の設定>#</a></h2><p>今回はAmazon EKSやAWS Controllers for Kubernetesの管理を行う環境としてAWS CloudShellを利用していきたいと思います。まずは操作に必要な各種ツールの設定をAWS CloudShellにしてきましょう。</p><h3 id=aws-cliの設定>AWS CLIの設定<a hidden class=anchor aria-hidden=true href=#aws-cliの設定>#</a></h3><p>AWSリソースの操作を行えるように次のコマンドを実行し、AWS CLIの設定を行いましょう。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>AWS CLIの設定</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws configure</span></span></code></pre></div></div></figure><h3 id=kubectlコマンドのインストール>kubectlコマンドのインストール<a hidden class=anchor aria-hidden=true href=#kubectlコマンドのインストール>#</a></h3><p>次にKubernetes管理ツールの<code>kubectl</code>コマンドをインストールしましょう。</p><p><a href=https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/install-kubectl.html#linux>https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/install-kubectl.html#linux</a></p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>kubectlコマンドのインストール</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># kubectl コマンドのダウンロード</span>
</span></span><span style=display:flex><span>curl -o kubectl https://amazon-eks.s3.us-west-2.amazonaws.com/1.21.2/2021-07-05/bin/linux/amd64/kubectl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 実行権限の付与</span>
</span></span><span style=display:flex><span>chmod +x kubectl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 実行ファイルのパスを設定</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>${</span>HOME<span style=color:#e6db74>}</span>/bin <span style=color:#f92672>&amp;&amp;</span> mv kubectl <span style=color:#e6db74>${</span>HOME<span style=color:#e6db74>}</span>/bin <span style=color:#f92672>&amp;&amp;</span> export PATH<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>PATH<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>HOME<span style=color:#e6db74>}</span>/bin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># シェルの起動時に $HOME/bin をパスへ追加</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;export PATH=${PATH}:${HOME}/bin&#39;</span> &gt;&gt; ~/.bashrc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># インストールが成功していることを確認</span>
</span></span><span style=display:flex><span>kubectl version --short --client</span></span></code></pre></div></div></figure><p>インストールに成功していれば出力例のようにバージョン情報の出力を確認できます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ kubectl version --short --client
</span></span><span style=display:flex><span>Client Version: v1.21.2-13+d2965f0db10712</span></span></code></pre></div></div></figure><h3 id=eksctlコマンドのインストール>eksctlコマンドのインストール<a hidden class=anchor aria-hidden=true href=#eksctlコマンドのインストール>#</a></h3><p>続いてAmazon EKS管理ツールの<code>eksctl</code>コマンドをインストールしましょう。</p><p><a href=https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/eksctl.html#linux>https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/eksctl.html#linux</a></p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>eksctlコマンドのインストール</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># eksctl の最新バージョンをダウンロード</span>
</span></span><span style=display:flex><span>curl -L <span style=color:#e6db74>&#34;https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_</span><span style=color:#66d9ef>$(</span>uname -s<span style=color:#66d9ef>)</span><span style=color:#e6db74>_amd64.tar.gz&#34;</span> | tar xz -C /tmp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 実行ファイルをパスの通ったディレクトリへ移動</span>
</span></span><span style=display:flex><span>mv /tmp/eksctl <span style=color:#e6db74>${</span>HOME<span style=color:#e6db74>}</span>/bin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># インストールが成功していることを確認</span>
</span></span><span style=display:flex><span>eksctl version</span></span></code></pre></div></div></figure><p>インストールに成功していれば出力例のようにバージョン情報の出力を確認できます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ eksctl version
</span></span><span style=display:flex><span>0.83.0</span></span></code></pre></div></div></figure><h3 id=helmコマンドのインストール>helmコマンドのインストール<a hidden class=anchor aria-hidden=true href=#helmコマンドのインストール>#</a></h3><p>最後にKubernetes上で稼働するアプリケーションを管理するためのツールである<code>helm</code>コマンドをインストールしましょう。</p><p><a href=https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/helm.html>https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/helm.html</a></p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>helmコマンドのインストール</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 前提パッケージのインストール</span>
</span></span><span style=display:flex><span>sudo yum install -y openssl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># インストールスクリプトのダウンロード</span>
</span></span><span style=display:flex><span>curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 &gt; get_helm.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 実行権限の付与</span>
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>700</span> get_helm.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># インストールスクリプトの実行</span>
</span></span><span style=display:flex><span>./get_helm.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># インストールが成功していることを確認</span>
</span></span><span style=display:flex><span>helm version --short</span></span></code></pre></div></div></figure><p>インストールに成功していれば出力例のようにバージョン情報の出力を確認できます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ helm version --short
</span></span><span style=display:flex><span>v3.8.0+gd141386</span></span></code></pre></div></div></figure><p>以上で作業環境(AWS CloudShell)の設定は完了です。</p><h2 id=step2-eksクラスタの作成>Step2. EKSクラスタの作成<a hidden class=anchor aria-hidden=true href=#step2-eksクラスタの作成>#</a></h2><p>続いてAWS Controllers for Kubernetesを導入する対象のAmazon EKSクラスタを作成していきましょう。今回はあくまで検証なので<code>eksctl</code>コマンドでサクッと作成していきましょう。</p><p><a href=https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/getting-started-eksctl.html>https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/getting-started-eksctl.html</a></p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>EKSクラスタの作成</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 環境変数の設定</span>
</span></span><span style=display:flex><span>export CLUSTER<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;matt-tokyo-cluster&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># EKS クラスタの作成</span>
</span></span><span style=display:flex><span>eksctl create cluster --name <span style=color:#e6db74>${</span>CLUSTER<span style=color:#e6db74>}</span> --version 1.21
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># サービスアカウントでの IAM ロール使用を許可</span>
</span></span><span style=display:flex><span>eksctl utils associate-iam-oidc-provider --cluster <span style=color:#e6db74>${</span>CLUSTER<span style=color:#e6db74>}</span> --approve</span></span></code></pre></div></div></figure><p>ここまで終わりましたらAWS Controllers for Kubernetesを利用するための事前準備は完了です。</p><h2 id=step3-コントローラのデプロイ>Step3. コントローラのデプロイ<a hidden class=anchor aria-hidden=true href=#step3-コントローラのデプロイ>#</a></h2><p>それではAWS Controllers for KubernetesをAmazon EKSクラスタにデプロイしていきましょう。Amazon ECRパブリックギャラリーにて各AWSサービスに対応するコントローラ用Helmチャートが公開されておりますのでこちらを利用してデプロイしていきたいと思います。</p><p><a href=https://gallery.ecr.aws/aws-controllers-k8s>https://gallery.ecr.aws/aws-controllers-k8s</a></p><h3 id=インストールスクリプトの作成>インストールスクリプトの作成<a hidden class=anchor aria-hidden=true href=#インストールスクリプトの作成>#</a></h3><p>AWS Controllers for Kubernetesは各AWSサービスに対応するコントローラをそれぞれ導入し、サービスアカウントの設定をしていく必要があるのですが、公式ドキュメントを見るとかなり煩雑な手順になっていることがわかります。そこでコマンド1つでインストールできるようにスクリプト化してみました。</p><p><a href=https://aws-controllers-k8s.github.io/community/docs/user-docs/install>https://aws-controllers-k8s.github.io/community/docs/user-docs/install</a></p><figcaption class="note_title warn">warn</figcaption><div class="note warn"><p>再実行を想定してない作りになっているのでご注意ください。</p></div><figure class=xCodeBlock><figcaption class=xCodeBlock_title>install.sh</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>set -eux
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 引数の確認</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $# -eq <span style=color:#ae81ff>0</span>  <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>SERVICE<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Error: usage: ./install.sh &lt;SERVICE_NAME&gt;&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>elif</span> <span style=color:#f92672>[</span> $# -eq <span style=color:#ae81ff>1</span>  <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>[</span> -n <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    SERVICE<span style=color:#f92672>=</span>$1
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 環境変数の設定</span>
</span></span><span style=display:flex><span>export HELM_EXPERIMENTAL_OCI<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>CHART_EXPORT_PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/tmp/chart&#34;</span>
</span></span><span style=display:flex><span>ACK_K8S_NAMESPACE<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ACK_K8S_NAMESPACE<span style=color:#66d9ef>:-</span><span style=color:#e6db74>&#34;ack-system&#34;</span><span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>ACK_SERVICE_CONTROLLER<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ack-</span><span style=color:#e6db74>${</span>SERVICE<span style=color:#e6db74>}</span><span style=color:#e6db74>-controller&#34;</span>
</span></span><span style=display:flex><span>AWS_ACCOUNT_ID<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>aws sts get-caller-identity --query <span style=color:#e6db74>&#34;Account&#34;</span> --output text<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>CLUSTER<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>CLUSTER<span style=color:#66d9ef>:-</span><span style=color:#e6db74>&#34;my-tokyo-cluster&#34;</span><span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>OIDC_PROVIDER<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>aws eks describe-cluster --name <span style=color:#e6db74>${</span>CLUSTER<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --query <span style=color:#e6db74>&#34;cluster.identity.oidc.issuer&#34;</span> --output text <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    | sed -e <span style=color:#e6db74>&#34;s/^https:\/\///&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 最新リリースバージョン名の取得</span>
</span></span><span style=display:flex><span>RELEASE_VERSION<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -sL <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    https://api.github.com/repos/aws-controllers-k8s/<span style=color:#e6db74>${</span>SERVICE<span style=color:#e6db74>}</span>-controller/releases/latest <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    | grep <span style=color:#e6db74>&#39;&#34;tag_name&#34;:&#39;</span> | cut -d<span style=color:#e6db74>&#39;&#34;&#39;</span> -f4<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>RELEASE_VERSION<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># latestリリースが作成されていない場合は一覧から最新バージョンを取得</span>
</span></span><span style=display:flex><span>    RELEASE_VERSION<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -sL <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        https://api.github.com/repos/aws-controllers-k8s/<span style=color:#e6db74>${</span>SERVICE<span style=color:#e6db74>}</span>-controller/releases <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        | grep <span style=color:#e6db74>&#39;&#34;tag_name&#34;:&#39;</span> | head -n <span style=color:#ae81ff>1</span> | cut -d<span style=color:#e6db74>&#39;&#34;&#39;</span> -f4<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># リリースを何も作成されていない場合はv0.0.1を設定(SNSコントローラ向け)</span>
</span></span><span style=display:flex><span>    RELEASE_VERSION<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>RELEASE_VERSION<span style=color:#66d9ef>:-</span>v0.0.1<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Helmチャートのダウンロードディレクトリの作成</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>${</span>CHART_EXPORT_PATH<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Helmチャートのダウンロード</span>
</span></span><span style=display:flex><span>helm pull oci://public.ecr.aws/aws-controllers-k8s/<span style=color:#e6db74>${</span>SERVICE<span style=color:#e6db74>}</span>-chart <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --version $RELEASE_VERSION -d <span style=color:#e6db74>${</span>CHART_EXPORT_PATH<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># アーカイブの解凍</span>
</span></span><span style=display:flex><span>tar xvf <span style=color:#e6db74>${</span>CHART_EXPORT_PATH<span style=color:#e6db74>}</span>/<span style=color:#e6db74>${</span>SERVICE<span style=color:#e6db74>}</span>-chart-<span style=color:#e6db74>${</span>RELEASE_VERSION<span style=color:#e6db74>}</span>.tgz <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -C <span style=color:#e6db74>${</span>CHART_EXPORT_PATH<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 解凍後のパスチェック</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -d <span style=color:#e6db74>${</span>CHART_EXPORT_PATH<span style=color:#e6db74>}</span>/<span style=color:#e6db74>${</span>SERVICE<span style=color:#e6db74>}</span>-chart <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    CHART_PATH<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>CHART_EXPORT_PATH<span style=color:#e6db74>}</span>/<span style=color:#e6db74>${</span>SERVICE<span style=color:#e6db74>}</span>-chart
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># SNSコントローラ向け</span>
</span></span><span style=display:flex><span>    CHART_PATH<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>CHART_EXPORT_PATH<span style=color:#e6db74>}</span>/<span style=color:#e6db74>${</span>ACK_SERVICE_CONTROLLER<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># コントローラのインストール</span>
</span></span><span style=display:flex><span>helm install --create-namespace <span style=color:#e6db74>${</span>ACK_SERVICE_CONTROLLER<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --namespace <span style=color:#e6db74>${</span>ACK_K8S_NAMESPACE<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --set aws.region<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>AWS_REGION<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>${</span>CHART_PATH<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># IAMロール定義ファイルの作成</span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; /tmp/${ACK_SERVICE_CONTROLLER}.json
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;Statement&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;Principal&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;Federated&#34;: &#34;arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/${OIDC_PROVIDER}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;Action&#34;: &#34;sts:AssumeRoleWithWebIdentity&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;Condition&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;StringEquals&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &#34;${OIDC_PROVIDER}:sub&#34;: &#34;system:serviceaccount:${ACK_K8S_NAMESPACE}:${ACK_SERVICE_CONTROLLER}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># IAMロールの作成</span>
</span></span><span style=display:flex><span>aws iam create-role <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --role-name <span style=color:#e6db74>${</span>ACK_SERVICE_CONTROLLER<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --assume-role-policy-document file:///tmp/<span style=color:#e6db74>${</span>ACK_SERVICE_CONTROLLER<span style=color:#e6db74>}</span>.json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 推奨IAMポリシーの設定</span>
</span></span><span style=display:flex><span>POLICY_ARN_STRINGS<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -sL <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    https://raw.githubusercontent.com/aws-controllers-k8s/<span style=color:#e6db74>${</span>SERVICE<span style=color:#e6db74>}</span>-controller/main/config/iam/recommended-policy-arn<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;404: Not Found&#34;</span> !<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>POLICY_ARN_STRINGS<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> IFS<span style=color:#f92672>=</span> read -r POLICY_ARN; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        aws iam attach-role-policy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --role-name <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>ACK_SERVICE_CONTROLLER<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --policy-arn <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>POLICY_ARN<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span> <span style=color:#f92672>&lt;&lt;&lt;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>POLICY_ARN_STRINGS<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 推奨IAMポリシーの設定(EKSコントローラ向け)</span>
</span></span><span style=display:flex><span>INLINE_POLICY<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -sL <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    https://raw.githubusercontent.com/aws-controllers-k8s/<span style=color:#e6db74>${</span>SERVICE<span style=color:#e6db74>}</span>-controller/main/config/iam/recommended-inline-policy<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;404: Not Found&#34;</span> !<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>INLINE_POLICY<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    aws iam put-role-policy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --role-name <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>ACK_SERVICE_CONTROLLER<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --policy-name <span style=color:#e6db74>&#34;ack-recommended-policy&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --policy-document <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>INLINE_POLICY<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># サービスアカウントにIAMロールを関連付け</span>
</span></span><span style=display:flex><span>kubectl -n <span style=color:#e6db74>${</span>ACK_K8S_NAMESPACE<span style=color:#e6db74>}</span> annotate serviceaccount <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#e6db74>${</span>ACK_SERVICE_CONTROLLER<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    eks.amazonaws.com/role-arn<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>aws iam get-role <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --role-name<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ACK_SERVICE_CONTROLLER<span style=color:#e6db74>}</span> --query Role.Arn --output text<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Deploymentリソースを再起動</span>
</span></span><span style=display:flex><span>kubectl -n <span style=color:#e6db74>${</span>ACK_K8S_NAMESPACE<span style=color:#e6db74>}</span> rollout restart deployment <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#66d9ef>$(</span>kubectl -n <span style=color:#e6db74>${</span>ACK_K8S_NAMESPACE<span style=color:#e6db74>}</span> get deployment <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -o custom-columns<span style=color:#f92672>=</span>Name:metadata.name --no-headers <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        | grep <span style=color:#e6db74>${</span>ACK_SERVICE_CONTROLLER<span style=color:#e6db74>}</span><span style=color:#66d9ef>)</span></span></span></code></pre></div></div></figure><h3 id=コントローラのインストール>コントローラのインストール<a hidden class=anchor aria-hidden=true href=#コントローラのインストール>#</a></h3><p>それではコントローラを導入していきたいと思います。本記事では例としてAmazon Simple Storage Service(S3)サービスに対応したコントローラをインストールしていきたいと思います。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>コントローラのインストール(S3の場合)</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 環境変数の設定</span>
</span></span><span style=display:flex><span>export SERVICE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;s3&#34;</span>
</span></span><span style=display:flex><span>export ACK_K8S_NAMESPACE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ack-system&#34;</span>
</span></span><span style=display:flex><span>export ACK_SERVICE_CONTROLLER<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ack-</span><span style=color:#e6db74>${</span>SERVICE<span style=color:#e6db74>}</span><span style=color:#e6db74>-controller&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># コントローラのインストール</span>
</span></span><span style=display:flex><span>bash install.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 確認</span>
</span></span><span style=display:flex><span>helm list -n <span style=color:#e6db74>${</span>ACK_K8S_NAMESPACE<span style=color:#e6db74>}</span> -o yaml -f <span style=color:#e6db74>${</span>ACK_SERVICE_CONTROLLER<span style=color:#e6db74>}</span></span></span></code></pre></div></div></figure><p>インストールに成功していれば出力例のようにコントローラが表示されるようになります。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ helm list -n ${ACK_K8S_NAMESPACE} -o yaml -f ${ACK_SERVICE_CONTROLLER}
</span></span><span style=display:flex><span>- app_version: v0.0.13
</span></span><span style=display:flex><span>  chart: s3-chart-v0.0.13
</span></span><span style=display:flex><span>  name: ack-s3-controller
</span></span><span style=display:flex><span>  namespace: ack-system
</span></span><span style=display:flex><span>  revision: &#34;1&#34;
</span></span><span style=display:flex><span>  status: deployed
</span></span><span style=display:flex><span>  updated: 2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC</span></span></code></pre></div></div></figure><p>なお、今回紹介したS3以外のコントローラを導入する際は、環境変数<code>SERVICE</code>の値を各 AWS サービスに対応する文字列へ置換することでインストールすることが可能です。各サービスに対応する文字列は次の通りです。</p><table><thead><tr><th>AWS サービス名</th><th>SERVICE 値</th></tr></thead><tbody><tr><td>Amazon API Gateway V2</td><td>apigatewayv2</td></tr><tr><td>Amazon Application Auto Scaling</td><td>applicationautoscaling</td></tr><tr><td>Amazon DynamoDB</td><td>dynamodb</td></tr><tr><td>Amazon ECR</td><td>ecr</td></tr><tr><td>Amazon EKS</td><td>eks</td></tr><tr><td>Amazon ElastiCache</td><td>elasticache</td></tr><tr><td>Amazon EC2</td><td>ec2</td></tr><tr><td>Amazon MQ</td><td>mq</td></tr><tr><td>Amazon OpenSearch Service</td><td>opensearchservice</td></tr><tr><td>Amazon RDS</td><td>rds</td></tr><tr><td>Amazon SageMaker</td><td>sagemaker</td></tr><tr><td>Amazon SNS</td><td>sns</td></tr><tr><td>AWS Step Functions</td><td>sfn</td></tr><tr><td>Amazon S3</td><td>s3</td></tr></tbody></table><p>ちなみに、全部入れるとこのような感じでコントローラだらけになってしまいます^^;</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ helm list -n ${ACK_K8S_NAMESPACE}
</span></span><span style=display:flex><span>NAME                                    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                                   APP VERSION
</span></span><span style=display:flex><span>ack-apigatewayv2-controller             ack-system      1               2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed        apigatewayv2-chart-v0.0.15              v0.0.15    
</span></span><span style=display:flex><span>ack-applicationautoscaling-controller   ack-system      1               2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed        applicationautoscaling-chart-v0.2.4     v0.2.4     
</span></span><span style=display:flex><span>ack-dynamodb-controller                 ack-system      1               2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed        dynamodb-chart-v0.0.14                  v0.0.14    
</span></span><span style=display:flex><span>ack-ec2-controller                      ack-system      1               2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed        ec2-chart-v0.0.7                        v0.0.7     
</span></span><span style=display:flex><span>ack-ecr-controller                      ack-system      1               2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed        ecr-chart-v0.0.19                       v0.0.19    
</span></span><span style=display:flex><span>ack-eks-controller                      ack-system      1               2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed        eks-chart-v0.0.8                        v0.0.8     
</span></span><span style=display:flex><span>ack-elasticache-controller              ack-system      1               2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed        elasticache-chart-v0.0.14               v0.0.14    
</span></span><span style=display:flex><span>ack-mq-controller                       ack-system      1               2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed        mq-chart-v0.0.12                        v0.0.12    
</span></span><span style=display:flex><span>ack-opensearchservice-controller        ack-system      1               2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed        opensearchservice-chart-v0.0.9          v0.0.9     
</span></span><span style=display:flex><span>ack-rds-controller                      ack-system      1               2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed        rds-chart-v0.0.17                       v0.0.17    
</span></span><span style=display:flex><span>ack-s3-controller                       ack-system      1               2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed        s3-chart-v0.0.13                        v0.0.13    
</span></span><span style=display:flex><span>ack-sagemaker-controller                ack-system      1               2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed        sagemaker-chart-v0.3.0                  v0.3.0     
</span></span><span style=display:flex><span>ack-sfn-controller                      ack-system      1               2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed        sfn-chart-v0.0.11                       v0.0.11    
</span></span><span style=display:flex><span>ack-sns-controller                      ack-system      1               2022-02-xx xx:xx:xx.xxxxxxxxx +0000 UTC deployed        ack-sns-controller-v0.0.1               v0.0.1</span></span></code></pre></div></div></figure><h1 id=aws-controllers-for-kubernetesを使ってみよう>AWS Controllers for Kubernetesを使ってみよう<a hidden class=anchor aria-hidden=true href=#aws-controllers-for-kubernetesを使ってみよう>#</a></h1><p>今回は一部のAWSサービス向けコントローラを簡単なサンプルを用いて使い方を紹介していきたいと思います。すべてのコントローラの使い方については公式ドキュメントを参照ください。</p><p><a href=https://aws-controllers-k8s.github.io/community/reference/>https://aws-controllers-k8s.github.io/community/reference/</a></p><h2 id=amazon-ecrコントローラの使い方>Amazon ECRコントローラの使い方<a hidden class=anchor aria-hidden=true href=#amazon-ecrコントローラの使い方>#</a></h2><p>AWS Controllers for Kubernetes環境では、次のサンプルのようにKubernetes Repositoryリソースを定義をすることによってECRリポジトリをプロビジョニングできます。定義可能なスペックの詳細については次の公式リファレンスドキュメントを参照ください。</p><p><a href=https://aws-controllers-k8s.github.io/community/reference/ecr/v1alpha1/repository/>https://aws-controllers-k8s.github.io/community/reference/ecr/v1alpha1/repository/</a></p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>repository.yaml（ECRリポジトリリソース定義サンプル）</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>ecr.services.k8s.aws/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Repository</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;matt-ecr-repository&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;matt-ecr-repository&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>imageScanningConfiguration</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>scanOnPush</span>: <span style=color:#66d9ef>true</span></span></span></code></pre></div></div></figure><p>それでは次のコマンドを実行してサンプルECRリポジトリリソースをデプロイしていきましょう。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>サンプルECRリポジトリのデプロイ</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export NAMESPACE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;sample&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># サンプルECRリポジトリ用Namespaceの作成</span>
</span></span><span style=display:flex><span>kubectl create namespace <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># サンプルECRリポジトリのデプロイ</span>
</span></span><span style=display:flex><span>kubectl apply -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> -f repository.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># サンプルECRリポジトリがデプロイされたことを確認</span>
</span></span><span style=display:flex><span>kubectl get -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> repository</span></span></code></pre></div></div></figure><p>ECRリポジトリリソースのデプロイに成功した場合は次の出力例のようにRepositoryリソース一覧に表示されます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ kubectl get -n ${NAMESPACE} repository
</span></span><span style=display:flex><span>NAME                  AGE
</span></span><span style=display:flex><span>matt-ecr-repository   10s</span></span></code></pre></div></div></figure><p>念のため、AWS CLIを実行してECRリポジトリが作成されているかを確認してみましょう。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>ECRリポジトリの確認</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws ecr describe-repositories --repository-name matt-ecr-repository</span></span></code></pre></div></div></figure><p>AWS CLIでもECRリポジトリが確認できたら成功です。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ aws ecr describe-repositories --repository-name matt-ecr-repository
</span></span><span style=display:flex><span>repositories:
</span></span><span style=display:flex><span>- createdAt: &#39;2022-02-xxTxx:xx:xx+00:00&#39;
</span></span><span style=display:flex><span>  encryptionConfiguration:
</span></span><span style=display:flex><span>    encryptionType: AES256
</span></span><span style=display:flex><span>  imageScanningConfiguration:
</span></span><span style=display:flex><span>    scanOnPush: true
</span></span><span style=display:flex><span>  imageTagMutability: MUTABLE
</span></span><span style=display:flex><span>  registryId: &#39;xxxxxxxxxxxx&#39;
</span></span><span style=display:flex><span>  repositoryArn: arn:aws:ecr:ap-northeast-1:xxxxxxxxxxxx:repository/matt-ecr-repository
</span></span><span style=display:flex><span>  repositoryName: matt-ecr-repository
</span></span><span style=display:flex><span>  repositoryUri: xxxxxxxxxxxx.dkr.ecr.ap-northeast-1.amazonaws.com/matt-ecr-repository</span></span></code></pre></div></div></figure><p>最後にサンプルを削除して動作確認は終了です。お疲れ様でした。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>サンプルの削除</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete namespace <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span></span></span></code></pre></div></div></figure><h2 id=amazon-s3コントローラの使い方>Amazon S3コントローラの使い方<a hidden class=anchor aria-hidden=true href=#amazon-s3コントローラの使い方>#</a></h2><p>AWS Controllers for Kubernetes環境では、次のサンプルのようにKubernetes Bucketリソースを定義をすることによってS3バケットをプロビジョニングできます。定義可能なスペックの詳細については次の公式リファレンスドキュメントを参照ください。</p><p><a href=https://aws-controllers-k8s.github.io/community/reference/s3/v1alpha1/bucket/>https://aws-controllers-k8s.github.io/community/reference/s3/v1alpha1/bucket/</a></p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>bucket.yaml（S3バケットリソース定義サンプル）</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>s3.services.k8s.aws/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Bucket</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;matt-s3-bucket&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;matt-s3-bucket&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>publicAccessBlock</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>blockPublicACLs</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>blockPublicPolicy</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>versioning</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>status</span>: <span style=color:#ae81ff>Enabled</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>encryption</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>bucketKeyEnabled</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>applyServerSideEncryptionByDefault</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>sseAlgorithm</span>: <span style=color:#ae81ff>AES256</span></span></span></code></pre></div></div></figure><p>それでは次のコマンドを実行してサンプルS3バケットリソースをデプロイしていきましょう。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>サンプルS3バケットのデプロイ</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export NAMESPACE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;sample&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># サンプルS3バケット用Namespaceの作成</span>
</span></span><span style=display:flex><span>kubectl create namespace <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># サンプルS3バケットのデプロイ</span>
</span></span><span style=display:flex><span>kubectl apply -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> -f bucket.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># サンプルS3バケットがデプロイされたことを確認</span>
</span></span><span style=display:flex><span>kubectl get -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> bucket</span></span></code></pre></div></div></figure><p>S3バケットリソースのデプロイに成功した場合は次の出力例のようにBucketリソース一覧に表示されます。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get -n <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span> bucket
</span></span><span style=display:flex><span>NAME             AGE
</span></span><span style=display:flex><span>matt-s3-bucket   1m22s</span></span></code></pre></div></div></figure><p>念のため、AWS CLIを実行してS3バケットが作成されているかを確認してみましょう。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>S3バケットが作成されているかを確認</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws s3 ls | grep <span style=color:#e6db74>&#34;matt-s3-bucket&#34;</span></span></span></code></pre></div></div></figure><p>AWS CLIでもS3バケットが確認できたら成功です。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>出力例</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws s3 ls | grep <span style=color:#e6db74>&#34;matt-s3-bucket&#34;</span>
</span></span><span style=display:flex><span>2022-02-xx xx:xx:xx matt-s3-bucket</span></span></code></pre></div></div></figure><p>最後にサンプルを削除して動作確認は終了です。お疲れ様でした。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>サンプルの削除</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete namespace <span style=color:#e6db74>${</span>NAMESPACE<span style=color:#e6db74>}</span></span></span></code></pre></div></div></figure><h1 id=終わりに>終わりに<a hidden class=anchor aria-hidden=true href=#終わりに>#</a></h1><p>今回はさまざまなAWSサービスをAmazon Elastic Kubernetes Service(EKS)上で管理できるようにするAWS Controllers for Kubernetesのご紹介でしたがいかがだったでしょうか。</p><p>現時点ではディベロッパープレビュー機能のためプロダクション用途での活用はまだまだオススメできませんが、もしAWS Controllers for Kubernetesの活用を検討されている方は参考にしていただければ幸いです。</p><p>以上、さまざまなAWSサービスをKubernetesから管理できるようにする「AWS Controllers for Kubernetes」のご紹介でした。</p><hr><ul><li>AWS は、米国その他の諸国における Amazon.com, Inc. またはその関連会社の商標です。</li><li>Kubernetes は、The Linux Foundation の米国およびその他の国における登録商標または商標です。</li><li>その他、本資料に記述してある会社名、製品名は、各社の登録商品または商標です。</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://chacco38.github.io/tags/aws/>AWS</a></li><li><a href=https://chacco38.github.io/tags/amazon-eks/>Amazon EKS</a></li><li><a href=https://chacco38.github.io/tags/kubernetes/>Kubernetes</a></li><li><a href=https://chacco38.github.io/tags/amazon-s3/>Amazon S3</a></li><li><a href=https://chacco38.github.io/tags/amazon-ecr/>Amazon ECR</a></li></ul><nav class=paginav><a class=next href=https://chacco38.github.io/posts/2022/02/gcp-deploy-asm-with-terraform/><span class=title>Next Page »</span><br><span>Terraformを使ってGKE+ASMのマルチクラスタメッシュ環境を構築してみた</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share AWS Controllers for Kubernetesを使って各種AWSサービスをマニフェストファイルで管理しよう on twitter" href="https://twitter.com/intent/tweet/?text=AWS%20Controllers%20for%20Kubernetes%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e5%90%84%e7%a8%aeAWS%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e3%82%92%e3%83%9e%e3%83%8b%e3%83%95%e3%82%a7%e3%82%b9%e3%83%88%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%a7%e7%ae%a1%e7%90%86%e3%81%97%e3%82%88%e3%81%86&url=https%3a%2f%2fchacco38.github.io%2fposts%2f2022%2f02%2faws-controllers-for-kubernetes%2f&hashtags=AWS%2cAmazonEKS%2cKubernetes%2cAmazonS3%2cAmazonECR"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share AWS Controllers for Kubernetesを使って各種AWSサービスをマニフェストファイルで管理しよう on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fchacco38.github.io%2fposts%2f2022%2f02%2faws-controllers-for-kubernetes%2f&title=AWS%20Controllers%20for%20Kubernetes%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e5%90%84%e7%a8%aeAWS%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e3%82%92%e3%83%9e%e3%83%8b%e3%83%95%e3%82%a7%e3%82%b9%e3%83%88%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%a7%e7%ae%a1%e7%90%86%e3%81%97%e3%82%88%e3%81%86&summary=AWS%20Controllers%20for%20Kubernetes%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e5%90%84%e7%a8%aeAWS%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e3%82%92%e3%83%9e%e3%83%8b%e3%83%95%e3%82%a7%e3%82%b9%e3%83%88%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%a7%e7%ae%a1%e7%90%86%e3%81%97%e3%82%88%e3%81%86&source=https%3a%2f%2fchacco38.github.io%2fposts%2f2022%2f02%2faws-controllers-for-kubernetes%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share AWS Controllers for Kubernetesを使って各種AWSサービスをマニフェストファイルで管理しよう on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fchacco38.github.io%2fposts%2f2022%2f02%2faws-controllers-for-kubernetes%2f&title=AWS%20Controllers%20for%20Kubernetes%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e5%90%84%e7%a8%aeAWS%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e3%82%92%e3%83%9e%e3%83%8b%e3%83%95%e3%82%a7%e3%82%b9%e3%83%88%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%a7%e7%ae%a1%e7%90%86%e3%81%97%e3%82%88%e3%81%86"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share AWS Controllers for Kubernetesを使って各種AWSサービスをマニフェストファイルで管理しよう on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fchacco38.github.io%2fposts%2f2022%2f02%2faws-controllers-for-kubernetes%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share AWS Controllers for Kubernetesを使って各種AWSサービスをマニフェストファイルで管理しよう on whatsapp" href="https://api.whatsapp.com/send?text=AWS%20Controllers%20for%20Kubernetes%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e5%90%84%e7%a8%aeAWS%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e3%82%92%e3%83%9e%e3%83%8b%e3%83%95%e3%82%a7%e3%82%b9%e3%83%88%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%a7%e7%ae%a1%e7%90%86%e3%81%97%e3%82%88%e3%81%86%20-%20https%3a%2f%2fchacco38.github.io%2fposts%2f2022%2f02%2faws-controllers-for-kubernetes%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share AWS Controllers for Kubernetesを使って各種AWSサービスをマニフェストファイルで管理しよう on telegram" href="https://telegram.me/share/url?text=AWS%20Controllers%20for%20Kubernetes%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%e5%90%84%e7%a8%aeAWS%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e3%82%92%e3%83%9e%e3%83%8b%e3%83%95%e3%82%a7%e3%82%b9%e3%83%88%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%a7%e7%ae%a1%e7%90%86%e3%81%97%e3%82%88%e3%81%86&url=https%3a%2f%2fchacco38.github.io%2fposts%2f2022%2f02%2faws-controllers-for-kubernetes%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>© 2022 Satoshi Matsuzawa</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>